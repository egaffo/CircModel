---
title: "Evaluate benchmark results"
author: "Enrico Gaffo"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
params:
  output_dir: "MS_evaluations"
  simulated_datasets_qs: "MS_prep_ds/datasetList.qs"
  sumBench_perf_metrics_qs: "MS_performance/sumBench_perf_metrics.qs"
  sice: FALSE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedBenchmark)

library(data.table)
library(qs)
library(DT)
library(ComplexHeatmap)
library(scales)
library(ggplot2)

library(ggrepel)

library(BiocParallel)

library(ROCR)
```

```{r}
## output file path
output_dir <- params$output_dir #"evaluations"
dir.create(path = output_dir, showWarnings = F, recursive = T)

## input data
simulated_datasets_qs <- params$simulated_datasets_qs #"preprocessed_datasets/datasetList.qs"
sumBench_perf_metrics_qs <- params$sumBench_perf_metrics_qs #"benchmark_results/sumBench_perf_metrics.qs"
```

```{r}
nWorkers <- multicoreWorkers() # 24
alpha_targets <- c(0.01, 0.05, 0.1) 
```

```{r}
## auxiliary functions

simple_auc <- function(TPR, FPR){
    # inputs already sorted, best scores first 
    dFPR <- c(diff(FPR), 0)
    dTPR <- c(diff(TPR), 0)
    sum(TPR * dFPR) + sum(dTPR * dFPR)/2
}

## can be used to compute F1 and other F-scores, such as F0.5 (beta = 0.5)
f.beta <- function(P, R, beta = 1) {
    (1 + beta^2) * ( (P * R) / ( (beta^2 * P) + R) )
}

## compute F1 score from precision and recall
f1 <- function(P, R) {
    # 2 * ((P * R)/(P + R))
    f.beta(P, R, beta = 1)
}

## return the precision given the recall and F1-score
## Set perc.scale = T if the recall and F1 are given as percentages
prec.from.f1.score <- function(recall, f1, perc.scale = F){
    x <- (f1 * recall) / (2 * recall - f1)
    ylimit <- 1
    if(perc.scale){
        ylimit <- 100  
    }
    ifelse(x >= 0 & x <= ylimit, x, NA)
}
```

# Simulated data sets  {.tabset} 

```{r read_sumbench_objs}
## read input: the list of the SummarizedBenchmark objects after the performance evaluation 
sbL_all <- qread(file = sumBench_perf_metrics_qs, 
                 nthreads = multicoreWorkers())
```

```{r read_sim_datasets}
## read input: the simulated dataset list
sim_ds_list <- qread(file = simulated_datasets_qs, 
                     nthreads = multicoreWorkers())
sim_ds_list <- sim_ds_list[which(grepl("bulk", names(sim_ds_list)))]
```

## Raw expression

```{r}
sim_ds_avgbjr <- 
  rbindlist(lapply(sim_ds_list, 
                   function(x) data.frame(circ_id = rownames(x$cntdat), 
                                          AvgBJR = rowMeans(x$cntdat))), 
            use.names = T, idcol = "dataset")

sim_ds_avgbjr[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(dataset, "_", type.convert = F)]
```

```{r, fig.height=7}
ggplot(sim_ds_avgbjr, 
       aes(x = ID, y = AvgBJR)) +
  geom_violin(draw_quantiles = c(.25, .5, .75)) +
  scale_y_log10() +
  facet_grid(#cols = vars(MZP),
             rows = vars(paste(Purpose, SetSize))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

## Fraction of zeros per circRNA

```{r}
sim_ds_fraczeros <- 
  rbindlist(lapply(sim_ds_list, 
                   function(x) data.frame(circ_id = rownames(x$cntdat), 
                                          FracZeros = rowSums(x$cntdat == 0) / ncol(x$cntdat))), 
            use.names = T, idcol = "dataset")

sim_ds_fraczeros[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(dataset, "_", type.convert = F)]
```

```{r, fig.height=7}
ggplot(sim_ds_fraczeros, 
       aes(x = ID, y = FracZeros)) +
  geom_boxplot(outlier.size = .5, varwidth = F, notch = F) +
  facet_grid(#cols = vars(MZP),
             rows = vars(paste(Purpose, SetSize))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

# Type I error (mock data set)

```{r}
sbL <- sbL_all[grepl("_mock", names(sbL_all))]
```

<!-- ## Performance {.tabset} -->

```{r}
## FPR = 1 - TNR
sbAssayL <- 
  rbindlist(lapply(sbL, 
                   function(x){
                     data.table(as.data.frame(colData(x)), 
                                keep.rownames = "Method")
                     }), 
            idcol = "Dataset")

sbAssayL[, c("SetSize", "MZP", "DsType", "DsId") := tstrsplit(Dataset, "_")]

# setnafill(x = sbAssayL, 
#           type = "const", 
#           fill = 0, 
#           nan = NA, 
#           cols = grep("TNR", colnames(sbAssayL), value = T))
```

```{r}
value_cols <- 
  c(grep("rejections", colnames(sbAssayL), value = T),
    # grep("TPR", colnames(sbAssayL), value = T),
    # grep("FDR", colnames(sbAssayL), value = T),
    grep("TNR", colnames(sbAssayL), value = T))

mSbAssayL <- 
  sbAssayL[, lapply(.SD, mean, na.rm = T), 
           .SDcols = value_cols,
           by = .(SetSize, MZP, DsType, Method)]
```

```{r}
show_dt <- copy(mSbAssayL)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$MZP <- factor(show_dt$MZP)
show_dt$DsType <- factor(show_dt$DsType)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 3)
```

## FPR {.tabset}

Fraction of circRNAs with P-value below the thresholds (0.01, or 0.05, or 0.10)  
N.B: y-axis are square-root transformed for increased visibility  

### Average dot-line plot

```{r}
plot_dt <- melt(mSbAssayL, id.vars = c("SetSize", "MZP", "DsType", "Method"))
```

```{r}
pval_tnr_pattern <- "^TNR.[0-9]$"
padj_tnr_pattern <- "^TNR.[0-9].[0-9]$"
tnr_pattern <- pval_tnr_pattern #padj_tnr_pattern
Alpha_plot_label <- "\U003B1" #"P-value \U2264"
if(tnr_pattern == padj_tnr_pattern){
  Alpha_plot_label <- "P-adj \U2264"
}
```

```{r, fig.width=14.5, fig.height=5.5}
## Avg FPR = 1 - TNR
ggplot(plot_dt[grepl(tnr_pattern, variable)], 
       aes(x = Method, y = 1 - value)) + ## square-root transformed y-axis for increased visibility
  geom_hline(yintercept = 0.01, color = "grey30", linetype = "dashed") +
  geom_hline(yintercept = 0.05, color = "grey30", linetype = "dashed") +
  geom_hline(yintercept = 0.10, color = "grey30", linetype = "dashed") +
  geom_line(aes(group = variable, color = variable)) +
  geom_point(aes(shape = variable, color = variable)) +
  labs(y = "FPR (average fraction of circRNAs with P \U2264 \U003B1)", x = NULL) +
  scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  facet_grid(cols = vars(SetSize), 
             scales = "free_y") +
  # coord_cartesian(ylim = c(0, 1)) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top")
```

### Boxplot SetSize x Alpha

```{r, fig.width=14.5, fig.height=8.5}
idvars <- c("SetSize", "MZP", "DsType", "Method")
plot_dt <- melt(sbAssayL[, c(idvars, 
                             grep(tnr_pattern, 
                                  colnames(sbAssayL), 
                                  value = T)), with = F], 
                id.vars = idvars)

tnr2alpa <- data.frame(Alpha = c(TNR.1 = 0.01, 
                                 TNR.2 = 0.05, 
                                 TNR.3 = 0.10))
plot_dt$Alpha <- tnr2alpa[plot_dt$variable, ]

ggplot(plot_dt, aes(x = Method, 
                    y = 1 - value, 
                    color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), with = F]), 
             aes(yintercept = Alpha), 
             linetype = "dashed") +
  geom_boxplot(outlier.shape = NA, varwidth = T) +
  geom_jitter(width = .1, size = .6) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 \U003B1)", x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
  # coord_cartesian(ylim = c(0, 1)) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())
```

### Boxplot Alpha = 0.05

```{r, fig.width=14, fig.height=5}
ggplot(plot_dt[Alpha == 0.05], 
       aes(x = Method, 
           y = 1 - value, 
           color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), with = F])[Alpha == 0.05], 
             aes(yintercept = Alpha), 
             linetype = "dashed") +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .1, size = .6) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 0.05)", x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  facet_grid(cols = vars(SetSize), 
             # rows = vars(Alpha), 
             scales = "free_y", 
             drop = T) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())
```

### Alpha = 0.05, set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_dt[Alpha == 0.05 & SetSize == "N05"], 
       aes(x = Method, 
           y = 1 - value, 
           color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), 
                                   with = F])[Alpha == 0.05 & SetSize == "N05"], 
             aes(yintercept = Alpha), 
             linetype = "dashed") +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .1, size = .6) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 0.05)", x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())
```

### Vert Alpha = 0.05, set size = N05

```{r, fig.height=7, fig.width=5}
ggplot(plot_dt[Alpha == 0.05 & SetSize == "N05"], 
       aes(x = Method, 
           y = 1 - value, 
           color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), 
                                   with = F])[Alpha == 0.05 & SetSize == "N05"], 
             aes(yintercept = Alpha), 
             linetype = "dashed") +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .1, size = .6) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 0.05)", 
       # title = "5 samples per group", 
       x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_x_discrete(limits = rev) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())
```

## Characteristics of FP {.tabset}

### Signal-to-noise

(mean(DECs) - mean(notDECs)) / (sd(DECs) + sd(notDECs))  
A positive statistic indicates that the corresponding characteristic is more pronounced in the set if circRNAs called significant. 
The statistics are computed only for the methods calling >= 5 DECs.  

```{r}
## get expression matrices of each dataset
## compute statistics: CV(CPM), fraction of zeros, log2(average CPM), log2(variance(CPM))
# x <- sbL$N05_bulk_mock_01

get_signal_to_noise <- function(x) {
    
    mat <- x@BenchDesign@data@data$cntdat
    
    cpms <- edgeR::cpm(mat, lib.size = colSums(mat) * edgeR::calcNormFactors(mat))
    
    stats_dt <- 
        data.table(gene_id = rownames(cpms), 
                   fraczeros = apply(mat, 1, function(x) mean(x == 0)),
                   avecpm = apply(cpms, 1, mean), 
                   varcpm = apply(cpms, 1, var),
                   cvcpm = apply(cpms, 1, sd) / apply(cpms, 1, mean))
    
    ## get DE of each method
    alpha_thr <- 0.05
    
    adj_pv <- assays(x)[["adj_pv"]]
    rownames(adj_pv) <- rownames(mat)
    
    meth_stats_dt <- 
        merge(melt(data.table(adj_pv, keep.rownames = "gene_id"), 
                   id.vars = "gene_id",
                   value.name = "padj", 
                   variable.name = "Method")[, is_de := padj <= alpha_thr],
              stats_dt, by = "gene_id")
    
    ## use only methods that detected >= 5 DECs
    methods <- as.character(meth_stats_dt[is_de == T, .N, by = .(Method)][N >= 5, Method])
    
    if(length(methods) > 0){
        ## signal-to-noise statistic
        # (mean(DECs) - mean(notDECs)) / (sd(DECs) + sd(notDECs))
        
        dcast(dcast(melt(meth_stats_dt[Method %in% methods, 
                                       .(`M_Fraction zeros` = mean(fraczeros),
                                         # `M_log2(average CPM)` = log2(mean(avecpm)),
                                         # `M_log2(variance CPM)` = log2(mean(varcpm)),
                                         `M_average CPM` = mean(avecpm),
                                         `M_variance CPM` = mean(varcpm),
                                         `M_CV(CPM)` = mean(cvcpm),
                                         `SD_Fraction zeros` = sd(fraczeros),
                                         # `SD_log2(average CPM)` = log2(sd(avecpm)),
                                         # `SD_log2(variance CPM)` = log2(sd(varcpm)),
                                         `SD_average CPM` = sd(avecpm),
                                         `SD_variance CPM` = sd(varcpm),
                                         `SD_CV(CPM)` = sd(cvcpm)),
                                       by = .(Method, is_de)], 
                         id.vars = c("Method", "is_de"), 
                         value.name = "Stat_val",
                         variable.name = "Stat"), 
                    formula = Method + Stat ~ is_de, 
                    value.var = "Stat_val")[, c("Stat", "Val") := tstrsplit(Stat, "_")], 
              Method + Val ~ Stat, 
              value.var = c("FALSE", "TRUE"))[, .(StN = (TRUE_M - FALSE_M) / (TRUE_SD + FALSE_SD)), 
                                              by = .(Method, Val)]
    }
}
```

```{r}
stn_dt <- rbindlist(lapply(sbL, get_signal_to_noise), idcol = "setID")
stn_dt[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(setID, "_")]
```

```{r}
plot_dt <- copy(stn_dt)
plot_dt$Method <- as.character(plot_dt$Method)
plot_dt$Val <- factor(plot_dt$Val, 
                      levels = c("CV(CPM)", "Fraction zeros", 
                                 "average CPM", "variance CPM"), 
                      ordered = T)
```

```{r, fig.height=7, fig.width=7}
n_points <- plot_dt[, .N, by = .(Method, Val)]
# n_points[, y := ifelse(Val %in% c("CV(CPM)", "Fraction zeros"), 2.2, -2.2)]
n_points[, y := 2.2]

ggplot(plot_dt, 
       aes(x = Method, y = StN)) +
    # geom_hline(yintercept = 2, linetype = "dashed") +
    # geom_hline(yintercept = 2.8, linetype = "dashed") +
    geom_text(data = n_points, 
              aes(y = y, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
              angle = 90, hjust = 0, vjust = .5, 
              fontface = "italic", size = 3) +
    geom_text(data = n_points, 
              aes(y = y+1, label = "")) +
    geom_hline(yintercept = 0) +
    geom_boxplot(aes(color = Method), outlier.shape = NA, varwidth = F) +
    geom_jitter(aes(color = Method), size = .7, width = .1) +
    facet_wrap(~ Val) + #, scales = "free_y"
    ylab("Signal-to-noise statistics (DECs/notDECs)") +
    scale_color_discrete(guide = "none") +
    # coord_cartesian(ylim = c(-2.5, 2.5)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top", 
          panel.grid.major.x = element_blank(), 
          panel.grid.minor.x = element_blank())
```

### Vert Signal-to-noise

```{r, fig.height=11, fig.width=7}
ggplot(plot_dt, 
       aes(x = Method, y = StN)) +
    geom_hline(yintercept = 0) +
    geom_boxplot(aes(color = Method), outlier.shape = NA, varwidth = F) +
    geom_jitter(aes(color = Method), size = .7, width = .1) +
    facet_grid(cols = vars(Val), rows = vars(SetSize)) +
    ylab("Signal-to-noise statistics (DECs/notDECs)") +
    scale_color_discrete(guide = "none") +
    coord_flip() +
    scale_x_discrete(limits = rev) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top", 
          panel.grid.major.y = element_blank(), 
          panel.grid.minor.y = element_blank())
```

```{r}
## save signal-to-noise statistics
signal2noise_file <- file.path(output_dir, "signal2noise.csv")
fwrite(x = stn_dt, file = signal2noise_file, quote = F, row.names = F, col.names = T)
```

The signal-to-noise statistics have been saved into <a href="`r signal2noise_file`">`r signal2noise_file`</a>.  

# DE data sets

```{r}
sbL <- sbL_all[grepl("_de", names(sbL_all))]
```

<!-- ## Method prediction overlap {.tabset} -->

```{r}
# cmL <- lapply(sbL,  
#               function(x, alpha_thr = 0.1) {
#                   
#                   pv_mat <- assays(x)[["adj_pv"]] <= alpha_thr
#                   pv_mat[is.na(pv_mat)] <- F
#                   
#                   cm <- ComplexHeatmap::make_comb_mat(pv_mat, min_set_size = 0)
#                   
#                   list(overlap_frac = ComplexHeatmap::comb_size(cm) / nrow(assays(x)[["adj_pv"]]),
#                        cm = cm,
#                        set_names = ComplexHeatmap::set_name(cm))
#               },
#               alpha_thr = 0.1
# )
# 
# set_names <- 
#   dcast(rbindlist(lapply(cmL, function(x) {data.table(Method = x$set_names,
#                                                       ID = seq_along(x$set_names))}),
#                   idcol = "DS"),
#         DS ~ ID,
#         value.var = "Method")
# 
# ## check methods order in combinations is always the same
# # nrow(unique(data.frame(set_names, row.names = "DS"))) == 1
# 
# ovlp_frac <- 
#   rbindlist(lapply(cmL, function(x) {data.table(OvlpFrac = x$overlap_frac,
#                                                 Comb = names(x$overlap_frac))}),
#             idcol = "DS")
# ovlp_frac[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(DS, "_", type.convert = F), 
#               by = DS]
# 
# 
# mean_ovlp_frac <- ovlp_frac[, .(AvgOvlpFrac = mean(OvlpFrac)), 
#                             by = .(SetSize, MZP, Purpose, Comb)][order(SetSize, MZP, Purpose, -AvgOvlpFrac)]
# 
# mean_ovlp_frac[, Comb_degree := sum(as.integer(unlist(strsplit(Comb, "")))), by = Comb]
```

```{r}
# # null_comb <- paste0(rep("0", length(set_names) - 1), collapse = "")
# 
# ## top bar annotation data
# # selected_comb_sizes_dt <- mean_ovlp_frac[Comb_degree > 1, 
# #                                          .(SetSize, MZP, Purpose, Comb, 
# #                                            AvgOvlpFrac)][order(-AvgOvlpFrac)][1:15, ]
# selected_comb_sizes_dt <- 
#   mean_ovlp_frac[Comb_degree > 1][order(SetSize, MZP, Purpose, -AvgOvlpFrac), 
#                                   lapply(.SD, head, 15),
#                                   by = .(SetSize, MZP, Purpose),
#                                   .SDcols = c("SetSize", "MZP", "Purpose", "Comb", 
#                                               "AvgOvlpFrac")]
# 
# ## row annotation data
# setSize <- 
#   rbindlist(lapply(cmL, function(x) {
#     data.table(Method = names(ComplexHeatmap::set_size(x$cm)),
#                setSize = ComplexHeatmap::set_size(x$cm),
#                setSize_frac = ComplexHeatmap::set_size(x$cm) / (ComplexHeatmap::comb_size(x$cm)[1] / x$overlap_frac[1]))
#   }),
#   idcol = "DS")
# setSize[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(DS, "_", type.convert = F)]
# 
# mean_setSize <- 
#   setSize[, .(AvgsetSize_frac = mean(setSize_frac)), 
#           by = .(SetSize, MZP, Purpose, Method)][order(SetSize, MZP, Purpose, -AvgsetSize_frac)]
```

```{r upset_plot}
# plot_common_pred_upset <- function(setsize, mzp, purpose, 
#                                    selected_comb_sizes_dt, mean_setSize, 
#                                    ovlp_frac, setSize) {
#   selected_comb_sizes <- setNames(selected_comb_sizes_dt[SetSize == setsize & 
#                                                            MZP == mzp & 
#                                                            Purpose == purpose, 
#                                                          AvgOvlpFrac], 
#                                   nm = selected_comb_sizes_dt[SetSize == setsize & 
#                                                                 MZP == mzp & 
#                                                                 Purpose == purpose, 
#                                                               Comb])
#   
#   mt <- as.matrix(sapply(names(selected_comb_sizes), 
#                          function(x) as.integer(unlist(strsplit(x, "")))))
#   rownames(mt) <- set_names[1, 2:length(set_names)]
#   
#   cmt <- ComplexHeatmap::make_comb_mat(t(mt), min_set_size = 0)
#   
#   top_boxplot_mat <- 
#     as.matrix(data.frame(dcast(ovlp_frac[Comb %in% ComplexHeatmap::comb_name(cmt) &
#                                            SetSize == setsize & 
#                                            MZP == mzp & 
#                                            Purpose == purpose], 
#                                DS ~ Comb, 
#                                value.var = "OvlpFrac"), 
#                          row.names = "DS", 
#                          check.names = F)) * 100
#   
#   top_anno <- 
#     HeatmapAnnotation("Common\npredictions\n(%)" = anno_boxplot(top_boxplot_mat[, comb_name(cmt)]),
#       annotation_name_side = "left", 
#       annotation_name_rot = 0)
#   
#   ## row annotation
#   mean_set_size <- setNames(mean_setSize[SetSize == setsize & 
#                                            MZP == mzp & 
#                                            Purpose == purpose, 
#                                          AvgsetSize_frac], 
#                             nm = mean_setSize[SetSize == setsize & 
#                                                 MZP == mzp & 
#                                                 Purpose == purpose, 
#                                               Method])
#   
#   row_boxplot_mat <- 
#     as.matrix(data.frame(dcast(setSize[SetSize == setsize & 
#                                          MZP == mzp & 
#                                          Purpose == purpose], 
#                                DS ~ Method, 
#                                value.var = "setSize_frac"), 
#                          row.names = "DS", 
#                          check.names = F)) * 100
#   
#   row_anno <- 
#     rowAnnotation("Predicted\nDECs (%)" = anno_boxplot(t(row_boxplot_mat[, set_name(cmt)]), 
#                                            axis_param = list(side = "top", 
#                                                              labels_rot = 0),
#                                            width = unit(3, "cm")),
#       annotation_name_side = "top",
#       annotation_name_rot = 0)
#   
#   ## plot Upset
#   UpSet(cmt, 
#         row_title = paste(setsize, mzp, purpose),
#         top_annotation = top_anno, 
#         right_annotation = row_anno, 
#         set_order = order(-mean_set_size[set_name(cmt)]),
#         comb_order = order(-selected_comb_sizes[comb_name(cmt)]))
# }
```

<!-- ### Bulk N03 -->

```{r, fig.height=5.5, fig.width=6.5}
# plot_common_pred_upset(setsize = "N03", mzp = "bulk", purpose = "de", ## N03_bulk_de
#                        selected_comb_sizes_dt, mean_setSize,
#                        ovlp_frac, setSize)
```

<!-- ### Bulk N05 -->

```{r, fig.height=5.5, fig.width=6.5}
# plot_common_pred_upset(setsize = "N05", mzp = "bulk", purpose = "de", ## N05_bulk_de
#                        selected_comb_sizes_dt, mean_setSize,
#                        ovlp_frac, setSize)
```

<!-- ### Bulk N10 -->

```{r, fig.height=5.5, fig.width=6.5}
# plot_common_pred_upset(setsize = "N10", mzp = "bulk", purpose = "de", ## N10_bulk_de
#                        selected_comb_sizes_dt, mean_setSize,
#                        ovlp_frac, setSize)
```


```{r}
# library(ggplot2)
# library(ComplexUpset)
# https://cran.r-project.org/web/packages/ComplexUpset/vignettes/Examples_R.html
```

<!-- ## Performance {.tabset} -->

```{r}
sbAssayL <- 
  rbindlist(lapply(sbL, 
                   function(x){
                     data.table(as.data.frame(colData(x)), 
                                keep.rownames = "Method")
                     }), 
            idcol = "Dataset")

sbAssayL[, c("SetSize", "MZP", "DsType", "DsId") := tstrsplit(Dataset, "_"), 
         by = Dataset]

# setnafill(x = sbAssayL, 
#           type = "const", 
#           fill = 1, 
#           nan = NA, 
#           cols = grep("FDR", colnames(sbAssayL), value = T))
```

```{r}
value_cols <- 
  c(grep("rejections", colnames(sbAssayL), value = T),
    grep("TPR", colnames(sbAssayL), value = T),
    grep("TNR", colnames(sbAssayL), value = T),
    grep("FDR", colnames(sbAssayL), value = T))

mSbAssayL <- 
  sbAssayL[, lapply(.SD, mean, na.rm = T), 
           .SDcols = value_cols,
           by = .(SetSize, MZP, DsType, Method)]

notNAnumSbAssayL <- 
  sbAssayL[, lapply(.SD, function(x){sum(!is.na(x))}), 
           .SDcols = value_cols,
           by = .(SetSize, MZP, DsType, Method)]
```

```{r}
show_dt <- copy(mSbAssayL)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$MZP <- factor(show_dt$MZP)
show_dt$DsType <- factor(show_dt$DsType)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 3)
```

Number of successful runs:  

```{r}
show_dt <- copy(notNAnumSbAssayL)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$MZP <- factor(show_dt$MZP)
show_dt$DsType <- factor(show_dt$DsType)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 0)
```

```{r}
plot_dt <- melt(mSbAssayL, id.vars = c("SetSize", "MZP", "DsType", "Method"))
```

## Recall (TPR) {.tabset}

```{r}
# pval_tpr_pattern <- "^TPR.[0-9]$"
padj_tpr_pattern <- "^TPR.[0-9].[0-9]$"
tpr_pattern <- padj_tpr_pattern #pval_tpr_pattern
Alpha_plot_label <- "P-value \U2264"
if(tpr_pattern == padj_tpr_pattern){
  Alpha_plot_label <- "Adjusted P \U2264"
}
```

### Average point-line plot

```{r, fig.width=14.5, fig.height=5.5}
## Avg TPR
ggplot(plot_dt[grep(tpr_pattern, variable)], ## get P-values TPRs
       aes(x = Method, y = value)) +
  geom_line(aes(group = variable, color = variable)) +
  geom_point(aes(shape = variable, color = variable)) +
  labs(y = "Average TPR at adjusted P", x = NULL) +
  scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  facet_grid(cols = vars(SetSize),
             scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top")
```

### Boxplot SetSize x Alpha

```{r}
idvars <- c("Dataset", "Method", "SetSize", "MZP", "DsType")

plot_bx_dt <- melt(sbAssayL[, c(idvars,
                                grep(tpr_pattern, colnames(sbAssayL), value = T)), 
                            with = F], 
                   id.vars = idvars)
## NB: we exploit here the partial matching of rownames, tnr2alpa 
#       Alpha
# TNR.1  0.01
# TNR.2  0.05
# TNR.3  0.10
plot_bx_dt$Alpha <- tnr2alpa[plot_bx_dt$variable, ]

# plot_bx_dt[!is.na(value), .N, by = .(SetSize, Method, variable)]
```

```{r, fig.width=14.5, fig.height=8.5}
ggplot(plot_bx_dt, 
       aes(x = Method, y = value, color = Method)) +
    geom_boxplot(outlier.shape = NA, varwidth = T) +
    geom_jitter(width = .1, size = .6) +
    labs(y = "TPR at adjusted P cutoff", x = NULL) +
    scale_color_discrete(guide = "none") +
    facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

### Alpha = 0.05, set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_bx_dt[SetSize == "N05" & Alpha == 0.05], 
       aes(x = Method, y = value, color = Method)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = .1, size = .6) +
    labs(y = "TPR at adjusted P = 0.05", 
         # title = "5 samples per group",
         x = NULL) +
    scale_color_discrete(guide = "none") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

## Precision (1-FDR) {.tabset}

```{r}
pval_fdr_pattern <- "^FDR.[0-9]$"
padj_fdr_pattern <- "^FDR.[0-9].[0-9]$"
fdr_pattern <- padj_fdr_pattern #pval_fdr_pattern
Alpha_plot_label <- "P-value \U2264"
if(fdr_pattern == padj_fdr_pattern){
  Alpha_plot_label <- "Adjusted P \U2264"
}
```

### Average point-line plot

```{r, fig.width=14.5, fig.height=5.5}
## Avg Precision
ggplot(plot_dt[grep(fdr_pattern, variable)][is.na(value), value := 1], 
       aes(x = Method, y = 1 - value)) +
  geom_line(aes(group = variable, color = variable)) +
  geom_point(aes(shape = variable, color = variable)) +
  labs(y = "Average precision (PPV)", x = NULL) +
  scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  facet_grid(cols = vars(SetSize), 
             # rows = vars(MZP), 
             scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top")
```

### Boxplot SetSize x Alpha

```{r}
idvars <- c("Dataset", "Method", "SetSize", "MZP", "DsType")

plot_bx_dt <- melt(sbAssayL[, c(idvars,
                                grep(padj_fdr_pattern, colnames(sbAssayL), value = T)), 
                            with = F], 
                   id.vars = idvars)

fdr2alpha <- data.frame(Alpha = c(FDR.1.1 = 0.01, FDR.2.1 = 0.05, FDR.3.1 = 0.10))
plot_bx_dt$Alpha <- fdr2alpha[plot_bx_dt$variable, ]

n_plot_bx_dt <- plot_bx_dt[!is.na(value), .N, by = .(SetSize, Method, Alpha)]
n_plot_bx_dt[, y := 1.1]
```

```{r, fig.width=14.5, fig.height=8.5}
# ggplot(plot_bx_dt[][is.na(value), value := 1], 
ggplot(plot_bx_dt, 
       aes(x = Method, y = 1 - value, color = Method)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = .1, size = .6) +
    labs(y = "PPV at adjusted P", x = NULL) +
    scale_color_discrete(guide = "none") +
    facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

### Alpha = 0.05, set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_bx_dt[SetSize == "N05" & Alpha == 0.05], 
       aes(x = Method, y = 1 - value, color = Method)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = .1, size = .6) +
    geom_text(data = n_plot_bx_dt[SetSize == "N05" & Alpha == 0.05], 
              aes(y = 1.25, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
              angle = 90, hjust = "inward", vjust = .5, 
              fontface = "italic", size = 3, color = "black") +
    # geom_text(data = n_plot_bx_dt[SetSize == "N05" & Alpha == 0.05],
    #           aes(y = y+.1, label = "")) +
    labs(y = "PPV at adjusted P = 0.05",
         # title = "5 samples per group", 
         x = NULL) +
    scale_color_discrete(guide = "none") +
    scale_y_continuous(breaks = c(.05, .25, .5, .75, 1), limits = c(0, 1.25)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top", 
          panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())
```

## FDR {.tabset}

```{r}
idvars <- c("Dataset", "Method", "SetSize", "MZP", "DsType")

plot_bx_dt <- melt(sbAssayL[, c(idvars,
                                grep(padj_fdr_pattern, colnames(sbAssayL), value = T)), 
                            with = F], 
                   id.vars = idvars)

fdr2alpha <- data.frame(Alpha = c(FDR.1.1 = 0.01, FDR.2.1 = 0.05, FDR.3.1 = 0.10))
plot_bx_dt$Alpha <- fdr2alpha[plot_bx_dt$variable, ]

n_plot_bx_dt <- plot_bx_dt[!is.na(value), .N, by = .(SetSize, Method, Alpha)]
n_plot_bx_dt[, y := 1.1]
```

### Average point-line plot

```{r, fig.width=14.5, fig.height=5.5}
ggplot(plot_bx_dt, 
       aes(x = Method, y = value, color = Method)) +
    geom_hline(data = plot_bx_dt[, .N, by = .(SetSize, Alpha)],
               aes(yintercept = Alpha), 
               linetype = "dashed") +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = .1, size = .6) +
    labs(y = "FDP at adjusted P", x = NULL) +
    scale_color_discrete(guide = "none") +
    facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

### Alpha = 0.05, set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_bx_dt[SetSize == "N05" & Alpha == 0.05], 
       aes(x = Method, y = value, color = Method)) +
    geom_hline(yintercept = .05, linetype = "dashed") +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = .1, size = .6) +
    geom_text(data = n_plot_bx_dt[SetSize == "N05" & Alpha == 0.05], 
              aes(y = 1.25, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
              angle = 90, hjust = "inward", vjust = .5, 
              fontface = "italic", size = 3, color = "black") +
    # geom_text(data = n_plot_bx_dt[SetSize == "N05" & Alpha == 0.05],
    #           aes(y = y+.1, label = "")) +
    labs(y = "FDP at adjusted P = 0.05",
         # title = "5 samples per group", 
         x = NULL) +
    scale_color_discrete(guide = "none") +
    scale_y_continuous(breaks = c(.05, .25, .5, .75, 1), limits = c(0, 1.25)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top", 
          panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())
```

## F-scores

```{r, fig.width=10}
## F1-score
ds_id_cols <- c("SetSize", "MZP", "DsType", "Method", "DsId", "Dataset")

f1s <- 
  merge(melt(sbAssayL[, c(ds_id_cols,
                          grep(fdr_pattern, colnames(sbAssayL), value = T)), with = F], 
             id.vars = ds_id_cols, 
             value.name = "FDR",
             variable.name =  "Alpha")[, Alpha := sub("FDR.", "", Alpha)][],
        melt(sbAssayL[, c(ds_id_cols,
                          grep(tpr_pattern, colnames(sbAssayL), value = T)), with = F], 
             id.vars = ds_id_cols, 
             value.name = "TPR",
             variable.name = "Alpha")[, Alpha := sub("TPR.", "", Alpha)][],
        by = c(ds_id_cols, "Alpha"))

f1s[, `:=`(F1 = f1(1 - FDR, TPR),
           F0.5 = f.beta(1 - FDR, TPR, .5))] 

## add the number of rejections
# rej_pattern <- "^rejections.[0-9]$" #P-vals
rej_pattern <- "^rejections.[0-9].[0-9]$" #Padj

f1s <- 
  merge(f1s, 
        melt(sbAssayL[, c(ds_id_cols,
                          grep(rej_pattern, colnames(sbAssayL), value = T)), with = F], 
             id.vars = ds_id_cols, 
             value.name = "rejections",
             variable.name = "Alpha")[, Alpha := sub("rejections.", "", Alpha)][],
        by = c(ds_id_cols, "Alpha"))

## add the number of circRNAs in the dataaset
f1s <- 
  merge(f1s, 
        rbindlist(lapply(sim_ds_list, 
                         function(x) data.table(nCircRNAs = x$nGenes)), 
                  idcol = "Dataset"),
        by = "Dataset")

# f1s[is.nan(F1), F1 := 0]
# f1s[is.nan(F0.5), F0.5 := 0]
```

```{r}
## compute mean values
mf1s <- f1s[, .(F1 = mean(F1, na.rm = T),
                sdF1 = sd(F1, na.rm = T),
                F0.5 = mean(F0.5, na.rm = T),
                sdF0.5 = sd(F0.5, na.rm = T),
                TPR = mean(TPR, na.rm = T),
                sdTPR = sd(TPR, na.rm = T),
                FDR = mean(FDR, na.rm = T),
                sdFDR = sd(FDR, na.rm = T),
                rejections = mean(rejections, na.rm = T),
                nCircRNAs = mean(nCircRNAs, na.rm = T)), 
            by = .(SetSize, MZP, DsType, Method, Alpha)]
```

```{r}
show_dt <- copy(mf1s)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$MZP <- factor(show_dt$MZP)
show_dt$DsType <- factor(show_dt$DsType)
show_dt$Method <- factor(show_dt$Method)
show_dt$Alpha <- factor(show_dt$Alpha)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(c("F1", "sdF1", 
                "F0.5", "sdF0.5", 
                "TPR", "sdTPR", 
                "FDR", "sdFDR", 
                "rejections", "nCircRNAs"), 3)
```

### F1 {.tabset}

```{r}
f1_curves <- function(f1s = c(.5)) {
    
    lapply(f1s, 
           function(x)stat_function(fun = prec.from.f1.score,
                                    n = 1001,
                                    geom = "line", 
                                    linetype = 2,
                                    color = "grey", 
                                    show.legend = c(shape = F),
                                    xlim = c(0,  1), 
                                    args = list(f1 = x)))
}

annotate_f1_curves <- function(f1s = c(.5), 
                               vjust = .05, 
                               pos.x = 1.01) {
    
    lapply(f1s, 
           function(x, pos.x){
               y <- prec.from.f1.score(pos.x, x) + vjust
               annotate(geom = "text", 
                        x = pos.x, 
                        y = y, 
                        label = as.character(x), 
                        color = "grey55", 
                        size = 3, 
                        hjust = 1, 
                        parse = F)
           }, 
           pos.x = pos.x)
}

f1_to_draw <- c(.1, .3, .5, .7)
```

##### Average point-line plot

```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- mf1s[, c("baseMethod", "Params", "Test") := tstrsplit(Method, "_")]
plot_dt[is.na(F1), F1 := 0]
plot_dt$Method <- gsub("_", " ", plot_dt$Method)

ggplot(plot_dt, 
       aes(x = Method, y = F1)) +
    geom_line(aes(group = Alpha, color = Alpha)) +
    geom_point(aes(shape = Alpha, color = Alpha)) +
    labs(y = expression(Average~F[1]), x = NULL) +
    scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
    scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
    facet_grid(cols = vars(SetSize), 
               scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

#### Curve plots

```{r, fig.width=9, fig.height=5.5}
text2alphas <- c("1.1" = "padj < 0.01", "2.1" = "padj < 0.05", "3.1" = "padj < 0.1")
plot_dt <- mf1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt, 
       aes(x = TPR, y = 1 - FDR, color = Method, shape = as.character(Alpha))) +
  f1_curves(f1_to_draw) +
  annotate_f1_curves(f1_to_draw, pos.x = .95) +
  geom_point() +
  coord_fixed(clip = "off", xlim = c(0, 1), ylim = c(0, 1.01), expand = F) + 
  scale_shape_manual("Alpha", values = 2:4, labels = alpha_targets, guide = "none") +
  # guides(shape = guide_legend(direction = "vertical")) +
  facet_grid(cols = vars(SetSize), rows = vars(Alpha)) + 
  labs(y = "Average PPV", x = "Average TPR") +
  theme_bw() +
  theme(legend.position = "right", 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

#### F1 vs #circRNAs

```{r, fig.width=10, fig.height=7}
plot_dt <- f1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt, 
       aes(x = nCircRNAs, y = F1, 
           color = Method)) +
  geom_smooth(se = F, method = "lm", alpha = .5) +
  facet_wrap(facets = SetSize ~ Alpha, scales = "free", ncol = 3, labeller = label_wrap_gen(multi_line = F)) +
  # scale_shape_manual("Alpha", values = 2:4, labels = alpha_targets) +
  # guides(shape = guide_legend(direction = "vertical")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "right")
```

#### Boxplot SetSize x Alpha

```{r, fig.width=14.5, fig.height=8.5}
plot_dt <- f1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt, 
       aes(x = Method, y = F1, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  labs(y = expression(F[1]), x = NULL) +
  geom_jitter(width = .1, size = .6) +
  geom_text(data = plot_dt[rejections > 0, .N, by = .(SetSize, DsType, Method, Alpha)],
            aes(y = 1.2, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
              angle = 90, hjust = .85, vjust = .4, 
              fontface = "italic", size = 3, color = "black") +
  # scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_color_discrete(guide = "none") +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top")
```

#### Alpha = 0.05, set size = N05

```{r, fig.width=4, fig.height=7}
plot_dt <- f1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt[SetSize == "N05" & Alpha == "padj < 0.05"], 
       aes(x = Method, y = F1, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .2, size = .6) +
  geom_text(data = plot_dt[SetSize == "N05" & Alpha == "padj < 0.05" &
                             rejections > 0, .N, 
                           by = .(SetSize, DsType, Method, Alpha)],
            aes(y = 1.2, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
            angle = 0, hjust = .85, vjust = .4, 
            fontface = "italic", size = 3, color = "black") +
  labs(y = expression(F[1]), x = NULL) +
  # scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_color_discrete(guide = "none") +
  # facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
  coord_flip() +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.y = element_blank())
```

<!-- ##### Pointrange  -->

```{r, fig.height=12, fig.width=9}
# plot_dt <- mf1s[MZP == "bulk"][, c("baseMethod", "Params", "Test") := tstrsplit(Method, "_")]
# plot_dt[, Params_Test := paste(Params, Test)]
# plot_dt$Alpha <- text2alphas[plot_dt$Alpha]
# 
# level_order <- plot_dt[grepl("0.05", Alpha) &
#                            SetSize == "N05"][order(-F1),
#                                              .(Method),
#                                              by = baseMethod][, Method]
# 
# plot_dt$Method <-
#     factor(plot_dt$Method,
#            levels = level_order,
#            ordered = T)
# 
# ggplot(plot_dt, 
#        aes(x = Method, 
#            y = F1, 
#            color = Alpha)) +
#     geom_pointrange(aes(ymin = F1 - sdF1, ymax = F1 + sdF1),
#                     position = position_dodge(width = .7)) +
#     ylab(expression(Average~F[1])) +
#     xlab(NULL) +
#     scale_color_discrete(Alpha_plot_label, labels = alpha_targets, guide = "none") +
#     scale_x_discrete(label = function(x){
#         gsub("_", " ", gsub("[^_]+_(.*)", "\\1", x))}) +
#     coord_flip(clip = "off") +
#     facet_grid(cols = vars(Alpha, SetSize), 
#                rows = vars(baseMethod), 
#                drop = T, 
#                scales = "free", space = "free") +
#     theme_bw() +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
#           panel.spacing.y = unit(.01, "lines"),
#           legend.position = "top", 
#           panel.grid.major.y = element_blank())
```

### F0.5 {.tabset}

##### Average point-line plot

```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- mf1s[, c("baseMethod", "Params", "Test") := tstrsplit(Method, "_")]
plot_dt[is.na(F0.5), F0.5 := 0]
plot_dt$Method <- gsub("_", " ", plot_dt$Method)

ggplot(plot_dt, 
       aes(x = Method, y = F0.5)) +
    geom_line(aes(group = Alpha, color = Alpha)) +
    geom_point(aes(shape = Alpha, color = Alpha)) +
    labs(y = expression(Average~F[0.5]), x = NULL) +
    scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
    scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
    facet_grid(cols = vars(SetSize), 
               scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

#### F0.5 vs #circRNAs

```{r, fig.width=10, fig.height=7}
plot_dt <- f1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt, 
       aes(x = nCircRNAs, y = F0.5, 
           color = Method)) +
  geom_smooth(se = F, method = "lm", alpha = .5) +
  facet_wrap(facets = SetSize ~ Alpha, scales = "free", ncol = 3, labeller = label_wrap_gen(multi_line = F)) +
  # scale_shape_manual("Alpha", values = 2:4, labels = alpha_targets) +
  # guides(shape = guide_legend(direction = "vertical")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "right")
```

#### Boxplot SetSize x Alpha

```{r, fig.width=14.5, fig.height=8.5}
plot_dt <- f1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt, 
       aes(x = Method, y = F0.5, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  labs(y = expression(F[0.5]), x = NULL) +
  geom_jitter(width = .1, size = .6) +
  geom_text(data = plot_dt[rejections > 0, .N, by = .(SetSize, DsType, Method, Alpha)],
            aes(y = 1.2, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
              angle = 90, hjust = .85, vjust = .4, 
              fontface = "italic", size = 3, color = "black") +
  # scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_color_discrete(guide = "none") +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top")
```

#### Alpha = 0.05, set size = N05

```{r, fig.width=4, fig.height=7}
plot_dt <- f1s
plot_dt$Alpha <- text2alphas[plot_dt$Alpha]

ggplot(plot_dt[SetSize == "N05" & Alpha == "padj < 0.05"], 
       aes(x = Method, y = F0.5, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .2, size = .6) +
  geom_text(data = plot_dt[SetSize == "N05" & Alpha == "padj < 0.05" &
                             rejections > 0, .N, 
                           by = .(SetSize, DsType, Method, Alpha)],
            aes(y = 1.2, label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"))), 
            angle = 0, hjust = .85, vjust = .4, 
            fontface = "italic", size = 3, color = "black") +
  labs(y = expression(F[0.5]), x = NULL) +
  # scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_color_discrete(guide = "none") +
  # facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
  coord_flip() +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.y = element_blank())
```

## Save metrics

### P-values

```{r}
pval_deind_dt <- 
  rbindlist(lapply(sbL,
                   function(x) {
                     melt(data.table(true_val = as.integer(groundTruths(x)[["pv"]]),
                                     assays(x)[["pv"]]),
                          id.vars = "true_val",
                          value.name = "preds",
                          variable.name = "Method")
                   }),
            idcol = "Dataset")

# pval_deind_dt[is.na(preds), preds := 1]

pval_deind_dt[, c("SetSize", "MZP", "DsType", "DsId") := tstrsplit(Dataset, "_"), 
              by = Dataset]
```

```{r}
pval_deind_file <- file.path(output_dir, "pval_deind.csv.gz")
fwrite(pval_deind_dt, 
       pval_deind_file, 
       sep = "\t", row.names = F)
```

Performance metrics on P-values have been saved into the file <a href="`r pval_deind_file`">`r pval_deind_file`</a>.  

```{r}
eval_metrics_dt <- 
  pval_deind_dt[order(Dataset, Method, preds, 
                      decreasing = F)][, .(ID = seq_len(length(true_val)),
                                           Tot.DE = sum(true_val),
                                           Tot.NDE = sum(true_val == 0),
                                           Tot = length(true_val), 
                                           TP = cumsum(true_val),
                                           FP = cumsum(true_val == 0)), 
                                       by = .(Dataset, Method)][, `:=`(TPR = TP / Tot.DE,
                                                                       FPR = FP / Tot.NDE, # FP/(FP+TN)
                                                                       FDR = FP / Tot)] # FP/(FP+TP)),

eval_metrics_dt[, c("SetSize", "MZP", "DsType", "DsId") := tstrsplit(Dataset, "_"),
                by = Dataset]
```

```{r}
mean_eval_metrics_dt <- 
  eval_metrics_dt[, .(AvgTPR = mean(TPR),
                      AvgFPR = mean(FPR),
                      AvgFDR = mean(FDR),
                      sdTPR = sd(TPR),
                      sdFPR = sd(FPR),
                      sdFDR = sd(FDR)),
                  by = .(SetSize, MZP, DsType, Method, ID)]
```

```{r}
eval_metrics_file <- file.path(output_dir, "eval_metrics.csv.gz")
fwrite(eval_metrics_dt, 
       eval_metrics_file, 
       sep = "\t", row.names = F)
```

Mean performance metrics on P-values have been saved into the file <a href="`r eval_metrics_file`">`r eval_metrics_file`</a>.

### Adjusted P-values

```{r}
adj_pval_deind_dt <- 
  rbindlist(lapply(sbL,
                   function(x) {
                     melt(data.table(true_val = as.integer(groundTruths(x)[["adj_pv"]]),
                                     assays(x)[["adj_pv"]]),
                          id.vars = "true_val",
                          value.name = "preds",
                          variable.name = "Method")
                   }),
            idcol = "Dataset")

# adj_pval_deind_dt[is.na(preds), preds := 1]

adj_pval_deind_dt[, c("SetSize", "MZP", "DsType", "DsId") := tstrsplit(Dataset, "_"), 
                  by = Dataset]
```

```{r}
adj_pval_deind_file <- file.path(output_dir, "adj_pval_deind.csv.gz")
fwrite(adj_pval_deind_dt, 
       adj_pval_deind_file, 
       sep = "\t", row.names = F)
```

Performance metrics on the adjusted P-values have been saved into the file <a href="`r adj_pval_deind_file`">`r adj_pval_deind_file`</a>.

```{r}
adj_eval_metrics_dt <- 
  adj_pval_deind_dt[order(Dataset, Method, preds, 
                      decreasing = F)][, .(ID = seq_len(length(true_val)),
                                           Tot.DE = sum(true_val),
                                           Tot.NDE = sum(true_val == 0),
                                           Tot = length(true_val), 
                                           TP = cumsum(true_val),
                                           FP = cumsum(true_val == 0)), 
                                       by = .(Dataset, Method)][, `:=`(TPR = TP / Tot.DE,
                                                                       FPR = FP / Tot.NDE, # FP/(FP+TN)
                                                                       FDR = FP / Tot)] # FP/(FP+TP)),

adj_eval_metrics_dt[, c("SetSize", "MZP", "DsType", "DsId") := tstrsplit(Dataset, "_"), by = .(Dataset)]
```

```{r}
adj_mean_eval_metrics_dt <- 
  adj_eval_metrics_dt[, .(AvgTPR = mean(TPR),
                      AvgFPR = mean(FPR),
                      AvgFDR = mean(FDR),
                      sdTPR = sd(TPR),
                      sdFPR = sd(FPR),
                      sdFDR = sd(FDR)),
                  by = .(SetSize, MZP, DsType, Method, ID)]
```

```{r}
adj_eval_metrics_file <- file.path(output_dir, "adj_eval_metrics.csv.gz")
fwrite(adj_eval_metrics_dt, 
       adj_eval_metrics_file, 
       sep = "\t", row.names = F)
```

Mean performance metrics on the adjusted P-values have been saved into the file <a href="`r adj_eval_metrics_file`">`r adj_eval_metrics_file`</a>.

## FDR vs TPR {.tabset}

```{r}
x.breaks <- sort(c(.01, .05, seq(0, 1, by = .1)))
```

```{r}
## to compute the average PPV (or FDR) and average TPR across
## simulation replicates, see the ".combine.performance.objects"
## function of the ROCR package at
# https://github.com/ipa-tys/ROCR/blob/master/R/performance.R

# .performance.plot.threshold.avg
# https://github.com/ipa-tys/ROCR/blob/master/R/performance_plots.R

get_avg_meas <- function(y, meas.a = "tpr", meas.b = "fdr") {
  
  x.measure <- meas.b
  
  y_preds <- lapply(split(y[, .(Dataset, preds)], 
                          by = "Dataset", 
                          keep.by = F, 
                          drop = T), 
                    function(x)x$preds)
  y_labels <- lapply(split(y[, .(Dataset, true_val)], 
                           by = "Dataset", 
                           keep.by = F, 
                           drop = T), 
                     function(x)x$true_val)
  
  if(meas.b == "fdr"){
    
    y_preds <- lapply(y_preds, function(x)1 - x)
    x.measure <- "ppv"
  }
  
  rocr_pred <- ROCR::prediction(predictions = y_preds,
                                labels = y_labels)
  
  rocr_perf <- ROCR::performance(rocr_pred,
                                 measure = meas.a, 
                                 x.measure = x.measure)
  
  if(meas.b == "fdr"){
    
    rocr_perf@alpha.values <- lapply(rocr_perf@alpha.values, function(x) 1 - x)
  }
  
  a.vals <- unlist(rocr_perf@alpha.values)
  alpha.values <- seq(min(a.vals[!is.infinite(a.vals)]),
                      max(a.vals[!is.infinite(a.vals)]),
                      length = max( sapply(rocr_perf@alpha.values, length)))
  
  perf.sampled <- rocr_perf
  idx_to_skip <- c()
  for (i in 1:length(perf.sampled@y.values)) {
    
    if(length(rocr_perf@x.values[[i]]) - 
       sum(is.nan(rocr_perf@x.values[[i]])) >= 2){
      
      perf.sampled@x.values[[i]] <-
        stats::approxfun(rocr_perf@alpha.values[[i]], 
                         rocr_perf@x.values[[i]],
                         rule = 2, 
                         ties = mean)(alpha.values)
      perf.sampled@y.values[[i]] <-
        stats::approxfun(rocr_perf@alpha.values[[i]], 
                         rocr_perf@y.values[[i]],
                         rule = 2, 
                         ties = mean)(alpha.values)
    }else{
      idx_to_skip <- c(idx_to_skip, i)
    }
  }
  
  ## compute average curve
  perf.avg <- perf.sampled
  ds_to_keep <- !seq_len(length(perf.avg@x.values)) %in% idx_to_skip
  
  perf.avg@x.values <- 
    list( rowMeans( data.frame( perf.avg@x.values[ds_to_keep]), na.rm = T))
  perf.avg@y.values <- 
    list(rowMeans( data.frame( perf.avg@y.values[ds_to_keep]), na.rm = T))
  perf.avg@alpha.values <- list( alpha.values )
  
  if(meas.b == "fdr"){
    res <- list(FDR = 1 - unlist(perf.avg@x.values))
  }else{
    res <- list(PPV = unlist(perf.avg@x.values))
  }
  
  c(res, 
    list(TPR = unlist(perf.avg@y.values),
         Cutoff = unlist(perf.avg@alpha.values)))
}
```

### Average all methods

```{r}
fdrtpr_curve <-
    rbindlist(lapply(split(adj_pval_deind_dt, 
             by = c("SetSize", "MZP", "DsType", "Method")), 
       function(x){
           as.data.table(get_avg_meas(x[, .(Dataset, true_val,
                                            preds)]))
       }), 
       idcol = "DS_meth")

# fdrtpr_curve[is.na(FDR), FDR := 1]
# fdrtpr_curve[is.na(TPR), TPR := 0]

fdrtpr_curve[, c("SetSize", "MZP", "DsType", "Method") := tstrsplit(DS_meth, "\\."), 
        by = DS_meth]

alpha_fdrtpr_curve <- 
    rbindlist(list("0.1" = fdrtpr_curve[order(Cutoff)][Cutoff <= .1, 
                                          lapply(.SD, tail, 1), 
                                          by = DS_meth],
                   "0.05" = fdrtpr_curve[order(Cutoff)][Cutoff <= .05, 
                                          lapply(.SD, tail, 1), 
                                          by = DS_meth],
                   "0.01" = fdrtpr_curve[order(Cutoff)][Cutoff <= .01, 
                                          lapply(.SD, tail, 1), 
                                          by = DS_meth]), 
              idcol = "Alpha")

alpha_fdrtpr_curve$Method <- factor(alpha_fdrtpr_curve$Method, 
                                    levels = levels(factor(fdrtpr_curve$Method, ordered = T)), 
                                    ordered = T)
```

```{r, fig.height=7, fig.width=12}
plot_dt <- fdrtpr_curve[MZP == "bulk"][order(Cutoff)]
plot_dt$Method <- factor(plot_dt$Method, ordered = T)

ggplot(plot_dt, 
       aes(x = FDR, y = TPR, color = Method)) +
    geom_vline(xintercept = .01, linetype = 2, color = "grey25") +
    geom_vline(xintercept = .05, linetype = 2, color = "grey25") +
    geom_vline(xintercept = .1, linetype = 2, color = "grey25") +
    geom_path() + 
    geom_point(data = alpha_fdrtpr_curve[MZP == "bulk" & (Cutoff > FDR)], 
               size = 3, aes(shape = Alpha, fill = Method), show.legend = F) +
    geom_point(data = alpha_fdrtpr_curve[MZP == "bulk" & (Cutoff <= FDR)], 
               size = 3, aes(shape = Alpha), fill = "white") +
    scale_shape_manual("P-adj \U2264", values = 21:23) +
    scale_color_discrete() +
    facet_grid(cols = vars(SetSize),
               rows = vars(MZP)) +
    scale_x_continuous(breaks = x.breaks, 
                       labels = c("", tail(x.breaks, -1))) +
    guides(color = guide_legend(ncol = 7, title.position = "top"),
           shape = guide_legend(ncol = 1, title.position = "top")) +
    coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
    labs(y = "Average TPR", x = "Average FDR") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), 
          panel.grid.major.y = element_blank(), 
          panel.grid.minor.y = element_blank(), 
          panel.grid.major.x = element_line(linetype = 2, color = "grey75"),
          panel.grid.minor.x = element_blank(),
          legend.position = "top")
```

White fill points when P-adj > empirical FDR   

### N05 Average all methods 

```{r, fig.height=7, fig.width=12}
plot_dt <- fdrtpr_curve[MZP == "bulk" & SetSize == "N05"][order(Cutoff)]
plot_dt$Method <- factor(plot_dt$Method, ordered = T)

ggplot(plot_dt, 
       aes(x = FDR, y = TPR, color = Method)) +
    geom_vline(xintercept = .01, linetype = 2, color = "grey25") +
    geom_vline(xintercept = .05, linetype = 2, color = "grey25") +
    geom_vline(xintercept = .1, linetype = 2, color = "grey25") +
    geom_path() + 
    geom_point(data = alpha_fdrtpr_curve[MZP == "bulk" & SetSize == "N05" & (Cutoff > FDR)], 
               size = 3, aes(shape = Alpha, fill = Method), show.legend = F) +
    geom_point(data = alpha_fdrtpr_curve[MZP == "bulk" & SetSize == "N05" & (Cutoff <= FDR)], 
               size = 3, aes(shape = Alpha), fill = "white") +
    scale_shape_manual("P-adj \U2264", values = 21:23) +
    scale_color_discrete() +
    # facet_grid(cols = vars(SetSize),
    #            rows = vars(MZP)) +
    scale_x_continuous(breaks = x.breaks, 
                       labels = c("", tail(x.breaks, -1))) +
    guides(color = guide_legend(ncol = 2, title.position = "top"),
           shape = guide_legend(ncol = 3, title.position = "top")) +
    coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
    labs(y = "Average TPR", x = "Average FDR") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), 
          panel.grid.major.y = element_blank(), 
          panel.grid.minor.y = element_blank(), 
          panel.grid.major.x = element_line(linetype = 2, color = "grey75"),
          panel.grid.minor.x = element_blank(),
          legend.position = "right")
```

## Precision-recall curve {.tabset}

### Average all methods

```{r}
pr_curve <-
    rbindlist(lapply(split(adj_pval_deind_dt, 
             by = c("SetSize", "MZP", "DsType", "Method")), 
       function(x){
           as.data.table(get_avg_meas(x[, .(Dataset, true_val, 
                                            preds = 1 - preds)][order(preds)], 
                                      meas.a = "tpr", 
                                      meas.b = "ppv"))
       }), 
       idcol = "DS_meth")[, Cutoff := 1 - Cutoff]

pr_curve[, c("SetSize", "MZP", "DsType", "Method") := tstrsplit(DS_meth, "\\."), 
        by = DS_meth]

alpha_pr_curve <- 
    rbindlist(list("0.1" = pr_curve[order(Cutoff)][Cutoff <= .1, 
                                          lapply(.SD, tail, 1), 
                                          by = DS_meth],
                   "0.05" = pr_curve[order(Cutoff)][Cutoff <= .05, 
                                          lapply(.SD, tail, 1), 
                                          by = DS_meth],
                   "0.01" = pr_curve[order(Cutoff)][Cutoff <= .01, 
                                          lapply(.SD, tail, 1), 
                                          by = DS_meth]), 
              idcol = "Alpha")

alpha_pr_curve$Method <- factor(alpha_pr_curve$Method, 
                                    levels = levels(factor(pr_curve$Method, ordered = T)), 
                                    ordered = T)
```

```{r, fig.height=7, fig.width=12}
ggplot(pr_curve[MZP == "bulk"][order(Cutoff)], 
       aes(x = TPR, y = PPV, color = Method)) +
    geom_line() +
    geom_point(data = alpha_pr_curve[MZP == "bulk" & (Cutoff > (1 - PPV))], 
               size = 3, aes(shape = Alpha, fill = Method), show.legend = F) +
    geom_point(data = alpha_pr_curve[MZP == "bulk" & (Cutoff <= (1 - PPV))], 
               size = 3, aes(shape = Alpha), fill = "white") +
    scale_shape_manual("P-adj \U2264", values = 21:23) +
    facet_grid(cols = vars(SetSize),
               rows = vars(MZP)) +
    guides(color = guide_legend(ncol = 7, title.position = "top"),
           shape = guide_legend(ncol = 1, title.position = "top")) +
    coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
    labs(x = "Average TPR", y = "Average PPV") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

White fill points when P-adj > empirical FDR   

### N05 Average all methods 

```{r, fig.height=7, fig.width=12}
plot_dt <- pr_curve[MZP == "bulk" & SetSize == "N05"][order(Cutoff)]
plot_dt$Method <- factor(plot_dt$Method, ordered = T)

ggplot(plot_dt, 
       aes(x = TPR, y = PPV, color = Method)) +
    geom_path() + 
    geom_point(data = alpha_pr_curve[MZP == "bulk" & SetSize == "N05" & (Cutoff > 1 - PPV)], 
               size = 3, aes(shape = Alpha, fill = Method), show.legend = F) +
    geom_point(data = alpha_pr_curve[MZP == "bulk" & SetSize == "N05" & (Cutoff <= 1 - PPV)], 
               size = 3, aes(shape = Alpha), fill = "white") +
    scale_shape_manual("P-adj \U2264", values = 21:23) +
    scale_color_discrete() +
    guides(color = guide_legend(ncol = 2, title.position = "top"),
           shape = guide_legend(ncol = 3, title.position = "top")) +
    coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
    labs(y = "Average PPV", x = "Average TPR") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), 
          legend.position = "right")
```

## ROC (FPR vs TPR) 

```{r}
get_auc <- function(y) {
    
    y_preds <- lapply(split(y[, .(Dataset, preds)], 
                            by = "Dataset", 
                            keep.by = F, 
                            drop = T), 
                      function(x)x$preds)
    y_labels <- lapply(split(y[, .(Dataset, true_val)], 
                             by = "Dataset", 
                             keep.by = F, 
                             drop = T), 
                       function(x)x$true_val)
    
    rocr_pred <- ROCR::prediction(predictions = y_preds,
                                  labels = y_labels)
    
    ROCR::performance(rocr_pred, measure = "auc")@y.values
}
```

### P-values ROCR {.tabset}

```{r}
plot_dt <-
    rbindlist(lapply(split(pval_deind_dt, 
             by = c("SetSize", "MZP", "DsType", "Method")), 
       function(x){
           as.data.table(get_avg_meas(x[, .(GeneID = seq_along(true_val),
                                            true_val,
                                            preds = 1 - preds),
                                        by = Dataset], 
                                      meas.a = "tpr", 
                                      meas.b = "fpr"))
       }), idcol = "DS_meth")
plot_dt[, c("SetSize", "MZP", "DsType", "Method") := tstrsplit(DS_meth, "\\."), 
        by = DS_meth]
```

#### Curve plot

```{r, fig.height=9, fig.width=9}
ggplot(plot_dt[MZP == "bulk"][order(Cutoff)], 
       aes(x = PPV, y = TPR, color = Method)) +
    geom_abline(slope = 1, linetype = 2) +
    geom_line() + 
    facet_grid(rows = vars(SetSize)) +
    guides(color = guide_legend(ncol = 2)) +
    coord_fixed() +
    labs(y = "Average TPR", x = "Average FPR") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

#### AUC boxplot

```{r}
## AUC values
auROCcs <-
    rbindlist(lapply(split(pval_deind_dt, 
             by = c("SetSize", "MZP", "DsType", "Method")), 
       function(x){
           as.data.table(get_auc(x[, .(Dataset, true_val, preds = 1 - preds)]))
       }), idcol = "DS_meth")
auROCcs[, c("SetSize", "MZP", "DsType", "Method") := tstrsplit(DS_meth, "\\."), 
        by = DS_meth]

auROCcs <- melt(auROCcs, 
               id.vars = c("DS_meth", "SetSize", "MZP", "DsType", "Method"),
               variable.name = "DsId", 
               value.name = "AUC")

mean_auROCcs <- auROCcs[, .(AUC = mean(AUC, na.rm = T),
                            sdAUC = sd(AUC, na.rm = T),
                            seAUC = sqrt(var(AUC, na.rm = T)/length(AUC))),
                            by = .(SetSize, MZP, DsType,
                                   Method = as.character(Method))]
```

```{r}
auROCcs_file <- file.path(output_dir, "pval_ROC_AUC.csv")
fwrite(auROCcs, 
       auROCcs_file, 
       sep = "\t", row.names = F)
```

ROC AUC values have been saved into <a href="`r auROCcs_file`">`r auROCcs_file`</a>. 

```{r, fig.width=10}
# plot_dt <- auROCcs
mean_plot_dt <- mean_auROCcs
# ggplot(plot_dt, aes(x = Method, y = AUC)) +
#     geom_boxplot() +
#     geom_point(data = mean_plot_dt, 
#              shape = 21, fill = "red") +
#     facet_grid(cols = vars(SetSize),
#                rows = vars(MZP), 
#                scales = "free_y") +
#     theme_bw() +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```


```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- auROCcs
# plot_dt[, .N, by = .(SetSize, Method)]

ggplot(plot_dt, aes(x = Method, y = AUC, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .1, size = .6) +
  facet_grid(cols = vars(SetSize)) +
  labs(x = NULL) +
  scale_color_discrete(guide = "none") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

#### AUROC set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_dt[SetSize == "N05"], 
       aes(x = Method, y = AUC, color = Method)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = .1, size = .6) +
    # facet_grid(cols = vars(SetSize)) +
    labs(y = "AUROC", x = NULL) +
    scale_color_discrete(guide = "none") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```


#### AUC ROCR pointrange

```{r, fig.width=14.5, fig.height=5.5}
ggplot(mean_plot_dt, aes(x = Method, y = AUC)) +
  # geom_line(aes(group = paste(SetSize, MZP, DsType))) +
  # geom_point(shape = 21, fill = "red") +
  geom_pointrange(aes(ymin = AUC - sdAUC, ymax = AUC + sdAUC, color = Method),
                  # fill = "red", shape = 21
                  ) +
  labs(y = "Average AUROC", x = NULL) +
  facet_grid(cols = vars(SetSize), 
             scales = "free_y") +
  scale_fill_discrete(guide = "none") +
  scale_color_discrete(guide = "none") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

#### AUC ROCR table

```{r}
show_dt <- copy(mean_plot_dt)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$MZP <- factor(show_dt$MZP)
show_dt$DsType <- factor(show_dt$DsType)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(c("AUC", "sdAUC", "seAUC"), 3)
```


# Running times {.tabset}

## All set sizes

```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- sbAssayL[, Seconds := ifelse(grepl("_ZW_", Method), Runtime.2, Runtime.1)]

method_names <- sort(unique(plot_dt$Method))
method_colors <- setNames(hue_pal()(length(method_names)), method_names)

plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N05", 
                                          .(Mtime = median(Seconds, na.rm = T)), 
                                          by = Method][order(Mtime, na.last = F), 
                                                       as.character(unique(Method))], 
                         ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = Seconds, color = Method)) +
  geom_boxplot(outlier.size = .5) +
  facet_grid(cols = vars(SetSize)) +
  scale_color_manual(values = method_colors, guide = "none") +
  scale_y_log10(breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  labs(y = "Runtime (mm:ss)", x = NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, 
                                   color = method_colors[levels(plot_dt$Method)]))
```

## N05

```{r, fig.width=4, fig.height=7}
ggplot(plot_dt[SetSize == "N05"], 
       aes(x = Method, y = Seconds, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = .1, size = .6) +
  scale_y_log10("Running time (mm:ss)", 
                breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  scale_x_discrete(limits = rev) +
  labs(x = NULL) +
  scale_color_manual(values = method_colors, guide = "none") +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        axis.text.y = element_text(color = method_colors[rev(levels(plot_dt$Method))]))
```

## F1 vs runtime

```{r, fig.width=11, fig.height=8}
plot_dt <- 
  merge(mf1s, 
        sbAssayL[, .(mTime = mean(Seconds)), by = .(SetSize, MZP, Method)],
        by = c("SetSize", "MZP", "Method"))


ggplot(plot_dt, aes(x = F1, y = mTime, color = Method, shape = baseMethod)) +
  geom_point() +
  facet_grid(cols = vars(SetSize),
             rows = vars(Alpha), 
             scales = "free") +
  scale_y_log10("Runtime (mm:ss)", 
                breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  scale_shape_manual(values = 1:length(unique(plot_dt$baseMethod))) +
  guides(shape = guide_legend(ncol = 2)) +
    labs(x = expression(F[1])) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

## F0.5 vs runtime

```{r, fig.width=11, fig.height=8}
ggplot(plot_dt, aes(x = F0.5, y = mTime, color = Method, shape = baseMethod)) +
  geom_point() +
  facet_grid(cols = vars(SetSize),
             rows = vars(Alpha), 
             scales = "free") +
  scale_y_log10("Runtime (mm:ss)", 
                breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  scale_shape_manual(values = 1:length(unique(plot_dt$baseMethod))) +
  guides(shape = guide_legend(ncol = 2)) +
  labs(x = expression(F[0.5])) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

# Session info

```{r}
sessionInfo()
```

