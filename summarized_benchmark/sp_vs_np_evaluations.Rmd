---
title: "Compare evaluation results of semi-parametric and non-parametric simulations"
author: "Enrico Gaffo"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F)
library(data.table)
library(patchwork)
# install.packages("ggdendro")
library(ggplot2)
library(ggthemes)
library(scales)
library(viridis)
library(DT)

## can be used to compute F1 and other F-scores, such as F0.5 (beta = 0.5)
f.beta <- function(P, R, beta = 1) {
    (1 + beta^2) * ( (P * R) / ( (beta^2 * P) + R) )
}

#' A function to mimic the ggplot default palette
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
```

```{r}
method_types <- 
  data.table(Method = c("circMeta_Dt_PZT", "circMeta_Lc_PZT", "DESeq2_BP_WaT", 
                        "DESeq2_Dt_LRT", "DESeq2_Dt_WaT", "DESeq2_GP_LRT", 
                        "DESeq2_Lc_LRT", "DESeq2_Sc_LRT", "DESeq2_Zi_LRT", 
                        "DESeq2_ZW_LRT", "DEsingle_Dt_LRT", "edgeR_Dt_LRT", 
                        "edgeR_rbst_LRT", "edgeR_rbst_QFT", "edgeR_rbst50df_LRT", 
                        "edgeR_rbstEdf_LRT", "edgeR_rbstTMMswp_LRT", "edgeR_ZW_LRT", 
                        "limma_St_Vst", "lncDIFF_Dt_LRT", "MAST_CPM_LRT", 
                        "metagenomeSeq_Dt_EBT", "monocle_Dt_LRT", "NBID_Dt_LRT", 
                        "NBID_Sc_LRT", "NOISeqBIO_TMM_LRT", "PoissonSeq_Dt_TT", 
                        "ROTScpm_Dt_TLT", "SAMseq_Dt_TT", "seurat_Bim_LRT", 
                        "seurat_Dt_WLX", "voom_Dt_MFT", "voom_LF_MFT", 
                        "voom_Qn_MFT", "voom_Rb_MFT", "voom_Sp_MFT", 
                        "voom_ZW_MFT", "wilcoxon_TMM_WLX"),
             Type = c("Bulk RNA-seq", "Bulk RNA-seq", "Bulk RNA-seq", 
                      "Bulk RNA-seq", "Bulk RNA-seq", "Single cell / metagenome", 
                      "Single cell / metagenome", "Single cell / metagenome", "Single cell / metagenome", 
                      "Single cell / metagenome", "Single cell / metagenome", "Bulk RNA-seq", 
                      "Bulk RNA-seq", "Bulk RNA-seq", "Bulk RNA-seq", 
                      "Bulk RNA-seq", "Single cell / metagenome", "Single cell / metagenome", 
                      "Single cell / metagenome", "Bulk RNA-seq", "Single cell / metagenome", 
                      "Single cell / metagenome", "Single cell / metagenome", "Single cell / metagenome", 
                      "Single cell / metagenome", "Bulk RNA-seq", "Bulk RNA-seq", 
                      "Single cell / metagenome", "Bulk RNA-seq", "Single cell / metagenome", 
                      "Single cell / metagenome", "Bulk RNA-seq", "Single cell / metagenome",
                      "Bulk RNA-seq", "Bulk RNA-seq", "Bulk RNA-seq", 
                      "Single cell / metagenome", "Single cell / metagenome"),
             BaseMethod = c("circMeta", "circMeta", "DESeq2", 
                            "DESeq2", "DESeq2", "glmGamPoi", 
                            "DESeq2", "DESeq2", "DESeq2", 
                            "DESeq2", "DEsingle", "edgeR", 
                            "edgeR", "edgeR", "edgeR", 
                            "edgeR", "edgeR", "edgeR", 
                            "limma", "lncDIFF", "MAST", 
                            "metagenomeSeq", "monocle", "NBID", 
                            "NBID", "NOISeqBIO", "PoissonSeq", 
                            "ROTS", "SAMseq", "Seurat", 
                            "Seurat", "Voom", "Voom", 
                            "Voom", "Voom", "Voom", 
                            "Voom", "Wilcoxon"))
```

```{r}
method_colors <- setNames(object = gg_color_hue(length(method_types$Method)), 
                          nm = sort(method_types$Method))
```

# NP {.tabset}

```{r}
sbAssay_all_dt <- fread(file.path("PC_overall_evaluations/sbAssay_dt.csv.gz"))


colnames(sbAssay_all_dt) <- 
  sub("R\\.3", "R_0.10", 
      sub("R\\.2", "R_0.05", 
          sub("R\\.1", "R_0.01", 
              colnames(sbAssay_all_dt))))

colnames(sbAssay_all_dt) <- 
  sub("rejections\\.3", "rejections_0.10", 
      sub("rejections\\.2", "rejections_0.05", 
          sub("rejections\\.1", "rejections_0.01", 
              colnames(sbAssay_all_dt))))

colnames(sbAssay_all_dt) <- 
  sub("([015])\\.1$", "\\1_padj", 
      colnames(sbAssay_all_dt))

sbAssay_all_dt[, `:=`(F1_0.01 = f.beta(1-FDR_0.01_padj, TPR_0.01_padj),
                  F1_0.05 = f.beta(1-FDR_0.05_padj, TPR_0.05_padj),
                  F1_0.10 = f.beta(1-FDR_0.10_padj, TPR_0.10_padj))]

value_cols <- 
  c(grep("rejections", colnames(sbAssay_all_dt), value = T),
    grep("TPR", colnames(sbAssay_all_dt), value = T),
    grep("TNR", colnames(sbAssay_all_dt), value = T),
    grep("FDR", colnames(sbAssay_all_dt), value = T),
    grep("F1", colnames(sbAssay_all_dt), value = T))
```

## FPR

```{r}
## FPR
sbAssay_dt <- sbAssay_all_dt[MZP == "bulk" & DsType == "mock"]
sbAssay_dt$DsType <- NULL
sbAssay_dt$MZP <- NULL
```

```{r}
idvars <- c("Source_ds", "Dataset", "Method", "SetSize")
np_mock_method_ranks <- 
    melt(sbAssay_dt[, c(idvars, value_cols), with = F], 
         id.vars = idvars)

np_mock_method_ranks[, Alpha := as.numeric(gsub("rejections|TPR|FDR|TNR|_|padj|F1", "", variable))]

## make the FPRs closer to the nominal value ranked on top when sorting by ascending order
## Mind that FPR = 1 - TNR.
np_mock_method_ranks[grepl("^TNR", variable), 
             value := abs((1 - value) - Alpha)][, `:=`(variable = sub("TNR", "FPR", 
                                                                      variable))]

np_mock_method_ranks <- 
    np_mock_method_ranks[order(value, decreasing = F, na.last = T), 
                 Rank := seq_along(value), 
                 by = .(Source_ds, SetSize, Dataset, variable)][]
np_mock_method_ranks[is.na(value), Rank := max(Rank)]

## compute the rank of each method according to FDR, TPR and AUPRC
## in each simulation and then calculate the average rank
np_fpr_mean_rank <- np_mock_method_ranks[variable == "FPR_0.05", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]
```

## TPR, FDR, F1

```{r}
## TPR, FDR, F1, AUPRC

sbAssay_dt <- sbAssay_all_dt[DsType == "de" & MZP == "bulk"]
sbAssay_dt$DsType <- NULL
sbAssay_dt$MZP <- NULL

## mean by set size
# msbAssay_dt <- 
#   melt(sbAssay_dt[, lapply(.SD, mean, na.rm = T), 
#            .SDcols = value_cols,
#            by = .(SetSize, Method)], 
#        id.vars = c("SetSize", 
#                    "Method"))[, Beta := sub(".*(0\\.[015]{2}).*", "\\1", variable)]
```


```{r}
idvars <- c("Source_ds", "Dataset", "Method", "SetSize")
np_method_ranks <- 
    melt(sbAssay_dt[, c(idvars, value_cols), with = F], 
         id.vars = idvars)

np_method_ranks[, Alpha := as.numeric(gsub("rejections|TPR|FDR|_|padj|F1", "", variable))]

## make FDR closer to the nominal value to rank on top when sorting by ascending order
np_method_ranks[grepl("^FDR", variable), value := abs(value - Alpha)]
## make higher TPR to rank on top when sorting by ascending order
np_method_ranks[grepl("^TPR", variable), value := 1 - value]

np_method_ranks[grepl("^F1", variable), value := 1 - value]

np_method_ranks <- 
    np_method_ranks[order(value, decreasing = F, na.last = T), 
                 Rank := seq_along(value), 
                 by = .(Source_ds, SetSize, Dataset, variable)][]
np_method_ranks[is.na(value), Rank := max(Rank)]

## compute the rank of each method according to FDR, TPR and AUPRC
## in each simulation and then calculate the average rank
np_fdr_mean_rank <- np_method_ranks[variable == "FDR_0.05_padj", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]
np_tpr_mean_rank <- np_method_ranks[variable == "TPR_0.05_padj", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]

np_f1_mean_rank <- np_method_ranks[variable == "F1_0.05", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]
```

## AUC

```{r}
##get AUC
np_auc <- fread("PC_overall_evaluations/overall_auc.csv.gz")
np_auc[, DsId := formatC(DsId, width = 2, flag = "0")]

np_auprc_rank <- 
    np_auc[order(AUCPR, decreasing = T, na.last = T), 
        .(Method, AUCPR,
          Rank = seq_along(AUCPR)), 
        by = .(Source_ds, SetSize, DsId)]
np_auprc_rank[is.na(AUCPR), Rank := max(Rank)]

np_auprc_mean_rank <- 
    np_auprc_rank[, .(mean_rank = mean(Rank),
                      sd_rank = sd(Rank)), 
               by = .(SetSize, Method)]
```

# SP {.tabset}

```{r}
sbAssay_all_dt <- fread(file.path("overall_evaluations/sbAssay_dt.csv.gz"))

colnames(sbAssay_all_dt) <- 
  sub("R\\.3", "R_0.10", 
      sub("R\\.2", "R_0.05", 
          sub("R\\.1", "R_0.01", 
              colnames(sbAssay_all_dt))))

colnames(sbAssay_all_dt) <- 
  sub("rejections\\.3", "rejections_0.10", 
      sub("rejections\\.2", "rejections_0.05", 
          sub("rejections\\.1", "rejections_0.01", 
              colnames(sbAssay_all_dt))))

colnames(sbAssay_all_dt) <- 
  sub("([015])\\.1$", "\\1_padj", 
      colnames(sbAssay_all_dt))

sbAssay_all_dt[, `:=`(F1_0.01 = f.beta(1-FDR_0.01_padj, TPR_0.01_padj),
                  F1_0.05 = f.beta(1-FDR_0.05_padj, TPR_0.05_padj),
                  F1_0.10 = f.beta(1-FDR_0.10_padj, TPR_0.10_padj))]

value_cols <- 
  c(grep("rejections", colnames(sbAssay_all_dt), value = T),
    grep("TPR", colnames(sbAssay_all_dt), value = T),
    grep("TNR", colnames(sbAssay_all_dt), value = T),
    grep("FDR", colnames(sbAssay_all_dt), value = T),
    grep("F1", colnames(sbAssay_all_dt), value = T))
```

## FPR

```{r}
## FPR
sbAssay_dt <- sbAssay_all_dt[MZP == "bulk" & DsType == "mock"]
sbAssay_dt$DsType <- NULL
sbAssay_dt$MZP <- NULL
```

```{r}
idvars <- c("Source_ds", "Dataset", "Method", "SetSize")
mock_method_ranks <- 
    melt(sbAssay_dt[, c(idvars, value_cols), with = F], 
         id.vars = idvars)

mock_method_ranks[, Alpha := as.numeric(gsub("rejections|TPR|FDR|TNR|_|padj|F1", "", variable))]

## make the FPRs closer to the nominal value ranked on top when sorting by ascending order
## Mind that FPR = 1 - TNR.
mock_method_ranks[grepl("^TNR", variable), 
             value := abs((1 - value) - Alpha)][, `:=`(variable = sub("TNR", "FPR", 
                                                                      variable))]

mock_method_ranks <- 
    mock_method_ranks[order(value, decreasing = F, na.last = T), 
                 Rank := seq_along(value), 
                 by = .(Source_ds, SetSize, Dataset, variable)][]
mock_method_ranks[is.na(value), Rank := max(Rank)]

## compute the rank of each method according to FDR, TPR and AUPRC
## in each simulation and then calculate the average rank
fpr_mean_rank <- mock_method_ranks[variable == "FPR_0.05", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]

fpr_ds_mean_rank <- mock_method_ranks[variable == "FPR_0.05", 
                                      .(mean_rank = mean(Rank),
                                        sd_rank = sd(Rank)), 
                                      by = .(Source_ds, SetSize, Method)]
```

## TPR, FDR, F1

```{r}
## TPR, FDR, F1, AUPRC

sbAssay_dt <- sbAssay_all_dt[DsType == "de" & MZP == "bulk"]
sbAssay_dt$DsType <- NULL
sbAssay_dt$MZP <- NULL
```


```{r}
idvars <- c("Source_ds", "Dataset", "Method", "SetSize")
method_ranks <- 
    melt(sbAssay_dt[, c(idvars, value_cols), with = F], 
         id.vars = idvars)

method_ranks[, Alpha := as.numeric(gsub("rejections|TPR|FDR|_|padj|F1", "", variable))]

## make FDR closer to the nominal value to rank on top when sorting by ascending order
method_ranks[grepl("^FDR", variable), value := abs(value - Alpha)]
## make higher TPR to rank on top when sorting by ascending order
method_ranks[grepl("^TPR", variable), value := 1 - value]

method_ranks[grepl("^F1", variable), value := 1 - value]

method_ranks <- 
    method_ranks[order(value, decreasing = F, na.last = T), 
                 Rank := seq_along(value), 
                 by = .(Source_ds, SetSize, Dataset, variable)][]
method_ranks[is.na(value), Rank := max(Rank)]

## compute the rank of each method according to FDR, TPR and AUPRC
## in each simulation and then calculate the average rank
fdr_mean_rank <- method_ranks[variable == "FDR_0.05_padj", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]
tpr_mean_rank <- method_ranks[variable == "TPR_0.05_padj", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]

f1_mean_rank <- method_ranks[variable == "F1_0.05", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method)]
## keep source set
fdr_ds_mean_rank <- method_ranks[variable == "FDR_0.05_padj", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method, Source_ds)]

tpr_ds_mean_rank <- method_ranks[variable == "TPR_0.05_padj", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method, Source_ds)]

f1_ds_mean_rank <- method_ranks[variable == "F1_0.05", 
                              .(mean_rank = mean(Rank),
                                sd_rank = sd(Rank)), 
                              by = .(SetSize, Method, Source_ds)]
```

## AUC 

```{r}
##get AUC
auc <- fread("overall_evaluations/overall_auc.csv.gz")
auc[, DsId := formatC(DsId, width = 2, flag = "0")]

auprc_rank <- 
    auc[order(AUCPR, decreasing = T, na.last = T), 
        .(Method, AUCPR,
          Rank = seq_along(AUCPR)), 
        by = .(Source_ds, SetSize, DsId)]
auprc_rank[is.na(AUCPR), Rank := max(Rank)]

auprc_mean_rank <- 
    auprc_rank[, .(mean_rank = mean(Rank),
                   sd_rank = sd(Rank)), 
               by = .(SetSize, Method)]

auprc_ds_mean_rank <- 
    auprc_rank[, .(mean_rank = mean(Rank),
                   sd_rank = sd(Rank)), 
               by = .(SetSize, Method, Source_ds)]
```

# Combine

```{r}
mean_ranks <- rbindlist(list(SP_FPR = fpr_mean_rank, 
                             SP_TPR = tpr_mean_rank, 
                             SP_FDR = fdr_mean_rank, 
                             SP_AUC = auprc_mean_rank, 
                             SP_F1 = f1_mean_rank, 
                             NP_FPR = np_fpr_mean_rank, 
                             NP_TPR = np_tpr_mean_rank, 
                             NP_FDR = np_fdr_mean_rank, 
                             NP_AUC = np_auprc_mean_rank,
                             NP_F1 = np_f1_mean_rank), 
                        idcol = "Measure")
mean_ranks[, c("Sim", "Meas"):=tstrsplit(Measure, "_")]
```

```{r}
ds_mean_ranks <- rbindlist(list(SP_FPR = fpr_ds_mean_rank, 
                                SP_TPR = tpr_ds_mean_rank, 
                                SP_FDR = fdr_ds_mean_rank, 
                                SP_AUC = auprc_ds_mean_rank, 
                                SP_F1 = f1_ds_mean_rank, 
                                NP_FPR = np_fpr_mean_rank, 
                                NP_TPR = np_tpr_mean_rank, 
                                NP_FDR = np_fdr_mean_rank, 
                                NP_AUC = np_auprc_mean_rank,
                                NP_F1 = np_f1_mean_rank), 
                           idcol = "Measure", fill = T)
ds_mean_ranks[, c("Sim", "Meas"):=tstrsplit(Measure, "_")]
ds_mean_ranks[Sim == "NP", Source_ds := "PC"]
```


```{r}
npsp_fpr_rank <- rbindlist(list(NP = np_mock_method_ranks[variable == "FPR_0.05"], 
                                SP = mock_method_ranks[variable == "FPR_0.05"]), 
                           idcol = "Sim")
npsp_fdr_rank <- rbindlist(list(NP = np_method_ranks[variable == "FDR_0.05_padj"],
                                SP = method_ranks[variable == "FDR_0.05_padj"]), 
                           idcol = "Sim")
npsp_tpr_rank <- rbindlist(list(NP = np_method_ranks[variable == "TPR_0.05_padj"], 
                                SP = method_ranks[variable == "TPR_0.05_padj"]), 
                           idcol = "Sim")
npsp_auprc_rank <- rbindlist(list(NP = np_auprc_rank, 
                                  SP = auprc_rank), 
                             idcol = "Sim")
npsp_f1_rank <- rbindlist(list(NP = np_method_ranks[variable == "F1_0.05"], 
                               SP = method_ranks[variable == "F1_0.05"]), 
                          idcol = "Sim")

all_meas_ranks <- rbindlist(list(FPR = npsp_fpr_rank[, .(Sim, Source_ds, SetSize, Method, Rank,
                                                         DsId = gsub(".*_([0-9]{2})$", "\\1", Dataset))],
                                 FDR = npsp_fdr_rank[, .(Sim, Source_ds, SetSize, Method, Rank, 
                                                         DsId = gsub(".*_([0-9]{2})$", "\\1", Dataset))],
                                 TPR = npsp_tpr_rank[, .(Sim, Source_ds, SetSize, Method, Rank,
                                                         DsId = gsub(".*_([0-9]{2})$", "\\1", Dataset))],
                                 AUC = npsp_auprc_rank[, .(Sim, Source_ds, SetSize, Method, Rank, DsId)],
                                 F1 = npsp_f1_rank[, .(Sim, Source_ds, SetSize, Method, Rank,
                                                         DsId = gsub(".*_([0-9]{2})$", "\\1", Dataset))]),
                            idcol = "Measure")

# a <- dcast(data = all_meas_ranks, 
#            formula = Measure + Source_ds + SetSize + Method + DsId ~ Sim, 
#            value.var = "Rank")[, .(T.test.pval_NPSP = t.test(NP, SP)$p.value), 
#                                by = .(Measure, SetSize, Method)]
```

## Correlations

```{r}
meth.mean.rank.cors <- 
    dcast(all_meas_ranks[, .(Mean_rank = mean(Rank)), 
                         by = .(Measure, Sim, SetSize, Method)],
          Measure + SetSize + Method ~ Sim, 
          value.var = "Mean_rank")[, cor.test(SP, NP, method = "spearman", exact = F)[-2],
                                   by = .(Measure, SetSize)]
```

```{r}
datatable(meth.mean.rank.cors[, .(Measure, SetSize, Pvalue = p.value, Rho = estimate)],
          filter = "top", 
          caption = paste("Separman correlation between methods' mean ranks",
                          "in semiparametric and nonparametric simulations"))
```

```{r}
# rbindlist(list(SP = rbindlist(list(mock_method_ranks[variable == "FPR_0.05"], 
#                                    method_ranks[variable %in% c("FDR_0.05_padj", "TPR_0.05_padj", "F1_0.05")], 
#                                    auprc_rank[, .(Source_ds, )])),
#                NP = rbindlist(list(np_mock_method_ranks[variable == "FPR_0.05"], 
#                                    np_method_ranks[variable %in% c("FDR_0.05_padj", "TPR_0.05_padj", "F1_0.05")], 
#                                    np_auprc_rank))))

library(psych)

corr_tests <- 
    sapply(split(dcast(ds_mean_ranks,
                       Meas + SetSize + Method ~ Source_ds, 
                       value.var = "mean_rank"), 
                 by = c("Meas", "SetSize"), keep.by = F), 
           FUN = function(x){
               corr.test(as.matrix(data.frame(x, row.names = "Method")),
                         method = "spearman", adjust = "none")
           },
           USE.NAMES = T,
           simplify = F)

corr_tests_l <- 
    merge(rbindlist(sapply(corr_tests, 
                           function(x)reshape2::melt(x$p, value.name = "p.value"), 
                           simplify = F, USE.NAMES = T), 
                    idcol = "Measure.SetSize"),
          rbindlist(sapply(corr_tests, 
                           function(x)reshape2::melt(x$r, value.name = "r"), 
                           simplify = F, USE.NAMES = T), 
                    idcol = "Measure.SetSize"), by = c("Measure.SetSize", "Var1", "Var2"))
corr_tests_l[, c("Measure", "SetSize"):=(tstrsplit(Measure.SetSize, "\\."))]
```

```{r}
datatable(corr_tests_l, filter = "top")
```

```{r, fig.height=6.5, fig.width=4}
ggplot(corr_tests_l[Var1==Var2, p.value := NA], 
       aes(x = Var1, y = Var2, fill = -log10(p.value))) +
    geom_tile() +
    facet_grid(rows = vars(Measure),
               cols = vars(SetSize)) +
    coord_fixed() +
    scale_fill_viridis() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```


```{r, fig.height=6.5, fig.width=4}
ggplot(corr_tests_l, 
       aes(x = Var1, y = Var2, fill = r)) +
    geom_tile() +
    facet_grid(rows = vars(Measure),
               cols = vars(SetSize)) +
    coord_fixed() +
    scale_fill_distiller(type = "div", palette = "RdYlBu", 
                         breaks = c(-1, -.5, 0, .5, 1), limits = c(-1, 1)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

## Test mean difference {.tabset}

```{r}
t.test.spnp <- function(x, y, z, data){
    
    res <- tryCatch(t.test(x = data[Sim == "NP" &
                               Measure == x & 
                               SetSize == z &
                               Method == y, Rank],
                  y = data[Sim == "SP" &
                               Measure == x & 
                               SetSize == z &
                               Method == y, Rank],
                  paired = F, 
                  alternative = "two.sided", 
                  var.equal = T), 
                  error = function(e) list(p.value = 1))
    
    data.table(Measure = x, 
               Method = y, 
               SetSize = z,
               pval = res$p.value)
}

wilcox.test.spnp <- function(x, y, z, data){
    
    res <- tryCatch(wilcox.test(x = data[Sim == "NP" &
                               Measure == x & 
                               SetSize == z &
                               Method == y, Rank],
                  y = data[Sim == "SP" &
                               Measure == x & 
                               SetSize == z &
                               Method == y, Rank],
                  paired = F, 
                  exact = F,
                  alternative = "two.sided", 
                  var.equal = T), 
                  error = function(e) list(p.value = 1))
    
    data.table(Measure = x, 
               Method = y, 
               SetSize = z,
               pval = res$p.value)
}

# median.test.spnp <- function(x, y, z, data){
#     library(coin)
#     res <- median_test(formula = Rank ~ Sim, 
#                 data = data[Measure == x & 
#                                 SetSize == z &
#                                 Method == y, Rank])
#     
#     data.table(Measure = x, 
#                Method = y, 
#                SetSize = z,
#                pval = pvalue(res))
# }

msm <- unique(all_meas_ranks[, .(Measure, SetSize, Method)])

all_meas_ranks$Sim <- factor(all_meas_ranks$Sim)

t.test.spnp_pvals <- 
    rbindlist(mapply(FUN = t.test.spnp, x = msm$Measure, z = msm$SetSize, y = msm$Method, 
                 MoreArgs = list(data = all_meas_ranks), SIMPLIFY = F, USE.NAMES = F))

wilcox.test.spnp_pvals <- 
    rbindlist(mapply(FUN = wilcox.test.spnp, x = msm$Measure, z = msm$SetSize, y = msm$Method, 
                 MoreArgs = list(data = all_meas_ranks), SIMPLIFY = F, USE.NAMES = F))

library(coin)
median.test.spnp_pvals <- 
    all_meas_ranks[, .(pval = pvalue(median_test(Rank~Sim))), 
               by = .(Measure, SetSize, Method)]

kruskal.test.spnp_pvals <- 
    all_meas_ranks[, .(pval = kruskal.test(Rank~Sim)$p.value), 
                   by = .(Measure, SetSize, Method)]


pval2stars <- function(pval){
    lab <- "NS"
    if(is.nan(pval)) return("NS")
    if(pval <= 0.05) lab <- "*"
    if(pval <= 0.01) lab <- "**"
    if(pval <= 0.001) lab <- "***"
    lab
}

t.test.spnp_pvals$StarLabel <- sapply(t.test.spnp_pvals$pval, pval2stars)
wilcox.test.spnp_pvals$StarLabel <- sapply(wilcox.test.spnp_pvals$pval, pval2stars)
median.test.spnp_pvals$StarLabel <- sapply(median.test.spnp_pvals$pval, pval2stars)
kruskal.test.spnp_pvals$StarLabel <- sapply(kruskal.test.spnp_pvals$pval, pval2stars)
```

### Table

```{r}
datatable(merge(t.test.spnp_pvals, wilcox.test.spnp_pvals, 
                by = c("Measure", 
                       "Method", "SetSize"), 
                suffixes = c(".T", ".Wilcox")), 
          filter = "top")
```

### Plot Wilcox

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(wilcox.test.spnp_pvals, 
       aes(x = Method, y = Measure, fill = pval, color = pval <= 0.05)) +
    geom_tile(aes(width=0.9, height=0.9), size=1) +
    scale_fill_viridis() +
    scale_color_manual(values = c(`TRUE` = "red", `FALSE` = NULL, `NA` = NULL), na.value = NA) +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r}
ggplot(wilcox.test.spnp_pvals, 
       aes(x = Method, y = Measure, fill = log10(pval), color = pval <= 0.05)) +
    geom_tile(aes(width=0.9, height=0.9), size=1) +
    scale_fill_viridis() +
    scale_color_manual(values = c(`TRUE` = "red", `FALSE` = NULL, `NA` = NULL), na.value = NA) +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```


```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(wilcox.test.spnp_pvals, 
       aes(x = Method, y = Measure, fill = StarLabel, color = pval <= 0.05)) +
    geom_tile(aes(width=0.9, height=0.9), size=1) +
    scale_fill_viridis_d(direction = -1) +
    scale_color_manual(values = c(`TRUE` = "red", `FALSE` = NULL, `NA` = NULL), na.value = NA) +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

### Plot T-test

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(t.test.spnp_pvals, 
       aes(x = Method, y = Measure, fill = pval)) +
    geom_tile() +
    scale_fill_viridis() +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(t.test.spnp_pvals,
       aes(x = Method, y = Measure, fill = StarLabel)) +
    geom_tile() +
    scale_fill_viridis_d(direction = -1) +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

### Plot median-test

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(median.test.spnp_pvals, 
       aes(x = Method, y = Measure, fill = pval)) +
    geom_tile() +
    scale_fill_viridis() +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(median.test.spnp_pvals,
       aes(x = Method, y = Measure, fill = StarLabel)) +
    geom_tile() +
    scale_fill_viridis_d(direction = -1) +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

### Plot Kruskal test

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(kruskal.test.spnp_pvals, 
       aes(x = Method, y = Measure, fill = pval)) +
    geom_tile() +
    scale_fill_viridis() +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

```{r}
## -log10(pval) to transform lower p-vals into higher numbers, as in volcano plot

ggplot(kruskal.test.spnp_pvals,
       aes(x = Method, y = Measure, fill = StarLabel)) +
    geom_tile() +
    scale_fill_viridis_d(direction = -1) +
    facet_grid(rows = vars(SetSize)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

## Mean rank plots {.tabset}

### Mean N03

```{r, fig.width=6.69, fig.height=6.5}
plot_dt <- mean_ranks[SetSize == "N03"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, 
       aes(x = Meas, y = mean_rank, color = Sim)) + 
    labs(y = "Mean rank", x = "Measure") +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed") + 
    geom_line(aes(group = Sim)) + 
    geom_point(aes(shape = Sim), size = 2) + 
    facet_wrap(~ Method, 
               labeller = label_wrap_gen(width = 7), 
               ncol = 10) +
    scale_color_calc("Simulations") +
    scale_shape("Simulations") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = c(.9, .1), 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- mean_ranks[SetSize == "N03"]

# plot_dt <- 
#     merge(t.test.spnp_pvals[, .(Meas = Measure, Method, SetSize, pval, StarLabel)], 
#           plot_dt, 
#           by = c("Method", "Meas", "SetSize"))
plot_dt <- 
    merge(wilcox.test.spnp_pvals[, .(Meas = Measure, Method, SetSize, pval, StarLabel)], 
          plot_dt, 
          by = c("Method", "Meas", "SetSize"))

plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    # geom_text(data = plot_dt[Sim == "SP"], 
    #           aes(label = StarLabel, y = 40), angle = 90, hjust = 0, 
    #           color = "black") +
    facet_grid(rows = vars(Meas), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_calc("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    coord_cartesian(clip = "off") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- ds_mean_ranks[SetSize == "N03"]

plot_dt[, Method := gsub("_", " ", Method), by = Method]
ds_colors <- setNames(tableau_color_pal(palette = "Tableau 10", direction = -1)(5), 
                      c("PC", "DM1", "IDC", "IPF", "MS"))

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Source_ds, shape = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Source_ds)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    facet_grid(rows = vars(Meas), 
               labeller = label_wrap_gen(width = 7)) +
    scale_shape("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    scale_color_manual("Origin data set", values = ds_colors) +
    coord_cartesian(clip = "off") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

### Mean N05

```{r, fig.width=6.69, fig.height=6.5}
plot_dt <- mean_ranks[SetSize == "N05"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, 
       aes(x = Meas, y = mean_rank, color = Sim)) + 
    labs(y = "Mean rank", x = "Measure") +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed") + 
    geom_line(aes(group = Sim)) + 
    geom_point(aes(shape = Sim), size = 2) + 
    facet_wrap(~ Method, 
               labeller = label_wrap_gen(width = 7), 
               ncol = 10) +
    scale_color_calc("Simulations") +
    scale_shape("Simulations") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = c(.9, .1), 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- mean_ranks[SetSize == "N05"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    facet_grid(rows = vars(Meas), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_calc("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- ds_mean_ranks[SetSize == "N05"]

plot_dt[, Method := gsub("_", " ", Method), by = Method]
ds_colors <- setNames(tableau_color_pal(palette = "Tableau 10", direction = -1)(5), 
                      c("PC", "DM1", "IDC", "IPF", "MS"))

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Source_ds, shape = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Source_ds)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    facet_grid(rows = vars(Meas), 
               labeller = label_wrap_gen(width = 7)) +
    scale_shape("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    scale_color_manual("Origin data set", values = ds_colors) +
    coord_cartesian(clip = "off") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

### Mean N10

```{r, fig.width=6.69, fig.height=6.5}
plot_dt <- mean_ranks[SetSize == "N10"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, 
       aes(x = Meas, y = mean_rank, color = Sim)) + 
    labs(y = "Mean rank", x = "Measure") +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed") + 
    geom_line(aes(group = Sim)) + 
    geom_point(aes(shape = Sim), size = 2) + 
    facet_wrap(~ Method, 
               labeller = label_wrap_gen(width = 7), 
               ncol = 10) +
    scale_color_calc("Simulations") +
    scale_shape("Simulations") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = c(.9, .1), 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- mean_ranks[SetSize == "N10"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    facet_grid(rows = vars(Meas), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_calc("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- ds_mean_ranks[SetSize == "N10"]

plot_dt[, Method := gsub("_", " ", Method), by = Method]
ds_colors <- setNames(tableau_color_pal(palette = "Tableau 10", direction = -1)(5), 
                      c("PC", "DM1", "IDC", "IPF", "MS"))

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Source_ds, shape = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Source_ds)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    facet_grid(rows = vars(Meas), 
               labeller = label_wrap_gen(width = 7)) +
    scale_shape("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    scale_color_manual("Origin data set", values = ds_colors) +
    coord_cartesian(clip = "off") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

### All set sizes together

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[, .(mean_rank = mean(Rank),
                   sd_rank = sd(Rank)), 
               by = .(Measure, Sim, Method)]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, aes(x = Method, y = mean_rank, color = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, ymax = mean_rank + sd_rank), 
                    position = position_dodge2(width = .3)) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_calc("Simulation type", labels = c("Non-parametric", "Semi-parametric")) +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

## Overall ranking {.tabset}

### FDR ord N03

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N03", .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "FDR"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### FDR ord N05

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N05", .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "FDR"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### FDR ord N10

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N10", .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "FDR"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### FDR ord Altogether

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[, .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "FDR"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### F1 ord N03

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N03", .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "F1"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### F1 ord N05

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N05", .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "F1"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### F1 ord N10

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N10", .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "F1"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### F1 ord Altogether

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[, .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[Measure == "F1"][order(mean_rank),
                                                            unique(Method)],
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### Ordered by clustering

```{r, fig.width=8.85, fig.height=6.69}
# rank_mat_dt <- 
#     dcast(data = all_meas_ranks, 
#           formula = Measure + Sim + Source_ds + SetSize + Method ~ DsId, 
#           value.var = "Rank")
# 
# rank_mat_dt[, Id := paste(Measure, Sim, Source_ds, SetSize, Method)]
# rank_mat <- as.matrix(data.frame(rank_mat_dt[, c("Id", unique(all_meas_ranks$DsId)), 
#                                    with = F],
#                        row.names = "Id", 
#                        check.names = F))
# 
# rank_clust <- hclust(dist(x = rank_mat, method = "euclidean"), method = "complete")
# plot(rank_clust)

rank_mat_dt <- 
    dcast(data = all_meas_ranks[, .(MeanRank = mean(Rank)), 
                                by = .(Source_ds, SetSize, Method, Measure)], 
          formula = Method ~ Measure + SetSize + Source_ds, 
          value.var = "MeanRank")

rank_mat <- as.matrix(data.frame(rank_mat_dt,
                       row.names = "Method", 
                       check.names = F))

rank_dist <- dist(x = rank_mat, method = "canberra")
# rank_clust <- hclust(rank_dist, method = "complete")
rank_clust <- seriation::seriate(x = rank_dist, method = "GW_complete")
# plot(rank_clust)

pheatmap::pheatmap(mat = as.matrix(rank_dist), 
                   scale = "none", 
                   cluster_rows = seriation::get_order(rank_clust), 
                   cluster_cols = seriation::get_order(rank_clust))

```

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[, .(mean_rank = mean(Rank),
                              sd_rank = sd(Rank)), 
                          by = .(Measure, SetSize, Method)]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]
# plot_dt$Method <- factor(plot_dt$Method, 
#                          levels = plot_dt[Measure == "F1"][order(mean_rank),
#                                                             unique(Method)],
#                          ordered = T)
method_order <- attr(rank_dist, "Labels")[seriation::get_order(rank_clust)]

plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = mean_rank)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method), 
                    position = position_dodge2(width = .3)) +
    geom_point(shape = 21, size = 2.5) +
    facet_grid(rows = vars(Measure, SetSize), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(1, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    scale_x_discrete(limits = method_order) +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[method_order]))
```

```{r, fig.width=8.85, fig.height=6.69}
ggplot(plot_dt, 
       aes(x = Method, y = mean_rank, shape = SetSize)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    # geom_line(aes(group = Sim)) +
    geom_pointrange(aes(ymin = mean_rank - sd_rank, 
                        ymax = mean_rank + sd_rank, 
                        color = Method, fill = Method), size = .2,
                    position = position_dodge2(width = .5)) +
    geom_point(size = 2, #shape = 21, 
                    position = position_dodge2(width = .5)) +
    scale_shape_manual(values = 21:23) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_color_manual(values = method_colors, guide = "none") +
    scale_fill_manual(values = method_colors, guide = "none") +
    coord_cartesian(ylim = c(1, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Mean rank") +
    scale_x_discrete(limits = method_order) +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[method_order]))
```

## Boxplot Overall ranking {.tabset}

```{r}
qtr_rank <- quantile(1:length(unique(plot_dt$Method)), probs = c(.25, .5, .75))
```

### N03

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N03"]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]

median_rank_order <-
    plot_dt[Measure == "FDR", .(Med_rank = median(Rank)),
            by = .(Method)][order(Med_rank),
                              unique(Method)]

plot_dt$Method <- factor(plot_dt$Method, 
                         levels = median_rank_order,
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = Rank)) +
    geom_hline(yintercept = qtr_rank[1], linetype = "dashed", color = "grey55") + 
    geom_hline(yintercept = qtr_rank[2], linetype = "dashed", color = "grey55") + 
    geom_hline(yintercept = qtr_rank[3], linetype = "dashed", color = "grey55") + 
    geom_boxplot(aes(fill = Method), outlier.size = .5)+
    # geom_violin(aes(fill = Method), 
    #             draw_quantiles = c(.25, .5, .75), 
    #             scale = "width") +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_fill_manual(values = method_colors, guide = "none") +
    scale_y_continuous(breaks = qtr_rank) +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### N05

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N05"]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]

median_rank_order <-
    plot_dt[Measure == "FDR", .(Med_rank = median(Rank)),
            by = .(Method)][order(Med_rank),
                              unique(Method)]

plot_dt$Method <- factor(plot_dt$Method, 
                         levels = median_rank_order,
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = Rank)) +
    geom_hline(yintercept = qtr_rank[1], linetype = "dashed", color = "grey55") + 
    geom_hline(yintercept = qtr_rank[2], linetype = "dashed", color = "grey55") + 
    geom_hline(yintercept = qtr_rank[3], linetype = "dashed", color = "grey55") + 
    geom_boxplot(aes(fill = Method), outlier.size = .5)+
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_fill_manual(values = method_colors, guide = "none") +
    scale_y_continuous(breaks = qtr_rank) +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

### N10

```{r, fig.width=8.85, fig.height=6.69}
plot_dt <- all_meas_ranks[SetSize == "N10"]
# plot_dt[, Method := gsub("_", " ", Method), by = Method]

median_rank_order <-
    plot_dt[Measure == "FDR", .(Med_rank = median(Rank)),
            by = .(Method)][order(Med_rank),
                              unique(Method)]

plot_dt$Method <- factor(plot_dt$Method, 
                         levels = median_rank_order,
                         ordered = T)
plot_dt$Measure <- factor(plot_dt$Measure, 
                          levels = c("FDR", "TPR", "FPR", "F1", "AUC"), 
                          ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = Rank)) +
    geom_hline(yintercept = qtr_rank[1], linetype = "dashed", color = "grey55") + 
    geom_hline(yintercept = qtr_rank[2], linetype = "dashed", color = "grey55") + 
    geom_hline(yintercept = qtr_rank[3], linetype = "dashed", color = "grey55") + 
    geom_boxplot(aes(fill = Method), outlier.size = .5)+
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_fill_manual(values = method_colors, guide = "none") +
    scale_y_continuous(breaks = qtr_rank) +
    coord_cartesian(ylim = c(0, length(unique(plot_dt$Method)))) +
    labs(x = NULL, y = "Rank") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 90, 
                                     hjust = 1, 
                                     color = method_colors[levels(plot_dt$Method)]))
```

## Boxplots {.tabset}

## N05

```{r, fig.height=6.69, fig.width=8.85}
plot_dt <- all_meas_ranks[SetSize == "N05"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, aes(x = Measure, y = Rank, fill = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") +
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") +
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") +
    geom_boxplot(outlier.size = .5) +
    facet_wrap(~ Method,
               labeller = label_wrap_gen(width = 7),
               ncol = 10) +
    scale_fill_manual("Simulations", values = c("#BBE7FE", "#D3B5E5")) + # Canva Easter Egg Nest
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = c(.9, .1),
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.height=6.69, fig.width=8.85}
plot_dt <- all_meas_ranks[SetSize == "N05"]
plot_dt[, Method := gsub("_", " ", Method), by = Method]

ggplot(plot_dt, aes(x = Method, y = Rank, fill = Sim)) +
    geom_abline(intercept = 10.25, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 19.5, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_abline(intercept = 28.75, slope = 0, linetype = "dashed", color = "grey55") + 
    geom_boxplot(outlier.size = .5) +
    facet_grid(rows = vars(Measure), 
               labeller = label_wrap_gen(width = 7)) +
    scale_fill_manual("Simulations", values = c("#BBE7FE", "#D3B5E5")) + # Canva Easter Egg Nest
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          text = element_text(size = 10),
          legend.position = "top", 
          strip.text = element_text(size = 6),
          axis.text.x = element_text(angle = 45, hjust = 1))
```
