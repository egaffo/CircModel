---
title: "Evaluate benchmark results comparing all datasets"
author: "Enrico Gaffo"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SummarizedBenchmark)

library(R.utils)
library(data.table)
library(qs)
library(DT)
library(ComplexHeatmap)
library(scales)
library(ggplot2)

library(ggrepel)

library(BiocParallel)

library(ROCR)

nWorkers <- multicoreWorkers()
```

```{r}
## output file path
output_dir <- "overall_evaluations"
dir.create(path = output_dir, showWarnings = F, recursive = T)

# ## input data
# adj_eval_metrics_files <- file.path(c("DM1_evaluations", 
#                               "IPF_evaluations",
#                               "MS_evaluations",
#                               "IDC_evaluations"), 
#                             "adj_eval_metrics.csv.gz")
# 
# adj_eval_metrics_dt <- rbindlist(lapply(adj_eval_metrics_files, fread), idcol = "Source")
```

```{r}
if(file.exists(file.path(output_dir, "sbAssay_dt.csv.gz"))){
    input_dt <- file.path(output_dir, "sbAssay_dt.csv.gz")
    sbAssay_all_dt <- fread(input_dt)
}else{
    sumBench_perf_metrics_qs_files <- file.path(c("DM1_performance",
                                                  "IPF_performance",
                                                  "MS_performance",
                                                  "IDC_performance"), 
                                                "sumBench_perf_metrics.qs")
    
    names(sumBench_perf_metrics_qs_files) <- sub("_performance", "",
                                                 dirname(sumBench_perf_metrics_qs_files))
    
    ## read input: the list of the SummarizedBenchmark objects after the performance evaluation 
    ncpus <- 50
    bpparam <- BatchtoolsParam(workers = length(sumBench_perf_metrics_qs_files), 
                               saveregistry = F,
                               cluster = "slurm",
                               resources = list(ncpus = ncpus, 
                                                walltime = 7200, # 2h max
                                                memory = 1000) #64GB
    )
    
    sbL <- bplapply(sumBench_perf_metrics_qs_files, 
                    qs::qread, 
                    nthreads = ncpus,  #multicoreWorkers()
                    BPPARAM = bpparam)
    
    sbAssay_all_dt <- 
        rbindlist(lapply(sbL,
                         function(sbL){
                             rbindlist(lapply(sbL, 
                                              function(x){
                                                  data.table(as.data.frame(colData(x)), 
                                                             keep.rownames = "Method")
                                              }), 
                                       idcol = "Dataset")[, c("SetSize", "MZP", "DsType", 
                                                              "DsId") := tstrsplit(Dataset, "_")]
                         }
        ), 
        idcol = "Source_ds")
    
    fwrite(sbAssay_all_dt, file.path(output_dir, "sbAssay_dt.csv.gz"))
}
```

```{r}
alpha_targets <- c(0.01, 0.05, 0.1) 
```

# Type I error data set

```{r}
sbAssay_dt <- sbAssay_all_dt[MZP == "bulk" & DsType == "mock"]
sbAssay_dt$DsType <- NULL
sbAssay_dt$MZP <- NULL
```

## FPR - Source DS mean {.tabset}

```{r}
## FPR = 1 - TNR
# setnafill(x = sbAssay_dt, 
#           type = "const", 
#           fill = 0, 
#           nan = NA, 
#           cols = grep("TNR", colnames(sbAssay_dt), value = T))
```

```{r}
colnames(sbAssay_dt) <- 
  sub("R\\.3", "R_0.10", 
      sub("R\\.2", "R_0.05", 
          sub("R\\.1", "R_0.01", 
              colnames(sbAssay_dt))))

colnames(sbAssay_dt) <- 
  sub("rejections\\.3", "rejections_0.10", 
      sub("rejections\\.2", "rejections_0.05", 
          sub("rejections\\.1", "rejections_0.01", 
              colnames(sbAssay_dt))))

colnames(sbAssay_dt) <- 
  sub("\\.1$", "_padj", 
      colnames(sbAssay_dt))
```

```{r}
value_cols <-
  c(grep("rejections", colnames(sbAssay_dt), value = T),
    grep("TNR", colnames(sbAssay_dt), value = T))
```

```{r}
## compute the average value for each source data set
msbAssay_dt <- 
  sbAssay_dt[, lapply(.SD, mean, na.rm = T), 
           .SDcols = value_cols,
           by = .(Source_ds, SetSize, Method)]
```

### Table

```{r}
show_dt <- copy(msbAssay_dt)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 3)
```

### Plot

```{r}
tnr_pattern <- "^TNR_0\\.[015]{2}$" 
Alpha_plot_label <- "P-value \U2264"

plot_dt <- melt(msbAssay_dt, 
                id.vars = c("Source_ds", "SetSize", 
                            "Method"))[grepl(tnr_pattern, variable)]

plot_dt[, variable := sub("TNR_", "", variable)]
```

```{r, fig.width=14.5, fig.height=8.5}
## Avg FPR = 1 - TNR
ggplot(plot_dt, 
       aes(x = Method, y = 1 - value)) +
  geom_line(aes(group = Source_ds, color = Source_ds)) +
  # geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = Source_ds, color = Source_ds)) +
  labs(y = "Average FPR", x = NULL) +
  scale_color_discrete("Source data set") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             rows = vars(variable),
             scales = "free_y") +
  scale_y_sqrt() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

### Plot

```{r, fig.width=14.5, fig.height=8.5}
## Avg FPR = 1 - TNR
ggplot(plot_dt, 
       aes(x = Method, y = 1 - value, color = variable)) +
  geom_line(aes(group = variable)) +
  # geom_boxplot(outlier.shape = NA) +
  geom_point() +
  labs(y = "Average FPR", x = NULL) +
  # scale_color_discrete("Source data set") +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             rows = vars(Source_ds),
             scales = "free_y") +
  scale_y_sqrt() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

## FPR - overall mean {.tabset}

Fraction of circRNAs with P-value below the thresholds (0.01, or 0.05, or 0.10)  
N.B: y-axis are square-root transformed for increased visibility  

### Table

```{r}
value_cols <- 
  c(grep("rejections", colnames(sbAssay_dt), value = T),
    grep("TNR", colnames(sbAssay_dt), value = T))

msbAssay_dt <- 
  sbAssay_dt[, lapply(.SD, mean, na.rm = T), 
             .SDcols = value_cols,
             by = .(SetSize, Method)]
```

```{r}
show_dt <- copy(msbAssay_dt)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 3)
```

### Average dot-line plot

```{r}
tnr_pattern <- "^TNR_0\\.[015]{2}$" 
Alpha_plot_label <- "P-value \U2264"

# plot_dt <- melt(msbAssay_dt, id.vars = c("SetSize", "Method"))
plot_dt <- melt(msbAssay_dt, 
                id.vars = c("SetSize", #"Source_ds"
                            "Method"))[grepl(tnr_pattern, variable)]

plot_dt[, variable := sub("TNR_", "", variable)]
```

```{r, fig.width=14.5, fig.height=5.5}
## Avg FPR = 1 - TNR
ggplot(plot_dt, #[grepl(tnr_pattern, variable)], 
       aes(x = Method, y = 1 - value)) + ## square-root transformed y-axis for increased visibility
  geom_hline(yintercept = 0.01, color = "grey30", linetype = "dashed") +
  geom_hline(yintercept = 0.05, color = "grey30", linetype = "dashed") +
  geom_hline(yintercept = 0.10, color = "grey30", linetype = "dashed") +
  geom_line(aes(group = variable, color = variable)) +
  geom_point(aes(shape = variable, color = variable)) +
  labs(y = "FPR (average fraction of circRNAs with P \U2264 \U003B1)", x = NULL) +
  scale_color_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  facet_grid(cols = vars(SetSize), 
             scales = "free_y") +
  # coord_cartesian(ylim = c(0, 1)) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top")
```

### Boxplot SetSize x Alpha

```{r, fig.width=14.5, fig.height=8.5}
idvars <- c("SetSize", "Method")
plot_dt <- melt(sbAssay_dt[, c(idvars, 
                             grep(tnr_pattern, 
                                  colnames(sbAssay_dt), 
                                  value = T)), with = F], 
                id.vars = idvars)

plot_dt$Alpha <- sub("TNR_", "", plot_dt$variable)

## no need this: all methods gave results in all the data sets 
# n_points <- plot_dt[, .N, by = .(SetSize, Method, Alpha)] 

ggplot(plot_dt, 
       aes(x = Method, y = 1 - value, color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), with = F]), 
             aes(yintercept = as.numeric(Alpha)), 
             linetype = "dashed") +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA, 
  # geom_jitter(width = .1, size = .6) +
  # geom_text(data = n_points,
  #             aes(y = Inf, #y
  #                 label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")),
  #             angle = 90, color = "black",
  #             hjust = "inward", #0
  #             vjust = .5,
  #             fontface = "italic", size = 3) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 \U003B1)", x = NULL) +
  scale_color_discrete(guide = "none") +
  facet_grid(cols = vars(SetSize), rows = vars(Alpha), scales = "free_y") +
  # coord_cartesian(ylim = c(0, 1)) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())
```

### Boxplot Alpha = 0.05

```{r, fig.width=14, fig.height=5}
ggplot(plot_dt[Alpha == 0.05], 
       aes(x = Method, 
           y = 1 - value, 
           color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), with = F])[Alpha == 0.05], 
             aes(yintercept = as.numeric(Alpha)), 
             linetype = "dashed") +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .6) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 0.05)", x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  facet_grid(cols = vars(SetSize), 
             # rows = vars(Alpha), 
             scales = "free_y", 
             drop = T) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())
```

### Alpha = 0.05, set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_dt[Alpha == 0.05 & SetSize == "N05"], 
       aes(x = Method, 
           y = 1 - value, 
           color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), 
                                   with = F])[Alpha == 0.05 & SetSize == "N05"], 
             aes(yintercept = as.numeric(Alpha)), 
             linetype = "dashed") +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .6) +
  labs(y = "FPR\n(fraction of circRNAs with P \U2264 0.05)", x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete(Alpha_plot_label, labels = alpha_targets) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())
```

### Vert Alpha = 0.05, set size = N05

```{r, fig.height=7, fig.width=5}
ggplot(plot_dt[Alpha == 0.05 & SetSize == "N05"], 
       aes(x = Method, 
           y = 1 - value, 
           color = Method)) +
  geom_hline(data = unique(plot_dt[, c("SetSize", "Alpha"), 
                                   with = F])[Alpha == 0.05 & SetSize == "N05"], 
             aes(yintercept = as.numeric(Alpha)), 
             linetype = "dashed") +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .6) +
  labs(y = "FPR (fraction of circRNAs with P \U2264 0.05)", 
       # title = "5 samples per group", 
       x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_x_discrete(limits = rev) +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1)) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())
```

## Characteristics of FP {.tabset}

### Signal-to-noise

(mean(DECs) - mean(notDECs)) / (sd(DECs) + sd(notDECs))  
A positive statistic indicates that the corresponding characteristic is more pronounced in the set if circRNAs called significant. 
The statistics are computed only for the methods calling >= 5 DECs.  

```{r}
source_ds_prfx <- c("DM1", "IDC", "IPF", "MS")

stn_files <- file.path(paste0(source_ds_prfx, "_evaluations"), "signal2noise.csv")
names(stn_files) <- source_ds_prfx
```

```{r}
stn_dt <- rbindlist(lapply(stn_files, fread), idcol = "Source_ds")
# stn_dt[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(setID, "_")]
```

```{r}
plot_dt <- copy(stn_dt)

plot_dt$Method <- as.character(plot_dt$Method)
plot_dt$Val <- factor(capitalize(plot_dt$Val), 
                      levels = c("CV(CPM)", "Fraction zeros", 
                                 "Average CPM", "Variance CPM"), 
                      ordered = T)
```

```{r, fig.height=12, fig.width=8}
n_points <- plot_dt[, .N, by = .(SetSize, Method, Val)]

ggplot(plot_dt, 
       aes(x = Method, y = StN)) +
  geom_hline(yintercept = 0) +
  geom_boxplot(aes(color = Method), outlier.size = .5, varwidth = F) +#, outlier.shape = NA
  # geom_jitter(aes(color = Method), size = .7, width = .1) +
  geom_text(data = n_points, 
            aes(y = Inf, #y
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            # angle = 90, 
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  facet_grid(cols = vars(Val), rows = vars(SetSize)) +
  labs(x = NULL, y = "Signal-to-noise statistics (DECs / not DECs)") +
  scale_color_discrete(guide = "none") +
  coord_flip() +
  scale_x_discrete(limits = rev) +
  theme_bw() +
  theme(legend.position = "top", 
        # axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())
```

### N05 Signal-to-noise

```{r, fig.height=9, fig.width=6}
n_points <- plot_dt[SetSize == "N05", .N, by = .(Method, Val)]
# n_points[, y := ifelse(Val %in% c("CV(CPM)", "Fraction zeros"), 2.2, -2.2)]
n_points[, y := 2.2]

ggplot(plot_dt[SetSize == "N05"], 
       aes(x = Method, y = StN)) +
  # geom_hline(yintercept = 2, linetype = "dashed") +
  # geom_hline(yintercept = 2.8, linetype = "dashed") +
  geom_text(data = n_points, 
            aes(y = Inf, #y
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            # angle = 90, 
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  geom_text(data = n_points, 
            aes(y = y + 1, label = "")) +
  geom_hline(yintercept = 0) +
  geom_boxplot(aes(color = Method), outlier.size = .5, varwidth = F) + #, outlier.shape = NA
  # geom_jitter(aes(color = Method), size = .7, width = .1) +
  facet_wrap(~ Val) + #, scales = "free_y"
  labs(x = NULL, y = "Signal-to-noise statistics (DECs / not DECs)") +
  scale_color_discrete(guide = "none") +
  # coord_cartesian(ylim = c(-2.5, 2.5)) +
  coord_flip() +
  scale_x_discrete(limits = rev) +
  theme_bw() +
  theme(legend.position = "top", 
        # axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())
```


# DE data sets

```{r}
sbAssay_dt <- sbAssay_all_dt[DsType == "de" & MZP == "bulk"]
sbAssay_dt$DsType <- NULL
sbAssay_dt$MZP <- NULL
```

## Performance {.tabset}

```{r}
# setnafill(x = sbAssay_dt, 
#           type = "const", 
#           fill = 1, 
#           nan = NA, 
#           cols = grep("FDR", colnames(sbAssay_dt), value = T))
```

```{r}
colnames(sbAssay_dt) <- 
  sub("R\\.3", "R_0.10", 
      sub("R\\.2", "R_0.05", 
          sub("R\\.1", "R_0.01", 
              colnames(sbAssay_dt))))

colnames(sbAssay_dt) <- 
  sub("rejections\\.3", "rejections_0.10", 
      sub("rejections\\.2", "rejections_0.05", 
          sub("rejections\\.1", "rejections_0.01", 
              colnames(sbAssay_dt))))

colnames(sbAssay_dt) <- 
  sub("([015])\\.1$", "\\1_padj", 
      colnames(sbAssay_dt))
```

```{r}
value_cols <- 
  c(grep("rejections", colnames(sbAssay_dt), value = T),
    grep("TPR", colnames(sbAssay_dt), value = T),
    grep("TNR", colnames(sbAssay_dt), value = T),
    grep("FDR", colnames(sbAssay_dt), value = T))
```

### Table - Source set

```{r}
## mean by data set
msbAssay_dt <- 
  sbAssay_dt[, lapply(.SD, mean, na.rm = T), 
           .SDcols = value_cols,
           by = .(Source_ds, SetSize, Method)]

## number of not NA results
nSuxMsbAssay_dt <- 
  sbAssay_dt[, lapply(.SD, function(x)sum(!is.na(x))), 
           .SDcols = value_cols,
           by = .(Source_ds, SetSize, Method)]
```

Mean by source dataset and set size  

```{r}
show_dt <- copy(msbAssay_dt)
show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 3)
```

Number of valid (i.e. not NA) results  

```{r}
show_dt <- copy(nSuxMsbAssay_dt)
show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 0)
```

### Table - Overall

```{r}
## overall mean 
omsbAssay_dt <- 
  sbAssay_dt[, lapply(.SD, mean, na.rm = T), 
           .SDcols = value_cols,
           by = .(SetSize, Method)]

## number of not NA results
nSuxOmSbAssay_dt <- 
  sbAssay_dt[, lapply(.SD, function(x)sum(!is.na(x))), 
           .SDcols = value_cols,
           by = .(SetSize, Method)]
```

Mean by set size (mean across all data set sources)  

```{r}
show_dt <- copy(omsbAssay_dt)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 3)
```

Number of valid (i.e. not NA) results (across all data set sources)  

```{r}
show_dt <- copy(nSuxOmSbAssay_dt)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, 
          caption = paste("Alphas:", paste(alpha_targets, collapse = "/")),
          rownames = F, 
          filter = "top") %>%
  formatRound(value_cols, 0)
```

### Recall (TPR)

```{r}
## format result data for the plots
plot_dt <- 
  melt(msbAssay_dt, 
       id.vars = c("Source_ds", "SetSize", 
                   "Method"))[grepl("^TPR_0\\.[015]{2}_padj", 
                                    variable, 
                                    perl = F)]

plot_dt[, variable := gsub("TPR|_|padj", "", variable)]
plot_dt$Source_ds <- factor(plot_dt$Source_ds)

Alpha_plot_label <- "P-adj \U2264"
```

```{r, fig.width=14.5, fig.height=8.5}
## Avg TPR
ggplot(plot_dt,
       aes(x = Method, y = value, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = Source_ds)) +
  labs(x = NULL, y = "Average recall") +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(variable)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

Set size ~ betas  

```{r}
## format result data for the plots
id_vars <- c("SetSize", "DsId", "Method")

plot_dt <- 
  melt(sbAssay_dt[, c(value_cols, id_vars), with = F], 
       id.vars = id_vars)[grepl("^TPR_0\\.[015]{2}_padj", 
                                    variable, 
                                    perl = F)]

plot_dt[, variable := gsub("TPR|_|padj", "", variable)]

Alpha_plot_label <- "P-adj \U2264"

n_points <- plot_dt[!is.na(value), .N, by = .(SetSize, variable, Method)]
n_points$y <- 1.3
```

```{r, fig.width=14.5, fig.height=8.5}
## Avg TPR
ggplot(plot_dt,
       aes(x = Method, y = value, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = F) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  labs(x = NULL, y = "TPR") +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(variable)) +
  # scale_y_sqrt() +
  # coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

Set size ~ beta = 0.05  

```{r, fig.width=14.5, fig.height=5.5}
## Avg TPR
ggplot(plot_dt[variable == 0.05],
       aes(x = Method, y = value, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = F) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points[variable == 0.05], 
            aes(y = 1.2,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  labs(x = NULL, y = "TPR at adjusted P = 0.05") +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  facet_grid(cols = vars(SetSize)) +
  # scale_y_sqrt() +
  # coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

N05, beta = 0.05  

```{r, fig.width=7, fig.height=4}
## Avg TPR
ggplot(plot_dt[SetSize == "N05" & variable == 0.05],
       aes(x = Method, y = value, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = F) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points[SetSize == "N05" & variable == 0.05], 
            aes(y = 1.25,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  labs(x = NULL, y = "TPR at adjusted P = 0.05") +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  # scale_y_sqrt() +
  # coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```


### Precision (1-FDR)

```{r}
## format result data for the plots
plot_dt <- 
  melt(msbAssay_dt, 
       id.vars = c("Source_ds", "SetSize", 
                   "Method"))[grepl("^FDR_0\\.[015]{2}_padj", 
                                    variable, 
                                    perl = F)]

plot_dt[, variable := gsub("FDR|_|padj", "", variable)]
plot_dt$Source_ds <- factor(plot_dt$Source_ds)

## PPV = 1-FDR
plot_dt[, value := 1 - value]

Alpha_plot_label <- "P-adj \U2264"
```

```{r, fig.width=14.5, fig.height=8.5}
## Avg PPV
ggplot(plot_dt,
       aes(x = Method, y = value, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = Source_ds)) +
  labs(x = NULL, y = "Average precision") +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(variable)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

Overall means 

```{r}
## format result data for the plots
id_vars <- c("SetSize", "DsId", "Method")

plot_dt <- 
  melt(sbAssay_dt[, c(value_cols, id_vars), with = F], 
       id.vars = id_vars)[grepl("^FDR_0\\.[015]{2}_padj", 
                                    variable, 
                                    perl = F)]

plot_dt[, variable := gsub("FDR|_|padj", "", variable)]

## PPV = 1-FDR
plot_dt[, value := 1 - value]

Alpha_plot_label <- "P-adj \U2264"
```

```{r, fig.width=14.5, fig.height=8.5}
## Avg PPV
ggplot(plot_dt,
       aes(x = Method, y = value, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  labs(x = NULL, y = "Average precision") +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(variable)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

### FDR

```{r}
## format result data for the plots
id_vars <- c("SetSize", "DsId", "Method")

plot_dt <- 
  melt(sbAssay_dt[, c(value_cols, id_vars), with = F], 
       id.vars = id_vars)[grepl("^FDR_0\\.[015]{2}_padj", 
                                    variable, 
                                    perl = F)]

plot_dt[, variable := gsub("FDR|_|padj", "", variable)]

Alpha_plot_label <- "P-adj \U2264"
```

Setsize ~ beta

```{r, fig.width=14.5, fig.height=8.5}
n_points <- plot_dt[!is.na(value), .N, by = .(SetSize, variable, Method)]
n_points$y <- 1.7

ggplot(plot_dt, 
       aes(x = Method, y = value, color = Method)) +
  geom_hline(data = plot_dt[, .N, by = .(SetSize, variable)],
             aes(yintercept = as.numeric(variable)), 
             linetype = "dashed") +
  geom_boxplot(outlier.size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  # geom_jitter(width = .1, size = .6) +
  labs(y = "FDP at adjusted P", x = NULL) +
  scale_color_discrete(guide = "none") +
  scale_y_sqrt(breaks = c(0, 0.01, 0.05, 0.1, .5, 1)) + #, expand = c(0, 0)
  facet_grid(cols = vars(SetSize), rows = vars(variable), scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

Beta = 0.05

```{r, fig.width=14.5, fig.height=5.5}
ggplot(plot_dt[variable == 0.05], 
       aes(x = Method, y = value, color = Method)) +
  geom_hline(yintercept = .05, linetype = "dashed") +
  geom_boxplot(outlier.size = .5) +
  # geom_jitter(width = .1, size = .6) +
  geom_text(data = n_points[variable == 0.05], 
            aes(y = 1.35, label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, hjust = "inward", vjust = .5, 
            fontface = "italic", size = 3, color = "black") +
  # geom_text(data = n_plot_bx_dt[SetSize == "N05" & Alpha == 0.05],
  #           aes(y = y+.1, label = "")) +
  labs(y = "FDP at adjusted P = 0.05",
       # title = "5 samples per group", 
       x = NULL) +
  facet_grid(cols = vars(SetSize)) +
  scale_color_discrete(guide = "none") +
  scale_y_sqrt(breaks = c(.05, .25, .5, .75, 1)) +#, expand = c(0, 0)
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        legend.position = "top", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())
```

Beta = 0.05, set size = N05

```{r, fig.width=7, fig.height=4}
ggplot(plot_dt[SetSize == "N05" & variable == 0.05], 
       aes(x = Method, y = value, color = Method)) +
    geom_hline(yintercept = .05, linetype = "dashed") +
    geom_boxplot(outlier.size = .5) +
    # geom_jitter(width = .1, size = .6) +
    geom_text(data = n_points[SetSize == "N05" & variable == 0.05], 
              aes(y = 1.6, label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"))), 
              angle = 90, hjust = "inward", vjust = .5, 
              fontface = "italic", size = 3, color = "black") +
    # geom_text(data = n_plot_bx_dt[SetSize == "N05" & Alpha == 0.05],
    #           aes(y = y+.1, label = "")) +
    labs(y = "FDP at adjusted P = 0.05",
         # title = "5 samples per group", 
         x = NULL) +
    scale_color_discrete(guide = "none") +
    scale_y_sqrt(breaks = c(.05, .25, .5, .75, 1)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top", 
          panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())
```

## {-}
### F-scores

```{r}
## auxiliary functions

simple_auc <- function(TPR, FPR){
    # inputs already sorted, best scores first 
    dFPR <- c(diff(FPR), 0)
    dTPR <- c(diff(TPR), 0)
    sum(TPR * dFPR) + sum(dTPR * dFPR)/2
}

## can be used to compute F1 and other F-scores, such as F0.5 (beta = 0.5)
f.beta <- function(P, R, beta = 1) {
    (1 + beta^2) * ( (P * R) / ( (beta^2 * P) + R) )
}

## compute F1 score from precision and recall
f1 <- function(P, R) {
    # 2 * ((P * R)/(P + R))
    f.beta(P, R, beta = 1)
}
```

```{r, fig.width=14.5}
## F1-score
ds_id_cols <- c("Source_ds", "SetSize", "Method", "DsId", "Dataset")

fdr_tpr <- 
  melt(sbAssay_dt[, c(value_cols, ds_id_cols), with = F], 
       id.vars = ds_id_cols)[grepl("^FDR_0\\.[015]{2}_padj|^TPR_0\\.[015]{2}_padj", 
                                variable, 
                                    perl = F)]

f1s <- 
  merge(fdr_tpr[grepl("^FDR_0\\.[015]{2}_padj", 
                      variable)][, `:=`(FDR = value, 
                                        Alpha = gsub("FDR|_|padj", "", variable))][, `:=`(variable = NULL,
                                                                                          value = NULL)][],
        fdr_tpr[grepl("^TPR_0\\.[015]{2}_padj", 
                      variable)][, `:=`(TPR = value, 
                                        Alpha = gsub("TPR|_|padj", "", variable))][, `:=`(variable = NULL,
                                                                                          value = NULL)][],
        by = c(ds_id_cols, "Alpha"))

f1s[, `:=`(F1 = f1(1 - FDR, TPR),
           F0.5 = f.beta(1 - FDR, TPR, .5))] 

## add the number of rejections
rej_pattern <- "^rejections_0\\.[015]{2}_padj"

f1s <- 
  merge(f1s, 
        melt(sbAssay_dt[, c(ds_id_cols,
                          grep(rej_pattern, colnames(sbAssay_dt), value = T)), with = F], 
             id.vars = ds_id_cols, 
             value.name = "rejections",
             variable.name = "Alpha")[, Alpha := gsub("rejections|_|padj", "", Alpha)][],
        by = c(ds_id_cols, "Alpha"))

# f1s[is.nan(F1), F1 := 0]
# f1s[is.nan(F0.5), F0.5 := 0]
```

Mean by source dataset  

```{r}
## compute mean values
mf1s <- f1s[, .(F1 = mean(F1, na.rm = T),
                sdF1 = sd(F1, na.rm = T),
                F0.5 = mean(F0.5, na.rm = T),
                sdF0.5 = sd(F0.5, na.rm = T),
                TPR = mean(TPR, na.rm = T),
                sdTPR = sd(TPR, na.rm = T),
                FDR = mean(FDR, na.rm = T),
                sdFDR = sd(FDR, na.rm = T),
                frac_failed = mean(rejections == 0 | is.na(rejections)),
                n_failed = sum(rejections == 0 | is.na(rejections)),
                rejections = mean(rejections, na.rm = T)), 
            by = .(Source_ds, SetSize, Method, Alpha)]
```

```{r}
show_dt <- copy(mf1s)
show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)
show_dt$Alpha <- factor(show_dt$Alpha)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(c("F1", "sdF1", 
                "F0.5", "sdF0.5", 
                "TPR", "sdTPR", 
                "FDR", "sdFDR", 
                "rejections", "frac_failed"), 3)
```

Overall mean  

```{r}
## compute mean values
omf1s <- f1s[, .(F1 = mean(F1, na.rm = T),
                 sdF1 = sd(F1, na.rm = T),
                 F0.5 = mean(F0.5, na.rm = T),
                 sdF0.5 = sd(F0.5, na.rm = T),
                 TPR = mean(TPR, na.rm = T),
                 sdTPR = sd(TPR, na.rm = T),
                 FDR = mean(FDR, na.rm = T),
                 sdFDR = sd(FDR, na.rm = T),
                 frac_failed = mean(rejections == 0 | is.na(rejections)),
                 n_failed = sum(rejections == 0 | is.na(rejections)),
                 rejections = mean(rejections, na.rm = T)), 
             by = .(SetSize, Method, Alpha)]
```

```{r}
show_dt <- copy(omf1s)
# show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)
show_dt$Alpha <- factor(show_dt$Alpha)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(c("F1", "sdF1", 
                "F0.5", "sdF0.5", 
                "TPR", "sdTPR", 
                "FDR", "sdFDR", 
                "rejections", "frac_failed"), 3)
```


#### F1 {.tabset} 

##### Boxplot

```{r, fig.width=14.5, fig.height=8.5}
## Avg F1s
ggplot(mf1s,
       aes(x = Method, y = F1, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = Source_ds)) +
  labs(x = NULL, y = expression(Average~F[1])) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(Alpha)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

```{r, fig.width=14.5, fig.height=8.5}
## Avg F1s
ggplot(f1s,
       aes(x = Method, y = F1, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  # geom_point(aes(shape = Source_ds)) +
  labs(x = NULL, y = expression(Average~F[1])) +
  scale_color_discrete(guide = "none") +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(Alpha)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

##### Average point line plot

```{r, fig.width=14.5}
# plot_dt <- 
#     mf1s[, c("baseMethod", "Params", 
#              "Test") := tstrsplit(Method, 
#                                   "_")][, .(F1 = mean(F1, na.rm = T),
#                                             sdF1 = sd(F1, na.rm = T)), 
#                                         by = .(SetSize, Method, Alpha)]
plot_dt <- omf1s

plot_dt$Method <- gsub("_", " ", plot_dt$Method)
```

```{r, fig.width=14.5}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

method_colors <- setNames(gg_color_hue(length(unique(plot_dt$Method))), 
                          unique(plot_dt$Method))
```

```{r, fig.width=14.5}
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N03" & 
                                              Alpha == "0.05"][order(F1, na.last = F), 
                                                               as.character(Method)], 
                         ordered = T)

p0.05N03 <- 
    ggplot(plot_dt[SetSize == "N03"], 
           aes(x = Method, y = F1)) +
    # geom_line(aes(group = "1"), color = "grey", linetype = "solid") +
    geom_errorbar(aes(ymin = F1 - sdF1, ymax = F1 + sdF1), 
                  color = "grey45",
                  width = 0.5) +
    geom_point(aes(color = Method)) +
    scale_color_manual(values = method_colors, guide = NULL) +
    labs(y = "Average F1", x = NULL) +
    facet_grid(cols = vars(SetSize), 
               rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

```{r, fig.width=14.5}
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N05" & 
                                              Alpha == "0.05"][order(F1, na.last = F), 
                                                               as.character(Method)], 
                         ordered = T)

p0.05N05 <- 
    ggplot(plot_dt[SetSize == "N05"], 
           aes(x = Method, y = F1)) +
    # geom_line(aes(group = "1"), color = "grey", linetype = "solid") +
    geom_errorbar(aes(ymin = F1 - sdF1, ymax = F1 + sdF1), 
                  color = "grey45",
                  width = 0.5) +
    geom_point(aes(color = Method)) +
    scale_color_manual(values = method_colors, guide = NULL) +
    labs(y = "Average F1", x = NULL) +
    facet_grid(cols = vars(SetSize), 
               rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

```{r, fig.width=14.5}
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N10" & 
                                              Alpha == "0.05"][order(F1, na.last = F), 
                                                               as.character(Method)], 
                         ordered = T)

p0.05N10 <- 
    ggplot(plot_dt[SetSize == "N10"], 
           aes(x = Method, y = F1)) +
    # geom_line(aes(group = "1"), color = "grey", linetype = "solid") +
    geom_errorbar(aes(ymin = F1 - sdF1, ymax = F1 + sdF1), 
                  color = "grey45",
                  width = 0.5) +
    geom_point(aes(color = Method)) +
    scale_color_manual(values = method_colors, guide = NULL) +
    labs(y = "Average F1", x = NULL) +
    facet_grid(cols = vars(SetSize), 
               rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

```{r, fig.width=14.5, fig.height=8.5}
library(patchwork)

result <- 
    p0.05N03 + labs(x = NULL, y = NULL) + coord_cartesian(ylim = c(0, 1)) +
    theme(strip.background.y = element_blank(), strip.text.y = element_blank(), 
          plot.margin = unit(c(0, 0, 0, 0), "lines"), panel.grid.major.x = element_blank()) +
    p0.05N05 + labs(x = NULL, y = NULL) + coord_cartesian(ylim = c(0, 1)) +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
          strip.background.y = element_blank(), strip.text.y = element_blank(), 
          plot.margin = unit(c(0, 0, 0, 0), "lines"), panel.grid.major.x = element_blank()) +
    p0.05N10 + labs(x = NULL, y = NULL) + coord_cartesian(ylim = c(0, 1)) +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), 
          plot.margin = unit(c(0, 0, 0, 0), "lines"), panel.grid.major.x = element_blank())

gt <- patchwork::patchworkGrob(result)
gridExtra::grid.arrange(gt, left = "Average F1", bottom = NULL)
```

#### F0.5 {.tabset} 

##### Boxplot

```{r, fig.width=14.5, fig.height=8.5}
## Avg F0.5
ggplot(mf1s,
       aes(x = Method, y = F0.5, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(shape = Source_ds)) +
  labs(x = NULL, y = expression(Average~F[0.5])) +
  scale_color_discrete(guide = "none") +
  scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(Alpha)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```


```{r, fig.width=14.5, fig.height=8.5}
## F0.5s
ggplot(f1s,
       aes(x = Method, y = F0.5, color = Method)) +
  geom_boxplot(outlier.shape = NA) +
  # geom_jitter(width = .1, size = .5) +
  labs(x = NULL, y = expression(Average~F[1])) +
  scale_color_discrete(guide = "none") +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(Alpha)) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        legend.position = "top")
```

##### Average point line plot

```{r, fig.width=14.5}
plot_dt <- omf1s

plot_dt$Method <- gsub("_", " ", plot_dt$Method)
```

```{r, fig.width=14.5}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

method_colors <- setNames(gg_color_hue(length(unique(plot_dt$Method))), 
                          unique(plot_dt$Method))
```

```{r, fig.width=14.5}
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N03" & 
                                              Alpha == "0.05"][order(F0.5, na.last = F), 
                                                               as.character(Method)], 
                         ordered = T)

p0.05N03 <- 
    ggplot(plot_dt[SetSize == "N03"], 
           aes(x = Method, y = F0.5)) +
    # geom_line(aes(group = "1"), color = "grey", linetype = "solid") +
    geom_errorbar(aes(ymin = F0.5 - sdF0.5, ymax = F0.5 + sdF0.5), 
                  color = "grey45",
                  width = 0.5) +
    geom_point(aes(color = Method)) +
    scale_color_manual(values = method_colors, guide = NULL) +
    labs(y = "Average F0.5", x = NULL) +
    facet_grid(cols = vars(SetSize), 
               rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

```{r, fig.width=14.5}
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N05" & 
                                              Alpha == "0.05"][order(F0.5, na.last = F), 
                                                               as.character(Method)], 
                         ordered = T)

p0.05N05 <- 
    ggplot(plot_dt[SetSize == "N05"], 
           aes(x = Method, y = F0.5)) +
    # geom_line(aes(group = "1"), color = "grey", linetype = "solid") +
    geom_errorbar(aes(ymin = F0.5 - sdF0.5, ymax = F0.5 + sdF0.5), 
                  color = "grey45",
                  width = 0.5) +
    geom_point(aes(color = Method)) +
    scale_color_manual(values = method_colors, guide = NULL) +
    labs(y = "Average F0.5", x = NULL) +
    facet_grid(cols = vars(SetSize), 
               rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

```{r, fig.width=14.5}
plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[SetSize == "N10" & 
                                              Alpha == "0.05"][order(F0.5, na.last = F), 
                                                               as.character(Method)], 
                         ordered = T)

p0.05N10 <- 
    ggplot(plot_dt[SetSize == "N10"], 
           aes(x = Method, y = F0.5)) +
    # geom_line(aes(group = "1"), color = "grey", linetype = "solid") +
    geom_errorbar(aes(ymin = F0.5 - sdF0.5, ymax = F0.5 + sdF0.5), 
                  color = "grey45",
                  width = 0.5) +
    geom_point(aes(color = Method)) +
    scale_color_manual(values = method_colors, guide = NULL) +
    labs(y = "Average F0.5", x = NULL) +
    facet_grid(cols = vars(SetSize), 
               rows = vars(Alpha), scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
          legend.position = "top")
```

```{r, fig.width=14.5, fig.height=8.5}
library(patchwork)

result <- 
    p0.05N03 + labs(x = NULL, y = NULL) + coord_cartesian(ylim = c(0, 1)) +
    theme(strip.background.y = element_blank(), strip.text.y = element_blank(), 
          plot.margin = unit(c(0, 0, 0, 0), "lines"), panel.grid.major.x = element_blank()) +
    p0.05N05 + labs(x = NULL, y = NULL) + coord_cartesian(ylim = c(0, 1)) +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
          strip.background.y = element_blank(), strip.text.y = element_blank(), 
          plot.margin = unit(c(0, 0, 0, 0), "lines"), panel.grid.major.x = element_blank()) +
    p0.05N10 + labs(x = NULL, y = NULL) + coord_cartesian(ylim = c(0, 1)) +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), 
          plot.margin = unit(c(0, 0, 0, 0), "lines"), panel.grid.major.x = element_blank())

gt <- patchwork::patchworkGrob(result)
gridExtra::grid.arrange(gt, left = "Average F0.5", bottom = NULL)
```

# Performance curves

```{r}
# adj_pval_deind_files <- file.path(paste0(source_ds_prfx, "_evaluations"), "adj_pval_deind.csv.gz")
# names(adj_pval_deind_files) <- source_ds_prfx
# adj_pval_deind <- rbindlist(lapply(adj_pval_deind_files, 
#                               fread, showProgress = F, drop = "MZP"), 
#                        idcol = "Source_ds")
```

```{r}
pval_deind_files <- file.path(paste0(source_ds_prfx, "_evaluations"), "pval_deind.csv.gz")
names(pval_deind_files) <- source_ds_prfx
pval_deind <- rbindlist(lapply(pval_deind_files, 
                              fread, showProgress = F, drop = "MZP"), 
                       idcol = "Source_ds")
```


```{r}
get_aucpr <- function(preds, trueval){

  preds[is.na(preds)] <- 0
  res <- PerfMeas::precision.at.all.recall.levels(scores = preds, 
                                                  labels = trueval)
  PerfMeas::AUPRC(list(res), comp.precision = TRUE)
}

get_auc <- function(preds, trueval){
  
  preds[is.na(preds)] <- 0
  PerfMeas::AUC.single(pred = preds, labels = trueval)
}

# rocr_get_aucpr <- function(preds, trueval){
#   
#   preds[is.na(preds)] <- 0
#   ROCR::performance(prediction.obj = ROCR::prediction(predictions = preds,
#                                                       labels = trueval),
#                     measure = "aucpr")@y.values[[1]]
# }
# 
# rocr_get_auc <- function(preds, trueval){
#   
#   preds[is.na(preds)] <- 0
#   ROCR::performance(prediction.obj = ROCR::prediction(predictions = preds, 
#                                                       labels = trueval), 
#                     measure = "auc")@y.values[[1]]
# }

scores_trueval <- copy(pval_deind)
scores_trueval[is.na(preds), preds := 1]

## count how many datasets the method failed/crashed
n_ds_crash <- 
  dcast(pval_deind[, .(n_failed = sum(is.na(preds)), 
                       n_circs = length(preds)),
                   by = .(Source_ds, SetSize, DsId, 
                          Method)][, .N, by = .(Source_ds, SetSize, Method, #DsId, 
                                                Status = ifelse(n_failed == n_circs, 
                                                                "FAILED", "GOOD"))],
        Source_ds + SetSize + Method ~ Status, 
        value.var = "N", 
        fill = 0)

auprc_auroc <- 
  scores_trueval[order(preds), #!is.na(preds), 
                 .(AUCPR = get_aucpr(1 - preds, true_val),
                   # rocr_AUCPR = rocr_get_aucpr(1 - preds, true_val),
                   # rocr_AUC = rocr_get_auc(1 - preds, true_val),
                   AUROC = get_auc(1 - preds, true_val)), 
                 by = .(Source_ds, SetSize, DsId, Method)]
```

```{r, fig.width=9, fig.height=5.5}
# ggplot(auprc_auroc, aes(x = AUCPR, y = AUROC, color = Method)) +
#   geom_point(alpha = .5, size = 1) +
#   geom_abline(slope = 1, color = "red") +
#   coord_fixed() +#xlim = c(0, 1), ylim = c(0, 1), expand = F
#   theme_bw()
```

```{r, fig.width=9, fig.height=5.5}
# ggplot(auprc_auroc, aes(x = rocr_AUCPR, y = rocr_AUC, color = Method)) +
#   geom_point(alpha = .5, size = 1) +
#   geom_abline(slope = 1, color = "red") +
#   coord_fixed() +#xlim = c(0, 1), ylim = c(0, 1), expand = F
#   theme_bw()
```

```{r, fig.width=9, fig.height=5.5}
# ggplot(auprc_auroc, aes(x = AUCPR, y = rocr_AUCPR, color = Method)) +
#   geom_point(alpha = .5, size = 1) +
#   geom_abline(slope = 1, color = "red") +
#   coord_fixed() +#xlim = c(0, 1), ylim = c(0, 1), expand = F
#   theme_bw()
```

```{r, fig.width=9, fig.height=5.5}
# ggplot(auprc_auroc, aes(x = AUROC, y = rocr_AUC, color = Method)) +
#   geom_point(alpha = .5, size = 1) +
#   geom_abline(slope = 1, color = "red") +
#   coord_fixed() +#xlim = c(0, 1), ylim = c(0, 1), expand = F
#   theme_bw()
```

```{r}
## save area under curve
auc_file <- file.path(output_dir, "overall_auc.csv.gz")
fwrite(x = auprc_auroc, file = auc_file, row.names = F, sep = "\t")
```

AUC computed values have been saved into <a href="`r auc_file`">`r auc_file`</a>.  

## Area under precision-recall curve {.tabset}

### Table - source ds

```{r}
show_dt <- 
  auprc_auroc[, .(`Mean AUCPR` = mean(AUCPR),
                  `Median AUCPR` = median(AUCPR),
                  `Sd AUCPR` = sd(AUCPR),
                  `Min AUCPR` = min(AUCPR),
                  `Max AUCPR` = max(AUCPR)),
              by = .(Source_ds, SetSize, Method)]

show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(grep(pattern = "Source_ds|SetSize|Method", 
                   x = colnames(show_dt), 
                   value = T, invert = T), digits = 3)
```

### Table - set size

```{r}
show_dt <- 
  auprc_auroc[, .(`Mean AUCPR` = mean(AUCPR),
                  `Median AUCPR` = median(AUCPR),
                  `Sd AUCPR` = sd(AUCPR),
                  `Min AUCPR` = min(AUCPR),
                  `Max AUCPR` = max(AUCPR)),
              by = .(SetSize, Method)]

# show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(grep(pattern = "Source_ds|SetSize|Method", 
                   x = colnames(show_dt), 
                   value = T, invert = T), digits = 3)
```

### Setsize x Source ds

```{r, fig.width=14.5, fig.height=8.5}
plot_dt <- auprc_auroc

# n_points <- auprc_auroc[, .N, by = .(Source_ds, SetSize, Method)]
n_points <- n_ds_crash[, .(Source_ds, SetSize, Method, N = GOOD)]
n_points$y <- 1.5

ggplot(plot_dt,
       aes(x = Method, y = AUCPR, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = F) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  labs(x = NULL, y = "AUCPR") +
  scale_color_discrete(guide = "none") +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(Source_ds)) +
  # coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top")
```

### Setsize

```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- auprc_auroc
n_points <- n_ds_crash[, .(N = sum(GOOD)), by = .(SetSize, Method)]
n_points$y <- 1.15

ggplot(plot_dt,
       aes(x = Method, y = AUCPR, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1), expand = c(0, 0)) +
  labs(x = NULL, y = "AUPRC") +
  scale_color_discrete(guide = "none") +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize)) +
  coord_cartesian(ylim = c(0, unique(n_points$y))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top")
```

### N05

```{r, fig.width=7, fig.height=4}
plot_dt <- auprc_auroc[SetSize == "N05"]
n_points <- n_ds_crash[SetSize == "N05", .(N = sum(GOOD)), by = .(SetSize, Method)]
n_points$y <- 1.3

ggplot(plot_dt,
       aes(x = Method, y = AUCPR, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1), expand = c(0, 0)) +
  labs(x = NULL, y = "AUPRC") +
  scale_color_discrete(guide = "none") +
  # scale_shape_discrete("Source data set") +
  # facet_grid(cols = vars(SetSize)) +
  coord_cartesian(ylim = c(0, unique(n_points$y))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top")
```

## Area under ROC (FPR vs TPR) {.tabset}

### Table - source ds

```{r}
show_dt <- 
  auprc_auroc[, .(`Mean AUROC` = mean(AUROC),
                  `Median AUROC` = median(AUROC),
                  `Sd AUROC` = sd(AUROC),
                  `Min AUROC` = min(AUROC),
                  `Max AUROC` = max(AUROC)),
              by = .(Source_ds, SetSize, Method)]

show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(grep(pattern = "Source_ds|SetSize|Method", 
                   x = colnames(show_dt), 
                   value = T, invert = T), digits = 3)
```

### Table - set size

```{r}
show_dt <- 
  auprc_auroc[, .(`Mean AUROC` = mean(AUROC),
                  `Median AUROC` = median(AUROC),
                  `Sd AUROC` = sd(AUROC),
                  `Min AUROC` = min(AUROC),
                  `Max AUROC` = max(AUROC)),
              by = .(SetSize, Method)]

# show_dt$Source_ds <- factor(show_dt$Source_ds)
show_dt$SetSize <- factor(show_dt$SetSize)
show_dt$Method <- factor(show_dt$Method)

datatable(show_dt, rownames = F, filter = "top") %>%
  formatRound(grep(pattern = "Source_ds|SetSize|Method", 
                   x = colnames(show_dt), 
                   value = T, invert = T), digits = 3)
```

### Setsize x Source ds

```{r, fig.width=14.5, fig.height=8.5}
plot_dt <- auprc_auroc

# n_points <- auprc_auroc[, .N, by = .(Source_ds, SetSize, Method)]
n_points <- n_ds_crash[, .(Source_ds, SetSize, Method, N = GOOD)]
n_points$y <- 1.5

ggplot(plot_dt,
       aes(x = Method, y = AUROC, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = F) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 2, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  labs(x = NULL, y = "AUROC") +
  scale_color_discrete(guide = "none") +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1)) +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize), 
             # scales = "free_y", 
             rows = vars(Source_ds)) +
  # coord_cartesian(ylim = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top")
```

### Setsize

```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- auprc_auroc
n_points <- n_ds_crash[, .(N = sum(GOOD)), by = .(SetSize, Method)]
n_points$y <- 1.15

ggplot(plot_dt,
       aes(x = Method, y = AUROC, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1), expand = c(0, 0)) +
  labs(x = NULL, y = "AUPRC") +
  scale_color_discrete(guide = "none") +
  # scale_shape_discrete("Source data set") +
  facet_grid(cols = vars(SetSize)) +
  coord_cartesian(ylim = c(0, unique(n_points$y))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top")
```

### N05

```{r, fig.width=7, fig.height=4}
plot_dt <- auprc_auroc[SetSize == "N05"]
n_points <- n_ds_crash[SetSize == "N05", .(N = sum(GOOD)), by = .(SetSize, Method)]
n_points$y <- 1.3

ggplot(plot_dt,
       aes(x = Method, y = AUROC, color = Method)) +
  geom_boxplot(outlier.size = .5, varwidth = T) + #outlier.shape = NA
  # geom_jitter(width = .1, size = .5) +
  geom_text(data = n_points, 
            aes(y = y,
                label = paste0("n = ", formatC(N, width = 3, format = "d", flag = "0"), " ")), 
            angle = 90, color = "black",
            hjust = "inward", #0
            vjust = .5, 
            fontface = "italic", size = 3) +
  scale_y_continuous(breaks = c(0, .25, .5, .75, 1), expand = c(0, 0)) +
  labs(x = NULL, y = "AUROC") +
  scale_color_discrete(guide = "none") +
  # scale_shape_discrete("Source data set") +
  # facet_grid(cols = vars(SetSize)) +
  coord_cartesian(ylim = c(0, unique(n_points$y))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top")
```

# Running times {.tabset}

## Set size

```{r, fig.width=14.5, fig.height=5.5}
plot_dt <- sbAssay_dt[, Seconds := ifelse(grepl("_ZW_", Method), Runtime.2, Runtime.1)]

method_names <- sort(unique(plot_dt$Method))
method_colors <- setNames(hue_pal()(length(method_names)), method_names)

plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[, .(Mtime = median(Seconds, na.rm = T)), 
                                          by = Method][order(Mtime), unique(Method)], 
                         ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = Seconds, color = Method)) +
  geom_boxplot(outlier.size = .5) +
  facet_grid(cols = vars(SetSize)) +
  labs(x = NULL, y = "Running time (mm:ss)") +
  scale_color_manual(values = method_colors, guide = "none") +
  scale_y_log10(breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, 
                                   color = method_colors[levels(plot_dt$Method)]),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())
```

## N05

```{r, fig.width=7, fig.height=4}
plot_dt <- sbAssay_dt[SetSize == "N05", 
                      Seconds := ifelse(grepl("_ZW_", Method), Runtime.2, Runtime.1)]

method_names <- sort(unique(plot_dt$Method))
method_colors <- setNames(hue_pal()(length(method_names)), method_names)

plot_dt$Method <- factor(plot_dt$Method, 
                         levels = plot_dt[, .(Mtime = median(Seconds, na.rm = T)), 
                                          by = Method][order(Mtime), unique(Method)], 
                         ordered = T)

ggplot(plot_dt, 
       aes(x = Method, y = Seconds, color = Method)) +
  geom_boxplot(outlier.size = .5) +
  # facet_grid(cols = vars(SetSize)) +
  labs(x = NULL, y = "Running time (mm:ss)") +
  scale_color_manual(values = method_colors, guide = "none") +
  scale_y_log10(breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, 
                                   color = method_colors[levels(plot_dt$Method)]),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank())
```

## Time ~ F1

```{r, fig.width=11, fig.height=8}
plot_dt <- 
  merge(omf1s, 
        sbAssay_dt[, .(mTime = mean(Seconds, na.rm = T)), by = .(SetSize, Method)],
        by = c("SetSize", "Method"))
plot_dt[, c("baseMethod", "Params", 
            "Test") := tstrsplit(Method,
                                 "_")]

ggplot(plot_dt, 
       aes(x = F1, y = mTime, color = Method, shape = baseMethod)) +
  geom_point(size = 2.5) +
  facet_grid(cols = vars(SetSize), 
             # scales = "free",
             rows = vars(Alpha)) +
  scale_y_log10("Running time (mm:ss)", 
                breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  labs(x = expression(F[1])) +
  scale_shape_manual("Model", values = 1:length(unique(plot_dt$baseMethod))) +
  guides(shape = guide_legend(ncol = 2)) +
  theme_bw() #+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

## Time ~ F0.5

```{r, fig.width=11, fig.height=8}
ggplot(plot_dt, aes(x = F0.5, y = mTime, color = Method, shape = baseMethod)) +
  geom_point(size = 2.5) +
  facet_grid(cols = vars(SetSize), 
             # scales = "free",
             rows = vars(Alpha)) +
  scale_y_log10("Running time (mm:ss)", 
                breaks = c(0.1, 1, 10, 60, 600),
                labels = c("00:00.1", "00:01", "00:10", "01:00", "10:00")) +
  labs(x = expression(F[0.5])) +
  scale_shape_manual("Model", values = 1:length(unique(plot_dt$baseMethod))) +
  guides(shape = guide_legend(ncol = 2)) +
  theme_bw() #+
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

# Session info

```{r}
sessionInfo()
```

