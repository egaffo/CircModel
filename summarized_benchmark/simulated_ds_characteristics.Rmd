---
title: "Evaluate benchmark results"
author: "Enrico Gaffo"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# library(SummarizedBenchmark)

library(data.table)
library(qs)
library(DT)
library(ComplexHeatmap)
library(scales)
library(ggplot2)
library(ggrepel)
library(patchwork)

library(BiocParallel)
```

```{r}
## output file path
output_dir <- "sim_ds_chars"
dir.create(path = output_dir, showWarnings = F, recursive = T)

## input data
ds_names <- c("DM1", "IDC", "IPF", "MS")
simulated_datasets_qs_files <- file.path(paste0(ds_names, "_prep_ds"), 
                                         "datasetList.qs")
names(simulated_datasets_qs_files) <- ds_names
```

```{r}
nWorkers <- multicoreWorkers()
```

```{r read_sim_datasets}
## read input: the simulated dataset list
sim_ds_list <- lapply(simulated_datasets_qs_files, 
                      qread, 
                      nthreads = nWorkers)
```

# Data sets characteristics

## Source data sets

```{r}
source_ds_dt <- 
    rbindlist(lapply(setNames(paste0("../data/", 
                                     ds_names, 
                                     "_unfiltered_CirComPara2_circbjr.csv"), 
                              ds_names),
                     function(x){
                         y <- fread(x, data.table = F)
                         m <- as.matrix(y[, -1])
                         rownames(m) <- y[, 1]
                         melt(as.data.table(m[rowSums(m > 0) >= 3, ], 
                                            keep.rownames = "circ_id"),
                              id.vars = "circ_id", variable.name = "sample_id")
                     }
    ), 
    idcol = "DS")
```

```{r, fig.width=5, fig.height=5}
library(ggbeeswarm)

source_hist_cnt <- 
    source_ds_dt[, .(histBJR = .N), 
             by = .(DS, BJR = value)][, Frac := histBJR / sum(histBJR), 
                                  by = .(DS)][]
plot_dt <- source_hist_cnt[, .(AvgFrac = mean(Frac)),
                    by = .(DS, BJR)]

ds_stats <- 
    source_ds_dt[, .(nSamples = .N), 
                 by = .(DS, circ_id)][, .(nSamples = head(nSamples, 1),
                                          nCircs = .N), by = DS]

ch_p <- ggplot(plot_dt, aes(x = BJR, y = AvgFrac)) + 
  geom_col(position = "identity", alpha = 1) +
  # facet_wrap(facets = ~ DS, ncol = 1, scales = "free_y") +
  facet_grid(rows = vars(DS)) +
  coord_cartesian(xlim = c(0, 15)) +
  geom_label(data = ds_stats,
             aes(x = 5, y = .3, 
                 label = paste("# samples:", nSamples, "\n# circRNAs:", comma(nCircs))), hjust = 0) +
  labs(x = "Backsplice-junction reads") +
  scale_y_continuous("Count matrix fraction (%)", 
                     labels = function(x)round(as.numeric(x)*100)) + #labels = percent
  scale_x_continuous(breaks = 0:15, 
                     labels = 0:15) +
  theme_bw() +
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), 
        plot.margin = unit(x = c(.1, .1, .1, .1), units = "lines"), 
        strip.text = element_blank(), 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_blank())

ls_bxp <- 
  ggplot(source_ds_dt[, .(LibSize = sum(value)), by = .(DS, sample_id)],
         aes(x = "", y = LibSize)) +
  geom_boxplot(varwidth = T, notch = F) + #, outlier.shape = NA
  # geom_quasirandom(groupOnX = T, varwidth = T, alpha = .5, aes(fill = LibSize), shape = 21) +
  # geom_violin(draw_quantiles = c(.25, .5, .75)) +
  # scale_fill_viridis_c() +
  scale_x_discrete(name = NULL) +
  scale_y_log10(labels = function(x)sub("000$", "K", x)) +
  labs(x = NULL, y = "Library size") +
  coord_flip() +
  # facet_wrap(facets = ~ DS, ncol = 1) + #, scales = "free_x"
  facet_grid(rows = vars(DS)) +
  theme_bw() +
  theme(axis.ticks.y = element_blank(), 
        panel.grid.major.y = element_blank(),
        plot.margin = unit(x = c(.1, .1, .1, .1), units = "lines"))

ch_p + ls_bxp +
    plot_layout(widths = c(3, 1), )
```

### Within condition correlation of samples

Original data sets after sample selection and circRNA preliminary filters.  

```{r}
trimmed_source_dataset_files <- c(file.path("..", "semi_parametric_sim", 
                                    paste0(ds_names[ds_names != "MS"], "_sims"), 
                                    "trimmed_source_dataset.qs"), 
                            file.path("..", "semi_parametric_sim", 
                                    "trimmed_source_dataset.qs"))

names(trimmed_source_dataset_files) <- c(ds_names[ds_names != "MS"], "MS")
# trimmed_source_dataset_files

trimmed_source_dataset_l <- lapply(trimmed_source_dataset_files, qread)

within_cond_corr <- function(ds, cor.meth = "pearson"){
    
    g1 <- rownames(ds$samples)[as.integer(ds$samples$group) == 1]
    g2 <- rownames(ds$samples)[as.integer(ds$samples$group) == 2]
    
    cor_g1 <- cor(x = ds$counts[, g1], method = cor.meth)
    cor_g2 <- cor(x = ds$counts[, g2], method = cor.meth)
    
    c(G1_cor = mean(cor_g1[upper.tri(cor_g1)]),
      G2_cor = mean(cor_g2[upper.tri(cor_g2)]))
}

data.frame(lapply(trimmed_source_dataset_l, within_cond_corr, cor.meth = "pearson"))
```


## Simulated data sets

```{r, warning=FALSE}
melt_cnt <- rbindlist(lapply(sim_ds_list, 
                        function(sims) {
                            rbindlist(lapply(sims, 
                                             function(x) {
                                                 melt(as.data.table(x$cntdat))
                                             }), 
                                      use.names = T, idcol = "dataset")
                        }), idcol = "DS")

melt_cnt[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(dataset, "_", type.convert = F), 
          by = dataset]
melt_cnt <- melt_cnt[MZP == "bulk"]
```

```{r}
n_sim_circs <- 
  unique(melt_cnt[, .N, 
                  by = .(DS, Purpose, SetSize, ID, 
                         variable)][, .(DS, Purpose, SetSize, ID, N)])
n_sim_circs[Purpose == "de", Purpose := "Signal"]
n_sim_circs[Purpose == "mock", Purpose := "Null"]

n_sim_circs$DS <- factor(n_sim_circs$DS)
n_sim_circs$Purpose <- factor(n_sim_circs$Purpose)
n_sim_circs$SetSize <- factor(n_sim_circs$SetSize)
```

```{r}
datatable(n_sim_circs, caption = "Number of simulated circRNAs per data set", filter = "top")
```


```{r, fig.width=3.5, fig.height=6.5}
ggplot(n_sim_circs, aes(x = SetSize, y = N)) +
  geom_boxplot() +
  labs(y = "Total simulated circRNAs", x = "Set size") +
  facet_grid(rows = vars(DS), cols = vars(Purpose), scales = "free_y") +
  # scale_y_log10() +
  theme_bw() +
  theme(panel.grid.major.x = element_blank())
```

 
# Are matrix zero-inflated?

## Source data sets

```{r}
library(NBID)
meta_files <- setNames(paste0("../data/", 
                                     ds_names, 
                                     "_meta.csv"), 
                              ds_names)

source_ds_mt <- 
    lapply(setNames(paste0("../data/", 
                                     ds_names, 
                                     "_unfiltered_CirComPara2_circbjr.csv"), 
                              ds_names),
                     function(x){
                         y <- fread(x, data.table = F)
                         m <- as.matrix(y[, -1])
                         rownames(m) <- y[, 1]
                         m[rowSums(m > 0) >= 3, ]
                     }
    )


meta_dts <- lapply(meta_files, fread)

fitResult_l <-
    lapply(setNames(ds_names, ds_names), 
           function(x) {
               
               NBID::checkDataDistribution(data = source_ds_mt[[x]][, meta_dts[[x]][["sample_id"]]], 
                                           groups = meta_dts[[x]][["condition"]], 
                                           ncore = multicoreWorkers())
           })

ds_aic <-
    rbindlist(lapply(setNames(ds_names, ds_names), 
                     function(x) {
                         
                         # fitResult <- NBID::checkDataDistribution(data = source_ds_mt[[x]][, meta_dts[[x]][["sample_id"]]], 
                         #                                          groups = meta_dts[[x]][["condition"]], 
                         #                                          ncore = multicoreWorkers())
                         # 
                         # dcast(melt(data.table(fitResult[, c("geneNames", 
                         #                                     grep("modelByAIC", 
                         #                                          colnames(fitResult), value = T))]), 
                         #            id.vars = "geneNames")[, .N, by = .(variable, value)], 
                         #       variable ~ value, 
                         #       value.var = "N")
                         dcast(melt(data.table(fitResult_l[[x]][, c("geneNames", 
                                                                    grep("modelByAIC", 
                                                                         colnames(fitResult_l[[x]]), value = T))]), 
                                    id.vars = "geneNames")[, .N, by = .(variable, value)], 
                               variable ~ value, 
                               value.var = "N")
                     }), 
              idcol = "DS")


# nbid_result <- data.frame(DEUsingNBID(source_ds_mt[[x]][, meta_dts[[x]][["sample_id"]]], 
#                      meta_dts[[x]][["condition"]], 
#                      ncore = multicoreWorkers()))
# 
# nbid_result$FDR <- p.adjust(nbid_result$pvalue, "BH")
# sum(nbid_result$FDR <= .1)

```

```{r}
datatable(ds_aic, rownames = F)
```

```{r}
plot_dt <- melt(ds_aic, id.vars = c("DS", "variable"), variable.name = "Model", value.name = "CircRNAs")

ggplot(plot_dt, aes(x = gsub("_| ", "\n", variable), 
                    y = CircRNAs, fill = Model)) +
    geom_col(position = position_dodge()) +
    facet_wrap(~ DS, drop = T, scales = "free") +
    scale_x_discrete("Condition") +
    theme_bw() +
    theme(legend.position = "top")
```

```{r}
# summaryResult = summaryComparison(fitResult)
# print(summaryResult$modelCount)
fitres_dt <- rbindlist(lapply(fitResult_l, 
                              function(x) data.table(summaryComparison(x)$modelCount)), 
                       idcol = "DS")

```

```{r}
datatable(fitres_dt, rownames = F)
```

## Simulated data sets


```{r}
hist_cnt <- 
    melt_cnt[, .(histBJR = .N), 
             by = .(DS, dataset, SetSize, MZP, Purpose, ID, 
                    BJR = value)][, Frac := histBJR / sum(histBJR), 
                                  by = .(DS, dataset, SetSize, MZP, Purpose, ID)][]
plot_dt <- hist_cnt[, .(AvgFrac = mean(Frac),
                        sdFrac = sd(Frac)),
                    by = .(DS, SetSize, MZP, BJR)] #, Purpose

# plot_dt[is.na(sdFrac), sdFrac := 0]

ggplot(plot_dt, aes(x = BJR, y = AvgFrac)) + #, color = Purpose, fill = Purpose
    geom_errorbar(aes(ymin = AvgFrac - sdFrac, ymax = AvgFrac + sdFrac), width = .6) +
    geom_col(position = "identity", alpha = .5) +
    facet_grid(cols = vars(SetSize), rows = vars(DS), scales = "free") +
    coord_cartesian(xlim = c(0, 15)) +
    scale_y_continuous("Count matrix fraction (%)", 
                       labels = function(x)round(as.numeric(x)*100)) + #labels = percent
    scale_x_continuous(breaks = 0:15, 
                       labels = 0:15) +
    theme_classic() +
    theme(legend.position = "top", 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```



```{r}
sim_ds_dt <- rbindlist(lapply(sim_ds_list, 
                        function(sims) {
                            rbindlist(lapply(sims, 
                                             function(x) {
                                                 data.frame(circ_id = rownames(x$cntdat), 
                                                            AvgBJR = rowMeans(x$cntdat),
                                                            FracZeros = rowSums(x$cntdat == 0) / ncol(x$cntdat),
                                                            is.DEC = x$status)
                                             }), 
                                      use.names = T, idcol = "dataset")
                        }), idcol = "DS")

sim_ds_dt[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(dataset, "_", type.convert = F), 
          by = dataset]
sim_ds_dt <- sim_ds_dt[MZP == "bulk"]
```

# DE simulated data sets 

## Raw expression {.tabset}

### Density multi lines

```{r}
p <- ggplot(data = sim_ds_dt[Purpose == "de"],
            mapping = aes(x = AvgBJR, color = factor(is.DEC))) +
    geom_density(aes(group = paste(dataset, is.DEC))) +
    scale_x_log10() +
    facet_wrap(DS ~ SetSize, 
               # scales = "free_y", 
               ncol = 3, 
               labeller = label_wrap_gen(multi_line = F)) +
    scale_color_discrete("DEC") +
    labs(y = "density") +
    theme_bw() +
    theme(legend.position = "top")
p
```

### Density sahdes ggplot2 stats

```{r}
ld <- as.data.table(layer_data(p))

ld.densities.qtiles <-
    ld[, as.list(c(quantile(y, probs = c(.025, .5, .975)), 
                          Mean = mean(y))), 
       by = .(colour, PANEL, x)]
ld.densities.qtiles[, DEC := ifelse(colour == "#F8766D", F, T)]

ld.densities.qtiles <-
    merge(ld.densities.qtiles, 
          sim_ds_dt[, .N, by = .(DS, SetSize)][, .(PANEL = factor(.I), DS = paste(DS, SetSize))],
          by = "PANEL")


ggplot(ld.densities.qtiles, 
       aes(x = x, y = `50%`)) + #Mean
    facet_wrap(~ DS, 
               # scales = "free", 
               ncol = 3) +
    # geom_histogram(data = sim_ds_dt[Purpose == "de"],
    #                aes(x = AvgBJR, y = ..density..), 
    #                fill = "white",
    #                binwidth = 0.25, boundary = 0) +
    geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`, 
                    fill = DEC), 
                alpha = 0.5) +
    geom_line(aes(color = DEC)) +
    scale_color_discrete("DEC") +
    scale_fill_discrete("DEC") +
    labs(y = "density", x = "Log10(AvgBJR)") +
    theme_bw() +
    theme(legend.position = "top")
```

### Density sahdes custom stats

```{r}
#https://stackoverflow.com/questions/45908120/add-shaded-standard-error-curves-to-geom-density-in-ggplot2
plot_dt <- copy(sim_ds_dt)[, AvgBJR := log10(AvgBJR)][Purpose == "de"]

plot_dt[, `:=` (maxBJR = max(AvgBJR, na.rm = T),
                  minBJR = min(AvgBJR, na.rm = T),
                  len = length(AvgBJR)),
          by = .(MZP, Purpose)] #, DS, SetSize

densities <- 
    plot_dt[, data.frame(broom::tidy(stats::density(x = AvgBJR, 
                                                    # weights = rep(1 / length(AvgBJR), length(AvgBJR)),
                                                    from = min(minBJR, na.rm = T), 
                                                    to = max(maxBJR, na.rm = T),
                                                    bw = "nrd0", #"SJ"
                                                    adjust = 1,
                                                    kernel = "gaussian",
                                                    n = 512,
                                                    na.rm = TRUE))),
              by = .(DS, SetSize, Purpose, ID, DEC = ifelse(is.DEC == 1, T, F))]

densities.qtiles <-
    densities[, as.list(c(quantile(y, probs = c(.025, .5, .975)), 
                          Mean = mean(y))),
              by = .(DS, SetSize, DEC, AvgBJR = x)]

ggplot(densities.qtiles, 
       aes(x = AvgBJR, y = Mean)) + #`50%`
    facet_wrap(DS ~ SetSize, 
               # scales = "free",
               ncol = 3, 
               labeller = label_wrap_gen(multi_line = F)) +
    # geom_histogram(data = sim_ds_dt[Purpose == "de"],
    #                aes(x = AvgBJR, y = ..density..), 
    #                fill = "white",
    #                binwidth = 0.25, boundary = 0) +
    geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`, 
                    fill = DEC), 
                alpha = 0.5) +
    # stat_density(data = sim_ds_dt[Purpose == "de"],
    #              aes(AvgBJR, ..density.., color = "raw density"),
    #              size = 2, geom = "line") +
    geom_line(aes(color = DEC)) +
    scale_color_discrete("DEC") +
    scale_fill_discrete("DEC") +
    labs(y = "density", x = "Log10(AvgBJR)") +
    theme_bw() +
    theme(legend.position = "top")
```

## DEC Fraction of zeros density

```{r}
ggplot(sim_ds_dt, aes(x = FracZeros, color = ifelse(is.DEC == 1, T, F))) +
    # geom_density(aes(group = paste(dataset, is.DEC)), alpha = .3) +
    geom_histogram(aes(y = ..ndensity.., 
                       fill = ifelse(is.DEC == 1, T, F)),
                   position = "identity",
                   alpha = .5, binwidth = .1) +
    scale_color_discrete("DEC") +
    scale_fill_discrete("DEC") +
    facet_grid(cols = vars(SetSize), rows = vars(DS)) + 
    theme_bw() +
    theme(legend.position = "top", 
          axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
# plot_dt <- copy(sim_ds_dt)[Purpose == "de"]
# 
# # plot_dt[, `:=` (maxFZ = max(FracZeros, na.rm = T),
# #                   minFZ = min(FracZeros, na.rm = T),
# #                   len = length(FracZeros)),
# #           by = .(MZP, Purpose)] #, DS, SetSize
# 
# fz_densities <- 
#     plot_dt[, data.frame(broom::tidy(stats::density(x = FracZeros, 
#                                                     # weights = rep(1 / length(AvgBJR), length(AvgBJR)),
#                                                     from = 0, 
#                                                     to = 1,
#                                                     bw = .1, #"nrd0", #"SJ"
#                                                     adjust = 1,
#                                                     kernel = "gaussian",
#                                                     n = 512,
#                                                     na.rm = TRUE))),
#               by = .(DS, SetSize, Purpose, ID, DEC = ifelse(is.DEC == 1, T, F))]
# 
# fz_densities.qtiles <-
#     fz_densities[, as.list(c(quantile(y, probs = c(.025, .5, .975)), 
#                           Mean = mean(y))),
#               by = .(DS, SetSize, DEC, FracZeros = x)]
# 
# ggplot(fz_densities.qtiles, 
#        aes(x = FracZeros, y = Mean, fill = DEC)) + #`50%`
#     facet_wrap(DS ~ SetSize, 
#                # scales = "free",
#                ncol = 3, 
#                labeller = label_wrap_gen(multi_line = F)) +
#     geom_histogram(data = sim_ds_dt[Purpose == "de"][, DEC := ifelse(is.DEC == 1, T, F)],
#                    aes(x = FracZeros, y = ..ndensity..),
#                    # fill = "white",
#                    binwidth = 0.1, alpha = .5) + #boundary = 0,
#     # geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), 
#     #             alpha = 0.5) +
#     # geom_line(aes(color = DEC)) +
#     scale_color_discrete("DEC") +
#     scale_fill_discrete("DEC") +
#     labs(y = "density", x = "Zero faction") +
#     theme_bw() +
#     theme(legend.position = "top")
```

## Raw expression vs fraction of zeros

```{r}
# library(ggrastr)
# plot_dt <- sim_ds_dt[][, DEC := ifelse(is.DEC == 1, T, F)]
# ggplot(plot_dt, aes(x = AvgBJR, y = FracZeros, color = DEC)) +
#     # geom_point_rast() +
#     # geom_density_2d() +
#     geom_smooth() +
#     scale_x_log10() +
#     facet_grid(cols = vars(SetSize), rows = vars(DS)) + 
#     theme_bw() +
#     theme(legend.position = "top", 
#           axis.text.x = element_text(angle = 30, hjust = 1))
```

## CircRNA counts

```{r}
ncircs <- sim_ds_dt[Purpose == "de", .N, 
                 by = .(DS, SetSize, ID, 
                        DEC = ifelse(is.DEC == 1, T, F))]

ggplot(ncircs,
       aes(x = SetSize, y = N, color = DEC)) +
    geom_boxplot() +
    scale_y_log10("Simulated circRNAs") +
    facet_wrap(~ DS, 
               # scales = "free_y", 
               dir = "v") +
    theme_bw() +
    theme(legend.position = "top")
```

```{r}
datatable(dcast(ncircs, DS + SetSize + ID ~ DEC)[, Tot := `FALSE` + `TRUE`][], 
          rownames = F, filter = "top")
```

```{r}
datatable(ncircs[, as.list(summary(N)), by = .(DS, SetSize)], 
          rownames = F, filter = "top")
```

```{r}
datatable(ncircs[, as.list(summary(N)), by = .(DS, SetSize, DEC)], 
          rownames = F, filter = "top")
```

# Mock 

```{r}
ncircs <- sim_ds_dt[Purpose == "mock", .N, 
                 by = .(DS, SetSize, ID)]

ggplot(ncircs,
       aes(x = SetSize, y = N)) +
    geom_boxplot() +
    scale_y_log10("Simulated circRNAs") +
    facet_wrap(~ DS, 
               # scales = "free_y", 
               dir = "v") +
    theme_bw() +
    theme(legend.position = "top")
```

```{r}
datatable(ncircs[, as.list(summary(N)), by = .(DS, SetSize)], 
          rownames = F, filter = "top")
```

# Session info

```{r}
sessionInfo()
```

