---
title: "Evaluate benchmark results"
author: "Enrico Gaffo"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
outdir <- "simulated_ds_characteristics"
dir.create(path = outdir, showWarnings = F, recursive = T)

knitr::opts_chunk$set(echo = TRUE, 
                      fig.path = file.path(outdir, "Figs/"), 
                      dev = c("png", "svglite", "pdf"))

# library(SummarizedBenchmark)

library(data.table)
library(qs)
library(DT)
library(ComplexHeatmap)
library(scales)
library(ggplot2)
library(ggrepel)
library(patchwork)
library(ggbeeswarm)

library(BiocParallel)
```

```{r}
## output file path
output_dir <- "sim_ds_chars"
dir.create(path = output_dir, showWarnings = F, recursive = T)

## input data
ds_names <- c("DM1", "IDC", "IPF", "MS")
simulated_datasets_qs_files <- file.path(paste0(ds_names, "_prep_ds"), 
                                         "datasetList.qs")
names(simulated_datasets_qs_files) <- ds_names
```

```{r}
nWorkers <- multicoreWorkers()
```

```{r read_sim_datasets}
## read input: the simulated dataset list
sim_ds_list <- lapply(simulated_datasets_qs_files, 
                      qread, 
                      nthreads = nWorkers)
```

# Data sets characteristics

## Source data sets

```{r}
## read unfiltered data
source_ds_dt <- 
    rbindlist(lapply(setNames(paste0("../data/", 
                                     ds_names, 
                                     "_unfiltered_CirComPara2_circbjr.csv"), 
                              ds_names),
                     function(x, min_samples = 0){
                         y <- fread(x, data.table = F)
                         m <- as.matrix(y[, -1])
                         rownames(m) <- y[, 1]
                         melt(as.data.table(m[rowSums(m > 0) >= min_samples, ], 
                                            keep.rownames = "circ_id"),
                              id.vars = "circ_id", variable.name = "sample_id")
                     }
    ), 
    idcol = "DS")

source_ds_meta <- 
    rbindlist(lapply(setNames(paste0("../data/", 
                                     ds_names, 
                                     "_meta.csv"), 
                              ds_names),
                     fread), 
              idcol = "DS", use.names = T)
```

### CircRNAs per number of samples

Exact number of samples in which a circRNA has been detected.  

```{r, fig.width=6, fig.height=5}
plot.dt <- 
    source_ds_dt[value > 0, 
                 .(n_samples = .N), 
                 by = .(DS, circ_id)][, .(n_circs = .N), 
                                      by = .(DS, n_samples)]

plot.dt[order(-n_samples), cum_circs := cumsum(n_circs), by = .(DS)]

library(ggthemes)
ggplot(plot.dt,
       aes(x = factor(n_samples),
           y = n_circs)) +
    geom_point(aes(color = DS)) +
    scale_color_tableau(direction = -1) +
    facet_wrap(~ DS, scales = "free", ncol = 1) +
    labs(y = "Number of circRNAs", x = "Number of samples") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

Minimum number of samples in which a circRNA has been detected.  

```{r, fig.width=6, fig.height=5}
ggplot(plot.dt,
       aes(x = factor(n_samples), 
           y = cum_circs)) +
    geom_point(aes(color = DS)) +
    scale_color_tableau(direction = -1) +
    facet_wrap(~ DS, scales = "free", ncol = 1) +
    labs(y = "Cumulative number of circRNAs", 
         x = "Cumulative number of samples") + # "(\u2265)"
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

### Mean expression per number of samples

```{r, fig.width=6.5, fig.height=8.8}
plot.dt <- 
    merge(source_ds_dt[value > 0, .(n_samples = .N), by = .(DS, circ_id)], 
          source_ds_dt[, .(mean_BJR = mean(value)), by = .(DS, circ_id)], 
          by = c("DS", "circ_id"))

# ggplot(plot.dt,
#        aes(y = factor(n_samples, levels = max(plot.dt$n_samples):1, ordered = T),
#            x = mean_BJR)) +
#     geom_boxplot(outlier.size = .5, #outlier.alpha = .5,
#                  varwidth = F, 
#                  notch = F) +
#     scale_x_log10(label = label_comma(accuracy = 1)) +
#     facet_wrap(~ DS, scales = "fixed", nrow = 1) +
#     labs(x = "Mean BJR", y = "Number of samples") +
#     theme_bw() +
#     theme(axis.text.x = element_text(angle = 90, 
#                                      hjust = 1, 
#                                      vjust = .5),
#           panel.grid.minor.y = element_blank(),
#           panel.grid.major.y = element_blank(),
#           panel.grid.minor.x = element_blank(),
#           panel.spacing = unit(.1, "lines"))
```

```{r, fig.height=8.5, fig.width=3}
library(patchwork)
library(ggthemes)

bjr_box_plot <-
    ggplot(plot.dt,
           aes(y = factor(n_samples, levels = max(plot.dt$n_samples):1, ordered = T),
               x = mean_BJR, 
               color = DS)) +
    geom_boxplot(outlier.size = .3, #outlier.alpha = .5,
                 outlier.shape = NA, # this removes the outliers
                 varwidth = F, 
                 notch = F, position = position_dodge2(preserve = "single")) +
    scale_x_log10(label = label_comma(accuracy = 1)) +
    scale_color_tableau(direction = -1) +
    # facet_wrap(~ DS, scales = "fixed", nrow = 1) +
    labs(x = "Mean BJR", y = "Number of samples") +
    theme_bw() +
    theme(legend.position = "none",
        axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust = .5),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.spacing = unit(.1, "lines"))

ncircs_plot <-
    ggplot(plot.dt[, .(n_circs = .N), by = .(DS, n_samples)],
           aes(x = factor(n_samples, levels = max(plot.dt$n_samples):1, ordered = T), 
               y = n_circs, 
               # fill = DS, 
               color = DS)) +
    # geom_col(position = position_dodge2(preserve = "single")) +
    geom_line(aes(group = DS)) +
    scale_color_tableau(name = "Dataset", direction = -1) +
    geom_point() +
    coord_flip() +
    scale_y_continuous("Number of\ncircRNAs") +
    # scale_y_sqrt("Number of\ncircRNAs") +
    # scale_y_log10("Number of\ncircRNAs") +
    theme_bw() +
    theme(legend.position = c(.65, .2),
          legend.background = element_blank(),
        axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust = .5),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank(), 
          panel.spacing = unit(.1, "lines"))

wrap_plots(bjr_box_plot +
               theme(plot.margin = margin(0, 0, 0, 0)), 
           ncircs_plot + 
               labs(x = NULL) +
               # guides(color = "none") +
               theme(axis.text.y = element_blank(),
                     axis.ticks.y = element_blank(), 
                     plot.background = element_blank(),
                     plot.margin = margin(0, 0, 0, 0)), 
           # guides = "collect", 
           nrow = 1, 
           widths = c(.6, .4)) &
    # scale_color_tableau(name = "Study", direction = -1) &
    theme(#legend.position = "top", 
          text = element_text(size = 10))
```

### Unfiltered data sets {.tabset}

#### BJR proportion 

```{r, fig.width=4, fig.height=3.5}
library(ggbeeswarm)

source_hist_cnt <- 
    source_ds_dt[, .(histBJR = .N), 
             by = .(DS, BJR = value)][, Frac := histBJR / sum(histBJR), 
                                  by = .(DS)][]
plot_dt <- source_hist_cnt[, .(AvgFrac = mean(Frac)),
                    by = .(DS, BJR)]

ds_stats <- 
    source_ds_dt[, .(nSamples = .N), 
                 by = .(DS, circ_id)][, .(nSamples = head(nSamples, 1),
                                          nCircs = .N), by = DS]

ch_p <- 
    ggplot(plot_dt, aes(x = BJR, y = AvgFrac)) + 
    geom_col(position = "identity", alpha = 1, aes(fill = DS)) +
    # facet_wrap(facets = ~ DS, ncol = 1, scales = "free_y") +
    facet_grid(rows = vars(DS)) +
    coord_cartesian(xlim = c(0, 15)) +
    geom_label(data = ds_stats, 
               size = 3,
               aes(x = 5, y = .5, 
                   label = paste("# samples:", nSamples, "\n# circRNAs:", comma(nCircs))), hjust = 0) +
    labs(x = "Backsplice-junction reads") +
    scale_y_continuous("Count matrix fraction (%)", 
                       labels = function(x)round(as.numeric(x)*100)) + #labels = percent
    scale_x_continuous(breaks = 0:15, 
                       labels = 0:15) +
    scale_fill_tableau(direction = -1) +
    theme_bw() +
    theme(legend.position = "none", 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), 
          plot.margin = unit(x = c(.1, .1, .1, .1), units = "lines"), 
          strip.text = element_blank(), 
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          strip.background = element_blank())

ls_bxp <- 
    ggplot(source_ds_dt[, .(LibSize = sum(value)), by = .(DS, sample_id)],
           aes(x = "", y = LibSize)) +
    geom_boxplot(varwidth = T,
                 notch = F,
                 outlier.size = .5,
                 aes(color = DS)) + #, outlier.shape = NA
    # geom_quasirandom(groupOnX = T, varwidth = T, alpha = .5, aes(fill = LibSize), shape = 21) +
    # geom_violin(aes(color = DS), 
    #             trim = T, 
    #             draw_quantiles = c(.25, .5, .75)) +
    # scale_fill_viridis_c() +
    scale_x_discrete(name = NULL) +
    scale_y_log10(labels = function(x)sub("000$", "K", x)) +
    scale_color_tableau(direction = -1) +
    labs(x = NULL, y = "Library size") +
    coord_flip() +
    # facet_wrap(facets = ~ DS, ncol = 1) + #, scales = "free_x"
    facet_grid(rows = vars(DS)) +
    theme_bw() +
    theme(legend.position = "none",
          axis.ticks.y = element_blank(), 
          panel.grid.major.y = element_blank(),
          plot.margin = unit(x = c(.1, .1, .1, .1), units = "lines"))

ch_p + ls_bxp +
    plot_layout(widths = c(3, 1))
```

#### Sparsity

Sparsity for each sample is calculated counting the circRNAs with zero count that have been detected in other samples of the same data set.  

```{r, fig.width=3.5, fig.height=2.5}
plot_dt <- 
    merge(merge(source_ds_dt[, .(Sparsity = sum(value == 0)/length(value)), 
                             by = .(DS, sample_id)],
                source_ds_dt[, .(LibSize = sum(value)), 
                             by = .(DS, sample_id)], 
                by = c("DS", "sample_id")),
          source_ds_dt[, .N, by = .(DS, circ_id)][, .(Features = .N), by = DS],
          by = "DS")

ggplot(plot_dt, 
       aes(x = LibSize, y = Sparsity * 100, color = DS)) +
    geom_point(alpha = .5, size = 2) +
    geom_smooth(method = "glm", 
                # group = 1, 
                # color = "black", 
                linetype = "dashed", 
                se = F) +
    # geom_label_repel(aes(label = DS), show.legend = F) +
    # annotate(geom = "label", x = 20000, y = 25, 
    #          label = paste0("P-value=", 
    #                        round(cortest$p.value, 2),
    #                        ", r=",
    #                        round(cortest$estimate, 2))) +
    # scale_x_log10() +
    scale_x_continuous("Library size (BJRs)", labels = comma) +
    scale_y_continuous("Sparsity (%)", limits = c(0, 100)) +
    scale_color_tableau(name = "Dataset", direction = -1) +
    # scale_size(name = "CircRNAs", breaks = sort(plot_dt$Features)) +
    guides(color = guide_legend(nrow = 1, 
                                title.position = "top", 
                                title.hjust = .5)) +
    theme_bw() +
    theme(legend.position = c(.5, .175), 
          legend.background = element_rect(colour = "grey55"),
          legend.margin = margin(t = .1, r = .2, b = .1, l = .2, unit = "lines"),
          panel.grid.minor = element_blank())
```

Below, sparsity is calculated counting the fraction of zeros in the data set matrix.  
Mean library size is the mean sum of BJRs in each sample of the data set.  

```{r, fig.width=4.5, fig.height=2.5}
plot_dt <- 
    merge(merge(source_ds_dt[, .(Sparsity = sum(value == 0)/length(value)), by = DS],
                source_ds_dt[, .(LibSize = sum(value)), 
                             by = .(DS, sample_id)][, .(`Mean library size` = mean(LibSize)), 
                                                    by = DS], 
                by = "DS"),
          source_ds_dt[, .N, by = .(DS, circ_id)][, .(Features = .N), by = DS],
          by = "DS")

cortest <- cor.test(x = plot_dt$`Mean library size`, y = plot_dt$Sparsity, method = "pearson")

# cortest$p.value
cortest$estimate

ggplot(plot_dt, 
       aes(x = `Mean library size`, y = Sparsity * 100, color = DS)) +
    geom_smooth(method = "glm", group = 1, color = "black", linetype = "dashed", se = T) +
    geom_point(aes(size = Features)) +
    geom_label_repel(aes(label = DS), show.legend = F) +
    annotate(geom = "label", x = 25000, y = 25, 
             label = paste0("P=", 
                           round(cortest$p.value, 2),
                           ", r=",
                           round(cortest$estimate, 2))) +
    # scale_x_log10() +
    scale_x_continuous(labels = comma) +
    scale_y_continuous("Sparsity (%)", limits = c(0, 100)) +
    scale_color_tableau(direction = -1) +
    scale_size(name = "CircRNAs", breaks = sort(plot_dt$Features)) +
    guides(color = "none") +
    theme_bw() +
    theme(legend.position = "right",
          panel.grid.minor = element_blank())
```

```{r}
datatable(plot_dt)
```

#### Within condition correlation of samples

Original data sets after sample selection and circRNA preliminary filters.  

```{r}
trimmed_source_dataset_files <- c(file.path("..", "semi_parametric_sim", 
                                    paste0(ds_names[ds_names != "MS"], "_sims"), 
                                    "trimmed_source_dataset.qs"), 
                            file.path("..", "semi_parametric_sim", 
                                    "trimmed_source_dataset.qs"))

names(trimmed_source_dataset_files) <- c(ds_names[ds_names != "MS"], "MS")
# trimmed_source_dataset_files

trimmed_source_dataset_l <- lapply(trimmed_source_dataset_files, qread)

within_cond_corr <- function(ds, cor.meth = "pearson"){
    
    g1 <- rownames(ds$samples)[as.integer(ds$samples$group) == 1]
    g2 <- rownames(ds$samples)[as.integer(ds$samples$group) == 2]
    
    cor_g1 <- cor(x = ds$counts[, g1], method = cor.meth)
    cor_g2 <- cor(x = ds$counts[, g2], method = cor.meth)
    
    c(G1_cor = mean(cor_g1[upper.tri(cor_g1)]),
      G2_cor = mean(cor_g2[upper.tri(cor_g2)]))
}

data.frame(lapply(trimmed_source_dataset_l, within_cond_corr, cor.meth = "pearson"))
```

### 3 samples filter {.tabset}

Data sets after filtering according to circRNAs detected in 3 or more samples.  

#### 3S filter BJR proportion 

```{r, fig.width=4, fig.height=3.5}
circ_id3s <- source_ds_dt[value > 0, .N, by = .(DS, circ_id)][N > 2, circ_id]

source_hist_cnt <- 
    source_ds_dt[circ_id %in% circ_id3s, 
                 .(histBJR = .N), 
             by = .(DS, BJR = value)][, Frac := histBJR / sum(histBJR), 
                                  by = .(DS)][]
plot_dt <- source_hist_cnt[, .(AvgFrac = mean(Frac)),
                    by = .(DS, BJR)]

ds_stats <- 
    source_ds_dt[circ_id %in% circ_id3s, 
                 .(nSamples = .N), 
                 by = .(DS, circ_id)][, .(nSamples = head(nSamples, 1),
                                          nCircs = .N), by = DS]

ch_p <- 
    ggplot(plot_dt, aes(x = BJR, y = AvgFrac)) + 
    geom_col(position = "identity", alpha = 1, aes(fill = DS)) +
    # facet_wrap(facets = ~ DS, ncol = 1, scales = "free_y") +
    facet_grid(rows = vars(DS)) +
    coord_cartesian(xlim = c(0, 15)) +
    geom_label(data = ds_stats, 
               size = 3,
               aes(x = 5, y = .5, 
                   label = paste("# samples:", nSamples, "\n# circRNAs:", comma(nCircs))), hjust = 0) +
    labs(x = "Backsplice-junction reads") +
    scale_y_continuous("Count matrix fraction (%)", 
                       labels = function(x)round(as.numeric(x)*100)) + #labels = percent
    scale_x_continuous(breaks = 0:15, 
                       labels = 0:15) +
    scale_fill_tableau(direction = -1) +
    theme_bw() +
    theme(legend.position = "none", 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), 
          plot.margin = unit(x = c(.1, .1, .1, .1), units = "lines"), 
          strip.text = element_blank(), 
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          strip.background = element_blank())

ls_bxp <- 
    ggplot(source_ds_dt[, .(LibSize = sum(value)), by = .(DS, sample_id)],
           aes(x = "", y = LibSize)) +
    geom_boxplot(varwidth = T,
                 notch = F,
                 outlier.size = .5,
                 aes(color = DS)) + #, outlier.shape = NA
    # geom_quasirandom(groupOnX = T, varwidth = T, alpha = .5, aes(fill = LibSize), shape = 21) +
    # geom_violin(aes(color = DS), 
    #             trim = T, 
    #             draw_quantiles = c(.25, .5, .75)) +
    # scale_fill_viridis_c() +
    scale_x_discrete(name = NULL) +
    scale_y_log10(labels = function(x)sub("000$", "K", x)) +
    scale_color_tableau(direction = -1) +
    labs(x = NULL, y = "Library size") +
    coord_flip() +
    # facet_wrap(facets = ~ DS, ncol = 1) + #, scales = "free_x"
    facet_grid(rows = vars(DS)) +
    theme_bw() +
    theme(legend.position = "none",
          axis.ticks.y = element_blank(), 
          panel.grid.major.y = element_blank(),
          plot.margin = unit(x = c(.1, .1, .1, .1), units = "lines"))

ch_p + ls_bxp +
    plot_layout(widths = c(3, 1))
```

#### Sparsity

Data sets after filtering according to circRNAs detected in 3 or more samples.  

```{r, fig.width=4.5, fig.height=2.5}
plot_dt <- 
    merge(merge(source_ds_dt[circ_id %in% circ_id3s,
                             .(Sparsity = sum(value == 0)/length(value)), by = DS],
                source_ds_dt[circ_id %in% circ_id3s, 
                             .(LibSize = sum(value)), 
                             by = .(DS, sample_id)][, .(`Mean library size` = mean(LibSize)), 
                                                    by = DS], 
                by = "DS"),
          source_ds_dt[circ_id %in% circ_id3s, 
                       .N, by = .(DS, circ_id)][, .(Features = .N), by = DS],
          by = "DS")

cortest <- cor.test(x = plot_dt$`Mean library size`, y = plot_dt$Sparsity, method = "pearson")

# cortest$p.value
cortest$estimate

ggplot(plot_dt, 
       aes(x = `Mean library size`, y = Sparsity * 100, color = DS)) +
    geom_smooth(method = "glm", group = 1, color = "black", linetype = "dashed", se = T) +
    geom_point(aes(size = Features)) +
    geom_label_repel(aes(label = DS), show.legend = F) +
    annotate(geom = "label", x = 25000, y = 25, 
             label = paste0("P=", 
                           round(cortest$p.value, 2),
                           ", r=",
                           round(cortest$estimate, 2))) +
    # scale_x_log10() +
    scale_x_continuous(labels = comma) +
    scale_y_continuous("Sparsity (%)", limits = c(0, 100)) +
    scale_color_tableau(direction = -1) +
    scale_size(name = "CircRNAs", breaks = sort(plot_dt$Features)) +
    guides(color = "none") +
    theme_bw() +
    theme(legend.position = "right",
          panel.grid.minor = element_blank())
```

```{r}
datatable(plot_dt)
```

### PCAs

```{r}
# x <- source_ds_dt[circ_id %in% circ_id3s]
# y <- source_ds_meta
# dsname <- "DM1"

plot_pca <- function(dsname, x, y){
    counts <- as.matrix(data.frame(dcast(data = x[DS == dsname], 
                                         formula = circ_id ~ sample_id, 
                                         value.var = "value"), 
                                   row.names = "circ_id"))
    
    sampleTable <- data.frame(y[DS == dsname, .(sample_id, Group = condition)], 
                              row.names = "sample_id")
    
    
    dge <- edgeR::DGEList(counts = counts[, rownames(sampleTable)], group = sampleTable$Group)
    dge <- edgeR::calcNormFactors(dge, method = "TMM")
    cpms <- edgeR::cpm(dge, log = T, prior.count = 1)
    
    pcs <- prcomp(x = t(cpms), scale. = F, center = T)
    var.props <- summary(pcs)$importance[2, ]
    df <- cbind(sampleTable, pcs$x)
    
    ggplot2::ggplot(df, aes(x = PC1, y = PC2, color = Group)) +
        geom_point() +
        labs(x = paste("PC1:", percent(var.props[1])),
             y = paste("PC2:", percent(var.props[2]))) +
        theme_bw()
}
```

```{r}
# source_ds_meta[, .N, by = .(condition)]
source_ds_meta[grepl("normal|control", condition, ignore.case = T), condition := "Normal"]
```

#### DM1

```{r, fig.width=4.5, fig.height=3.5}
plot_pca(dsname = "DM1", x = source_ds_dt[circ_id %in% circ_id3s], y = source_ds_meta) +
    coord_fixed(ratio = 1) +
    theme(legend.position = "top")
```

#### IDC

```{r, fig.width=4.5, fig.height=4.5}
plot_pca(dsname = "IDC", x = source_ds_dt[circ_id %in% circ_id3s], y = source_ds_meta) +
    coord_fixed(ratio = 1) +
    theme(legend.position = "top")
```

#### IPF

```{r, fig.width=4.5, fig.height=4.5}
plot_pca(dsname = "IPF", x = source_ds_dt[circ_id %in% circ_id3s], y = source_ds_meta) +
    coord_fixed(ratio = 1) +
    theme(legend.position = "top")
```

#### MS

```{r, fig.width=4.5, fig.height=4.5}
plot_pca(dsname = "MS", x = source_ds_dt[circ_id %in% circ_id3s], y = source_ds_meta) +
    coord_fixed(ratio = 1) +
    theme(legend.position = "top")
```

### PC data set

```{r}
counts_dt <- fread("../data/PMID35078526_rawCIRI2output.tsv",
                   data.table = T,
                   showProgress = F,
                   drop = c("chr", "start", "end", "strand", "gene_id", "circRNA_type"))

## filter the original dataset
counts_dt_m <- melt(counts_dt,
                    id.vars = "circRNA_ID",
                    variable.name = "sample_id",
                    value.name = "BJR")
counts_dt_m[, c("ID", "Group") := tstrsplit(sample_id, "_"), by = sample_id]

## keep only circRNAs expressed in > 2 samples per condition
keep <- counts_dt_m[BJR > 0, .N,
                    by = .(circRNA_ID, Group)][N > 2 &
                                                   Group != "MPC", unique(circRNA_ID)]

## read sample groups
sampleTable <- data.frame(unique(counts_dt_m[Group != "MPC",
                                             .(sample_id, Group)][order(Group, sample_id)]),
                          row.names = "sample_id")

counts <-
    as.matrix(data.frame(counts_dt, check.names = F,
                         row.names = "circRNA_ID"))[keep, rownames(sampleTable)]
# dim(counts)

## check possible biases
library(edgeR)
dge <- DGEList(counts = counts[, rownames(sampleTable)], group = sampleTable$Group)
dge <- calcNormFactors(dge, method = "TMM")
cpms <- cpm(dge, log = T, prior.count = 1)

pcs <- prcomp(x = t(cpms), scale. = F, center = T)
var.props <- summary(pcs)$importance[2, ]
df <- cbind(sampleTable, pcs$x)
```


```{r, fig.width=4.5, fig.height=3.5}
library(ggplot2)
ggplot2::ggplot(df, aes(x = PC1, y = PC2, color = Group)) +
    geom_point(alpha = .7) +
    scale_color_discrete(labels = c("Normal", "Prostate Cancer"), direction = -1) +
    geom_rect(aes(xmin = -40, xmax = 50, ymin = -30, ymax = 0), 
              fill = NA, 
              color = "red") + 
    annotate(geom = "text", x = 25, y = -5, label = "Batch 2", color = "red") +
    labs(x = paste("PC1:", percent(var.props[1])),
         y = paste("PC2:", percent(var.props[2]))) +
    theme_bw() +
    coord_fixed(ratio = 1) +
    theme(legend.position = "top")
```


```{r}
df$Batch <- ifelse(df$PC2 > 0, "B1", "B2")
sampleTable$Batch <- df[rownames(sampleTable), "Batch"]
## get batch-group sample sizes
table(sampleTable[, c("Batch", "Group")])
```


```{r}
## keep only samples from the largest batch
st <- sampleTable[sampleTable$Batch == "B2", "Group", drop = F]
ct <- counts[, rownames(st)]
ct <- ct[rowSums(ct > 0) > 2, ]
dim(ct)

dge.b2 <- DGEList(counts = ct, group = st$Group)
dge.b2 <- calcNormFactors(dge.b2, method = "TMM")
cpms.b2 <- cpm(dge.b2, log = T, prior.count = 1)

pcs.b2 <- prcomp(x = t(cpms.b2), scale. = F, center = T)
var.props.b2 <- summary(pcs.b2)$importance[2, ]
df.b2 <- cbind(st, pcs.b2$x)
```


```{r, fig.width=4.5, fig.height=3.5}
ggplot2::ggplot(df.b2, aes(x = PC1, y = PC2, color = Group)) +
        geom_point() +
        labs(x = paste("PC1:", percent(var.props.b2[1])),
             y = paste("PC2:", percent(var.props.b2[2]))) + 
    scale_color_discrete(labels = c("Normal", "Prostate Cancer"), direction = -1) +
    ggtitle("Batch 2") +
    theme_bw() +
    coord_fixed(ratio = 1) +
    theme(legend.position = "top", plot.title = element_text(hjust = .5))
```

```{r}
cor_g1 <- cor(ct[, rownames(st)[st$Group == "AN"]])
cor_g2 <- cor(ct[, rownames(st)[st$Group == "T"]])

paste("AN Pearson mean cor =", mean(cor_g1))
paste("T Pearson mean cor =", mean(cor_g2))
```

```{r}
datatable(data.table(st, keep.rownames = "Sample"), 
          filter = "top", rownames = F,
          caption = "Batch 2 samples")
```

#### BJR

TODO
```{r}
# as.data.table(ct)
```


## Simulated data sets {.tabset}

```{r, warning=FALSE}
melt_cnt <- rbindlist(lapply(sim_ds_list, 
                        function(sims) {
                            rbindlist(lapply(sims, 
                                             function(x) {
                                                 melt(as.data.table(x$cntdat))
                                             }), 
                                      use.names = T, idcol = "dataset")
                        }), idcol = "DS")

melt_cnt[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(dataset, "_", type.convert = F), 
          by = dataset]
melt_cnt <- melt_cnt[MZP == "bulk"]
```

```{r}
n_sim_circs <- 
  unique(melt_cnt[, .N, 
                  by = .(DS, Purpose, SetSize, ID, 
                         variable)][, .(DS, Purpose, SetSize, ID, N)])
n_sim_circs[Purpose == "de", Purpose := "Signal"]
n_sim_circs[Purpose == "mock", Purpose := "Null"]

n_sim_circs$DS <- factor(n_sim_circs$DS)
n_sim_circs$Purpose <- factor(n_sim_circs$Purpose)
n_sim_circs$SetSize <- factor(n_sim_circs$SetSize)
```

### Table

```{r}
datatable(n_sim_circs, caption = "Number of simulated circRNAs per data set", filter = "top")
```

`r mean(n_sim_circs$N)` = mean number of simulated circRNAs.   
`r sd(n_sim_circs$N)` = standard deviation number of simulated circRNAs.   

```{r}
n_sim_circs[, .(Median = median(N)), by = .(DS)]
```


### Full facets

```{r, fig.width=3, fig.height=4.5}
ggplot(n_sim_circs, 
       aes(x = SetSize, y = N, color = DS)) +
    geom_boxplot(outlier.shape = NA) +
    # geom_beeswarm(dodge.width = 1, groupOnX = T, cex = 2.5) +
    geom_quasirandom(method = "quasirandom", size = .5) +
    labs(y = "Simulated circRNAs", x = "Set size") +
    facet_grid(rows = vars(DS), cols = vars(Purpose), scales = "free_y") +
    scale_color_tableau(direction = -1, guide = "none") +
    theme_bw() +
    theme(panel.grid.major.x = element_blank())
```

### Data set facets

```{r, fig.width=3, fig.height=4.5}
ggplot(n_sim_circs, 
       aes(x = SetSize, y = N, color = Purpose)) +
    geom_boxplot(outlier.shape = NA) +
    # geom_beeswarm(dodge.width = 1, groupOnX = T, cex = 2.5) +
    geom_quasirandom(size = .5, dodge.width = .7, alpha = .5) +
    labs(y = "Simulated circRNAs", x = "Set size") +
    facet_grid(rows = vars(DS), 
               # cols = vars(Purpose), 
               scales = "free_y") +
    scale_color_canva(palette = "Neon and bold") +
    theme_bw() +
    theme(panel.grid.major.x = element_blank(), legend.position = "top")
```

### Purpose facets

```{r, fig.width=3, fig.height=2.5}
ggplot(n_sim_circs, 
       aes(x = SetSize, y = N, color = DS)) +
    geom_boxplot(outlier.shape = NA, position = "dodge") +
    # geom_beeswarm(dodge.width = 1, groupOnX = T, cex = 2.5) +
    # geom_quasirandom(method = "quasirandom", size = .5, position = "dodge") +
    labs(y = "Simulated circRNAs", x = "Set size") +
    facet_grid(cols = vars(Purpose), 
               # rows = vars(DS), 
               scales = "free_y") +
    scale_color_tableau(direction = -1) +
    theme_bw() +
    theme(panel.grid.major.x = element_blank(), legend.position = "top")
```

### Set size facets

```{r, fig.width=3, fig.height=2.5}
ggplot(n_sim_circs, 
       aes(x = DS, y = N, color = Purpose)) +
    geom_boxplot(outlier.shape = NA, position = "dodge") +
    # geom_beeswarm(dodge.width = 1, groupOnX = T, cex = 2.5) +
    # geom_quasirandom(method = "quasirandom", size = .5, position = "dodge") +
    labs(y = "Simulated circRNAs", x = "Set size") +
    facet_grid(cols = vars(SetSize), 
               # rows = vars(DS), 
               scales = "free") +
    scale_color_tableau(direction = -1) +
    theme_bw() +
    theme(panel.grid.major.x = element_blank(), legend.position = "top")
```

# Are matrix zero-inflated?

## Source data sets

```{r}
library(NBID)
meta_files <- setNames(paste0("../data/", 
                                     ds_names, 
                                     "_meta.csv"), 
                              ds_names)

source_ds_mt <- 
    lapply(setNames(paste0("../data/", 
                                     ds_names, 
                                     "_unfiltered_CirComPara2_circbjr.csv"), 
                              ds_names),
                     function(x){
                         y <- fread(x, data.table = F)
                         m <- as.matrix(y[, -1])
                         rownames(m) <- y[, 1]
                         m[rowSums(m > 0) >= 3, ]
                     }
    )


meta_dts <- lapply(meta_files, fread)

fitResult_l <-
    lapply(setNames(ds_names, ds_names), 
           function(x) {
               
               NBID::checkDataDistribution(data = source_ds_mt[[x]][, meta_dts[[x]][["sample_id"]]], 
                                           groups = meta_dts[[x]][["condition"]], 
                                           ncore = multicoreWorkers())
           })

ds_aic <-
    rbindlist(lapply(setNames(ds_names, ds_names), 
                     function(x) {
                         
                         # fitResult <- NBID::checkDataDistribution(data = source_ds_mt[[x]][, meta_dts[[x]][["sample_id"]]], 
                         #                                          groups = meta_dts[[x]][["condition"]], 
                         #                                          ncore = multicoreWorkers())
                         # 
                         # dcast(melt(data.table(fitResult[, c("geneNames", 
                         #                                     grep("modelByAIC", 
                         #                                          colnames(fitResult), value = T))]), 
                         #            id.vars = "geneNames")[, .N, by = .(variable, value)], 
                         #       variable ~ value, 
                         #       value.var = "N")
                         dcast(melt(data.table(fitResult_l[[x]][, c("geneNames", 
                                                                    grep("modelByAIC", 
                                                                         colnames(fitResult_l[[x]]), value = T))]), 
                                    id.vars = "geneNames")[, .N, by = .(variable, value)], 
                               variable ~ value, 
                               value.var = "N")
                     }), 
              idcol = "DS")


# nbid_result <- data.frame(DEUsingNBID(source_ds_mt[[x]][, meta_dts[[x]][["sample_id"]]], 
#                      meta_dts[[x]][["condition"]], 
#                      ncore = multicoreWorkers()))
# 
# nbid_result$FDR <- p.adjust(nbid_result$pvalue, "BH")
# sum(nbid_result$FDR <= .1)

```

```{r}
datatable(ds_aic, rownames = F)
```

```{r}
plot_dt <- melt(ds_aic, id.vars = c("DS", "variable"), variable.name = "Model", value.name = "CircRNAs")

ggplot(plot_dt, aes(x = gsub("_| ", "\n", variable), 
                    y = CircRNAs, fill = Model)) +
    geom_col(position = position_dodge()) +
    facet_wrap(~ DS, drop = T, scales = "free") +
    scale_x_discrete("Condition") +
    theme_bw() +
    theme(legend.position = "top")
```

```{r}
# summaryResult = summaryComparison(fitResult)
# print(summaryResult$modelCount)
fitres_dt <- rbindlist(lapply(fitResult_l, 
                              function(x) data.table(summaryComparison(x)$modelCount)), 
                       idcol = "DS")

```

```{r}
datatable(fitres_dt, rownames = F)
```

## Simulated data sets


```{r}
hist_cnt <- 
    melt_cnt[, .(histBJR = .N), 
             by = .(DS, dataset, SetSize, MZP, Purpose, ID, 
                    BJR = value)][, Frac := histBJR / sum(histBJR), 
                                  by = .(DS, dataset, SetSize, MZP, Purpose, ID)][]
plot_dt <- hist_cnt[, .(AvgFrac = mean(Frac),
                        sdFrac = sd(Frac)),
                    by = .(DS, SetSize, MZP, BJR)] #, Purpose

# plot_dt[is.na(sdFrac), sdFrac := 0]

ggplot(plot_dt, aes(x = BJR, y = AvgFrac)) + #, color = Purpose, fill = Purpose
    geom_errorbar(aes(ymin = AvgFrac - sdFrac, ymax = AvgFrac + sdFrac), width = .6) +
    geom_col(position = "identity", alpha = .5) +
    facet_grid(cols = vars(SetSize), rows = vars(DS), scales = "free") +
    coord_cartesian(xlim = c(0, 15)) +
    scale_y_continuous("Count matrix fraction (%)", 
                       labels = function(x)round(as.numeric(x)*100)) + #labels = percent
    scale_x_continuous(breaks = 0:15, 
                       labels = 0:15) +
    theme_classic() +
    theme(legend.position = "top", 
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```



```{r}
sim_ds_dt <- rbindlist(lapply(sim_ds_list, 
                        function(sims) {
                            rbindlist(lapply(sims, 
                                             function(x) {
                                                 data.frame(circ_id = rownames(x$cntdat), 
                                                            AvgBJR = rowMeans(x$cntdat),
                                                            FracZeros = rowSums(x$cntdat == 0) / ncol(x$cntdat),
                                                            is.DEC = x$status)
                                             }), 
                                      use.names = T, idcol = "dataset")
                        }), idcol = "DS")

sim_ds_dt[, c("SetSize", "MZP", "Purpose", "ID") := tstrsplit(dataset, "_", type.convert = F), 
          by = dataset]
sim_ds_dt <- sim_ds_dt[MZP == "bulk"]
```

# DE simulated data sets 

## Raw expression {.tabset}

### Density multi lines

```{r, fig.width=5.5, fig.height=4}
p <- ggplot(data = sim_ds_dt[Purpose == "de"],
            mapping = aes(x = AvgBJR, color = factor(is.DEC))) +
    geom_density(aes(group = paste(dataset, is.DEC))) +
    scale_x_log10() +
    # facet_wrap(DS ~ SetSize, 
    #            # scales = "free_y", 
    #            ncol = 3, 
    #            labeller = label_wrap_gen(multi_line = F)) +
    facet_grid(rows = vars(DS),
               cols = vars(SetSize), 
               scales = "free_y",
               labeller = label_wrap_gen(multi_line = F)) +
    scale_color_discrete("DEC") +
    labs(y = "Density") +
    theme_bw() +
    theme(legend.position = "top", 
          panel.grid.minor = element_blank(), 
          panel.spacing = unit(.2, "lines"))
p
```

### Density sahdes ggplot2 stats

```{r, fig.width=5.5, fig.height=4}
ld <- as.data.table(layer_data(p))

ld.densities.qtiles <-
    ld[, as.list(c(quantile(y, probs = c(.025, .5, .975)), 
                          Mean = mean(y))), 
       by = .(colour, PANEL, x)]
ld.densities.qtiles[, DEC := ifelse(colour == "#F8766D", F, T)]

ld.densities.qtiles <-
    merge(ld.densities.qtiles, 
          sim_ds_dt[, .N, by = .(DS, SetSize)][, .(PANEL = factor(.I), DS = paste(DS, SetSize))],
          by = "PANEL")


ggplot(ld.densities.qtiles, 
       aes(x = x, y = `50%`)) + #Mean
    # facet_wrap(~ DS, 
    #            # scales = "free", 
    #            ncol = 3) +
    facet_grid(rows = vars(gsub(" N[0-9]{2}", "", DS)),
               cols = vars(gsub(".*(N[0-9]{2})$", "\\1", DS)), 
               scales = "free_y",
               labeller = label_wrap_gen(multi_line = F)) +
    # geom_histogram(data = sim_ds_dt[Purpose == "de"],
    #                aes(x = AvgBJR, y = ..density..), 
    #                fill = "white",
    #                binwidth = 0.25, boundary = 0) +
    geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`, 
                    fill = DEC), 
                alpha = 0.5) +
    geom_line(aes(color = DEC)) +
    scale_color_discrete("DEC") +
    scale_fill_discrete("DEC") +
    labs(y = "Density", x = expression(Log[10](AvgBJR))) +
    theme_bw() +
    theme(legend.position = "top", 
          panel.grid.minor = element_blank(), 
          panel.spacing = unit(.2, "lines"))
```

### Density sahdes custom stats

```{r, fig.width=5.5, fig.height=4}
#https://stackoverflow.com/questions/45908120/add-shaded-standard-error-curves-to-geom-density-in-ggplot2
plot_dt <- copy(sim_ds_dt)[, AvgBJR := log10(AvgBJR + .01)][Purpose == "de"]

plot_dt[, `:=` (maxBJR = max(AvgBJR, na.rm = T),
                  minBJR = min(AvgBJR, na.rm = T),
                  len = length(AvgBJR)),
          by = .(MZP, Purpose)] #, DS, SetSize

densities <- 
    plot_dt[, data.frame(broom::tidy(stats::density(x = AvgBJR, 
                                                    # weights = rep(1 / length(AvgBJR), length(AvgBJR)),
                                                    from = min(minBJR, na.rm = T), 
                                                    to = max(maxBJR, na.rm = T),
                                                    bw = "nrd0", #"SJ"
                                                    adjust = 1,
                                                    kernel = "gaussian",
                                                    n = 512,
                                                    na.rm = TRUE))),
              by = .(DS, SetSize, Purpose, ID, DEC = ifelse(is.DEC == 1, T, F))]

densities.qtiles <-
    densities[, as.list(c(quantile(y, probs = c(.025, .5, .975)), 
                          Mean = mean(y))),
              by = .(DS, SetSize, DEC, AvgBJR = x)]

ggplot(densities.qtiles, 
       aes(x = AvgBJR, y = Mean)) + #`50%`
    # facet_wrap(DS ~ SetSize, 
    #            # scales = "free",
    #            ncol = 3, 
    #            labeller = label_wrap_gen(multi_line = F)) +
    facet_grid(rows = vars(DS),
               cols = vars(SetSize), 
               scales = "free_y",
               labeller = label_wrap_gen(multi_line = F)) +
    # geom_histogram(data = sim_ds_dt[Purpose == "de"],
    #                aes(x = AvgBJR, y = ..density..), 
    #                fill = "white",
    #                binwidth = 0.25, boundary = 0) +
    geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`, 
                    fill = DEC), 
                alpha = 0.5) +
    # stat_density(data = sim_ds_dt[Purpose == "de"],
    #              aes(AvgBJR, ..density.., color = "raw density"),
    #              size = 2, geom = "line") +
    geom_line(aes(color = DEC)) +
    scale_color_discrete("DEC") +
    scale_fill_discrete("DEC") +
    labs(y = "Density", x = expression(Log[10](AvgBJR + 0.01))) +
    theme_bw() +
    theme(legend.position = "top", 
          panel.grid.minor = element_blank(), 
          panel.spacing = unit(.2, "lines"))
```

## DEC Fraction of zeros density

```{r}
ggplot(sim_ds_dt, aes(x = FracZeros, color = ifelse(is.DEC == 1, T, F))) +
    # geom_density(aes(group = paste(dataset, is.DEC)), alpha = .3) +
    geom_histogram(aes(y = ..ndensity.., 
                       fill = ifelse(is.DEC == 1, T, F)),
                   position = "identity",
                   alpha = .5, binwidth = .1) +
    scale_color_discrete("DEC") +
    scale_fill_discrete("DEC") +
    facet_grid(cols = vars(SetSize), rows = vars(DS)) + 
    theme_bw() +
    theme(legend.position = "top", 
          axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
# plot_dt <- copy(sim_ds_dt)[Purpose == "de"]
# 
# # plot_dt[, `:=` (maxFZ = max(FracZeros, na.rm = T),
# #                   minFZ = min(FracZeros, na.rm = T),
# #                   len = length(FracZeros)),
# #           by = .(MZP, Purpose)] #, DS, SetSize
# 
# fz_densities <- 
#     plot_dt[, data.frame(broom::tidy(stats::density(x = FracZeros, 
#                                                     # weights = rep(1 / length(AvgBJR), length(AvgBJR)),
#                                                     from = 0, 
#                                                     to = 1,
#                                                     bw = .1, #"nrd0", #"SJ"
#                                                     adjust = 1,
#                                                     kernel = "gaussian",
#                                                     n = 512,
#                                                     na.rm = TRUE))),
#               by = .(DS, SetSize, Purpose, ID, DEC = ifelse(is.DEC == 1, T, F))]
# 
# fz_densities.qtiles <-
#     fz_densities[, as.list(c(quantile(y, probs = c(.025, .5, .975)), 
#                           Mean = mean(y))),
#               by = .(DS, SetSize, DEC, FracZeros = x)]
# 
# ggplot(fz_densities.qtiles, 
#        aes(x = FracZeros, y = Mean, fill = DEC)) + #`50%`
#     facet_wrap(DS ~ SetSize, 
#                # scales = "free",
#                ncol = 3, 
#                labeller = label_wrap_gen(multi_line = F)) +
#     geom_histogram(data = sim_ds_dt[Purpose == "de"][, DEC := ifelse(is.DEC == 1, T, F)],
#                    aes(x = FracZeros, y = ..ndensity..),
#                    # fill = "white",
#                    binwidth = 0.1, alpha = .5) + #boundary = 0,
#     # geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), 
#     #             alpha = 0.5) +
#     # geom_line(aes(color = DEC)) +
#     scale_color_discrete("DEC") +
#     scale_fill_discrete("DEC") +
#     labs(y = "density", x = "Zero faction") +
#     theme_bw() +
#     theme(legend.position = "top")
```

## Raw expression vs fraction of zeros

```{r}
# library(ggrastr)
# plot_dt <- sim_ds_dt[][, DEC := ifelse(is.DEC == 1, T, F)]
# ggplot(plot_dt, aes(x = AvgBJR, y = FracZeros, color = DEC)) +
#     # geom_point_rast() +
#     # geom_density_2d() +
#     geom_smooth() +
#     scale_x_log10() +
#     facet_grid(cols = vars(SetSize), rows = vars(DS)) + 
#     theme_bw() +
#     theme(legend.position = "top", 
#           axis.text.x = element_text(angle = 30, hjust = 1))
```

## CircRNA counts

```{r}
ncircs <- sim_ds_dt[Purpose == "de", .N, 
                 by = .(DS, SetSize, ID, 
                        DEC = ifelse(is.DEC == 1, T, F))]

ggplot(ncircs,
       aes(x = SetSize, y = N, color = DEC)) +
    geom_boxplot() +
    scale_y_log10("Simulated circRNAs") +
    facet_wrap(~ DS, 
               # scales = "free_y", 
               dir = "v") +
    theme_bw() +
    theme(legend.position = "top")
```

```{r}
datatable(dcast(ncircs, DS + SetSize + ID ~ DEC)[, Tot := `FALSE` + `TRUE`][], 
          rownames = F, filter = "top")
```

```{r}
datatable(ncircs[, as.list(summary(N)), by = .(DS, SetSize)], 
          rownames = F, filter = "top")
```

```{r}
datatable(ncircs[, as.list(summary(N)), by = .(DS, SetSize, DEC)], 
          rownames = F, filter = "top")
```

# Mock 

```{r}
ncircs <- sim_ds_dt[Purpose == "mock", .N, 
                 by = .(DS, SetSize, ID)]

ggplot(ncircs,
       aes(x = SetSize, y = N)) +
    geom_boxplot() +
    scale_y_log10("Simulated circRNAs") +
    facet_wrap(~ DS, 
               # scales = "free_y", 
               dir = "v") +
    theme_bw() +
    theme(legend.position = "top")
```

```{r}
datatable(ncircs[, as.list(summary(N)), by = .(DS, SetSize)], 
          rownames = F, filter = "top")
```

# Session info

```{r}
sessionInfo()
```

